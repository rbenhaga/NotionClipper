fedc83c9fb7f9e56051a1c5448367402
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TableParser = void 0;
const BaseParser_1 = require("./BaseParser");
const ContentSanitizer_1 = require("../security/ContentSanitizer");
class TableParser extends BaseParser_1.BaseParser {
    constructor(options = {}) {
        super(options);
    }
    parse(content) {
        if (!content?.trim())
            return [];
        const contentType = this.options.contentType;
        switch (contentType) {
            case 'csv':
                return this.parseCsv(content);
            case 'tsv':
                return this.parseTsv(content);
            case 'table':
            default:
                return this.parseMarkdownTable(content);
        }
    }
    parseCsv(content) {
        return this.parseDelimitedTable(content, ',');
    }
    parseTsv(content) {
        return this.parseDelimitedTable(content, '\t');
    }
    parseDelimitedTable(content, delimiter) {
        const lines = content.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            // Not enough data for a table, return as text
            return [this.createTextNode(content)];
        }
        // Parse CSV/TSV with proper quote handling
        const rows = lines.map(line => this.parseDelimitedLine(line, delimiter));
        // Detect headers
        const hasColumnHeader = this.detectColumnHeaders(rows);
        const hasRowHeader = this.detectRowHeaders(rows);
        // Use first row as headers if detected
        const headers = hasColumnHeader ? rows[0] : [];
        const dataRows = hasColumnHeader ? rows.slice(1) : rows;
        // Normalize row lengths
        const maxColumns = Math.max(headers.length, ...dataRows.map(row => row.length));
        const normalizedHeaders = hasColumnHeader ? this.normalizeRow(headers, maxColumns) : [];
        const normalizedRows = dataRows.map(row => this.normalizeRow(row, maxColumns));
        return [this.createTableNode(normalizedHeaders, normalizedRows, {
                hasColumnHeader,
                hasRowHeader
            })];
    }
    parseDelimitedLine(line, delimiter) {
        const result = [];
        let current = '';
        let inQuotes = false;
        let i = 0;
        while (i < line.length) {
            const char = line[i];
            const nextChar = line[i + 1];
            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    // Escaped quote
                    current += '"';
                    i += 2;
                }
                else {
                    // Toggle quote state
                    inQuotes = !inQuotes;
                    i++;
                }
            }
            else if (char === delimiter && !inQuotes) {
                // Field separator
                result.push(current.trim());
                current = '';
                i++;
            }
            else {
                current += char;
                i++;
            }
        }
        // Add the last field
        result.push(current.trim());
        return result;
    }
    parseMarkdownTable(content) {
        const lines = content.split('\n').filter(line => line.trim());
        // Find table lines (containing |)
        const tableLines = lines.filter(line => line.includes('|'));
        if (tableLines.length < 2) {
            return [this.createTextNode(content)];
        }
        // Parse headers
        const headerLine = tableLines[0];
        const headers = this.parseMarkdownTableRow(headerLine);
        // Check for separator line (indicates headers)
        let dataStartIndex = 1;
        let hasColumnHeader = false;
        if (tableLines.length > 1 && this.isMarkdownSeparatorLine(tableLines[1])) {
            dataStartIndex = 2;
            hasColumnHeader = true;
        }
        // Parse data rows
        const dataRows = tableLines.slice(dataStartIndex)
            .map(line => this.parseMarkdownTableRow(line))
            .map(row => this.normalizeRow(row, headers.length));
        // Detect row headers
        const hasRowHeader = this.detectRowHeaders([headers, ...dataRows]);
        return [this.createTableNode(headers, dataRows, {
                hasColumnHeader,
                hasRowHeader
            })];
    }
    parseMarkdownTableRow(line) {
        // Remove leading/trailing pipes and split
        const trimmed = line.trim();
        const withoutOuterPipes = trimmed.startsWith('|') ? trimmed.slice(1) : trimmed;
        const withoutTrailingPipe = withoutOuterPipes.endsWith('|')
            ? withoutOuterPipes.slice(0, -1)
            : withoutOuterPipes;
        return withoutTrailingPipe
            .split('|')
            .map(cell => ContentSanitizer_1.ContentSanitizer.sanitizeTableCell(cell.trim()))
            .filter((cell, index, array) => {
            // Remove empty cells at the beginning and end
            return !(cell === '' && (index === 0 || index === array.length - 1));
        });
    }
    isMarkdownSeparatorLine(line) {
        const trimmed = line.trim();
        // Check if line contains only |, -, :, and spaces
        return /^[\|\-:\s]+$/.test(trimmed) && trimmed.includes('-');
    }
    normalizeRow(row, targetLength) {
        const normalized = [...row];
        // Pad with empty strings if too short
        while (normalized.length < targetLength) {
            normalized.push('');
        }
        // Truncate if too long
        if (normalized.length > targetLength) {
            normalized.length = targetLength;
        }
        return normalized;
    }
    /**
     * Détecte si la première ligne contient des headers de colonnes
     */
    detectColumnHeaders(rows) {
        if (rows.length < 2)
            return false;
        const firstRow = rows[0];
        const secondRow = rows[1];
        // Heuristiques pour détecter les headers :
        // 1. Première ligne contient du texte, deuxième ligne contient des nombres
        const firstRowHasText = firstRow.some(cell => cell && isNaN(Number(cell)) && cell.trim() !== '');
        const secondRowHasNumbers = secondRow.some(cell => cell && !isNaN(Number(cell)));
        // 2. Première ligne a des cellules plus longues (noms descriptifs)
        const avgFirstRowLength = firstRow.reduce((sum, cell) => sum + cell.length, 0) / firstRow.length;
        const avgSecondRowLength = secondRow.reduce((sum, cell) => sum + cell.length, 0) / secondRow.length;
        // 3. Première ligne contient des mots typiques de headers
        const headerKeywords = ['name', 'id', 'date', 'title', 'type', 'status', 'value', 'count'];
        const hasHeaderKeywords = firstRow.some(cell => headerKeywords.some(keyword => cell.toLowerCase().includes(keyword)));
        return (firstRowHasText && secondRowHasNumbers) ||
            (avgFirstRowLength > avgSecondRowLength * 1.2) ||
            hasHeaderKeywords;
    }
    /**
     * Détecte si la première colonne contient des headers de lignes
     */
    detectRowHeaders(rows) {
        if (rows.length < 2 || rows[0].length < 2)
            return false;
        // Vérifier si la première colonne contient du texte descriptif
        // tandis que les autres colonnes contiennent principalement des données
        const firstColumn = rows.map(row => row[0]).filter(cell => cell && cell.trim());
        const otherColumns = rows.map(row => row.slice(1)).flat().filter(cell => cell && cell.trim());
        if (firstColumn.length === 0 || otherColumns.length === 0)
            return false;
        // Première colonne majoritairement textuelle
        const firstColumnTextRatio = firstColumn.filter(cell => isNaN(Number(cell))).length / firstColumn.length;
        // Autres colonnes majoritairement numériques
        const otherColumnsNumericRatio = otherColumns.filter(cell => !isNaN(Number(cell))).length / otherColumns.length;
        return firstColumnTextRatio > 0.7 && otherColumnsNumericRatio > 0.5;
    }
    /**
     * Crée un nœud table avec les métadonnées de headers
     */
    createTableNode(headers, rows, options = { hasColumnHeader: false, hasRowHeader: false }) {
        return {
            type: 'table',
            content: '',
            metadata: {
                headers,
                rows,
                columnCount: Math.max(headers.length, ...rows.map(row => row.length)),
                rowCount: rows.length + (options.hasColumnHeader ? 1 : 0),
                hasColumnHeader: options.hasColumnHeader,
                hasRowHeader: options.hasRowHeader
            },
            children: []
        };
    }
    /**
     * Detect table format from content
     */
    static detectTableFormat(content) {
        const lines = content.split('\n').filter(line => line.trim());
        if (lines.length < 2)
            return 'none';
        // Check for markdown table
        const pipeLines = lines.filter(line => line.includes('|')).length;
        if (pipeLines >= 2 && pipeLines / lines.length > 0.5) {
            return 'markdown';
        }
        // Check for TSV (tab-separated)
        const tabLines = lines.filter(line => line.includes('\t')).length;
        if (tabLines / lines.length > 0.7) {
            return 'tsv';
        }
        // Check for CSV (comma-separated)
        const commaLines = lines.filter(line => line.includes(',')).length;
        if (commaLines / lines.length > 0.7) {
            return 'csv';
        }
        return 'none';
    }
}
exports.TableParser = TableParser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxyYXlhblxcRGVza3RvcFxcRGV2XFxOb3Rpb25DbGlwcGVyXFxwYWNrYWdlc1xcbm90aW9uLXBhcnNlclxcc3JjXFxwYXJzZXJzXFxUYWJsZVBhcnNlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSw2Q0FBMEM7QUFFMUMsbUVBQWdFO0FBRWhFLE1BQWEsV0FBWSxTQUFRLHVCQUFVO0lBQ3pDLFlBQVksVUFBd0IsRUFBRTtRQUNwQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDakIsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFlO1FBQ25CLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFFaEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUM7UUFFN0MsUUFBUSxXQUFXLEVBQUUsQ0FBQztZQUNwQixLQUFLLEtBQUs7Z0JBQ1IsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2hDLEtBQUssS0FBSztnQkFDUixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDaEMsS0FBSyxPQUFPLENBQUM7WUFDYjtnQkFDRSxPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM1QyxDQUFDO0lBQ0gsQ0FBQztJQUVPLFFBQVEsQ0FBQyxPQUFlO1FBQzlCLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRU8sUUFBUSxDQUFDLE9BQWU7UUFDOUIsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFTyxtQkFBbUIsQ0FBQyxPQUFlLEVBQUUsU0FBaUI7UUFDNUQsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFD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QUFDO1FBRTlELElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQUUsT0FBTyxNQUFNLENBQUM7UUFFcEMsMkJBQTJCO1FBQzNCLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2xFLElBQUksU0FBUyxJQUFJLENBQUMsSUFBSSxTQUFTLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQztZQUNyRCxPQUFPLFVBQVUsQ0FBQztRQUNwQixDQUFDO1FBRUQsZ0NBQWdDO1FBQ2hDLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2xFLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDbEMsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsa0NBQWtDO1FBQ2xDLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ25FLElBQUksVUFBVSxHQUFHLEtBQUssQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDcEMsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztDQUNGO0FBNVJELGtDQTRSQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHJheWFuXFxEZXNrdG9wXFxEZXZcXE5vdGlvbkNsaXBwZXJcXHBhY2thZ2VzXFxub3Rpb24tcGFyc2VyXFxzcmNcXHBhcnNlcnNcXFRhYmxlUGFyc2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VQYXJzZXIgfSBmcm9tICcuL0Jhc2VQYXJzZXInO1xyXG5pbXBvcnQgdHlwZSB7IEFTVE5vZGUsIFBhcnNlT3B0aW9ucyB9IGZyb20gJy4uL3R5cGVzJztcclxuaW1wb3J0IHsgQ29udGVudFNhbml0aXplciB9IGZyb20gJy4uL3NlY3VyaXR5L0NvbnRlbnRTYW5pdGl6ZXInO1xyXG5cclxuZXhwb3J0IGNsYXNzIFRhYmxlUGFyc2VyIGV4dGVuZHMgQmFzZVBhcnNlciB7XHJcbiAgY29uc3RydWN0b3Iob3B0aW9uczogUGFyc2VPcHRpb25zID0ge30pIHtcclxuICAgIHN1cGVyKG9wdGlvbnMpO1xyXG4gIH1cclxuXHJcbiAgcGFyc2UoY29udGVudDogc3RyaW5nKTogQVNUTm9kZVtdIHtcclxuICAgIGlmICghY29udGVudD8udHJpbSgpKSByZXR1cm4gW107XHJcblxyXG4gICAgY29uc3QgY29udGVudFR5cGUgPSB0aGlzLm9wdGlvbnMuY29udGVudFR5cGU7XHJcbiAgICBcclxuICAgIHN3aXRjaCAoY29udGVudFR5cGUpIHtcclxuICAgICAgY2FzZSAnY3N2JzpcclxuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUNzdihjb250ZW50KTtcclxuICAgICAgY2FzZSAndHN2JzpcclxuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZVRzdihjb250ZW50KTtcclxuICAgICAgY2FzZSAndGFibGUnOlxyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHJldHVybiB0aGlzLnBhcnNlTWFya2Rvd25UYWJsZShjb250ZW50KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgcGFyc2VDc3YoY29udGVudDogc3RyaW5nKTogQVNUTm9kZVtdIHtcclxuICAgIHJldHVybiB0aGlzLnBhcnNlRGVsaW1pdGVkVGFibGUoY29udGVudCwgJywnKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcGFyc2VUc3YoY29udGVudDogc3RyaW5nKTogQVNUTm9kZVtdIHtcclxuICAgIHJldHVybiB0aGlzLnBhcnNlRGVsaW1pdGVkVGFibGUoY29udGVudCwgJ1xcdCcpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwYXJzZURlbGltaXRlZFRhYmxlKGNvbnRlbnQ6IHN0cmluZywgZGVsaW1pdGVyOiBzdHJpbmcpOiBBU1ROb2RlW10ge1xyXG4gICAgY29uc3QgbGluZXMgPSBjb250ZW50LnNwbGl0KCdcXG4nKS5maWx0ZXIobGluZSA9PiBsaW5lLnRyaW0oKSk7XHJcbiAgICBcclxuICAgIGlmIChsaW5lcy5sZW5ndGggPCAyKSB7XHJcbiAgICAgIC8vIE5vdCBlbm91Z2ggZGF0YSBmb3IgYSB0YWJsZSwgcmV0dXJuIGFzIHRleHRcclxuICAgICAgcmV0dXJuIFt0aGlzLmNyZWF0ZVRleHROb2RlKGNvbnRlbnQpXTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBQYXJzZSBDU1YvVFNWIHdpdGggcHJvcGVyIHF1b3RlIGhhbmRsaW5nXHJcbiAgICBjb25zdCByb3dzID0gbGluZXMubWFwKGxpbmUgPT4gdGhpcy5wYXJzZURlbGltaXRlZExpbmUobGluZSwgZGVsaW1pdGVyKSk7XHJcbiAgICBcclxuICAgIC8vIERldGVjdCBoZWFkZXJzXHJcbiAgICBjb25zdCBoYXNDb2x1bW5IZWFkZXIgPSB0aGlzLmRldGVjdENvbHVtbkhlYWRlcnMocm93cyk7XHJcbiAgICBjb25zdCBoYXNSb3dIZWFkZXIgPSB0aGlzLmRldGVjdFJvd0hlYWRlcnMocm93cyk7XHJcbiAgICBcclxuICAgIC8vIFVzZSBmaXJzdCByb3cgYXMgaGVhZGVycyBpZiBkZXRlY3RlZFxyXG4gICAgY29uc3QgaGVhZGVycyA9IGhhc0NvbHVtbkhlYWRlciA/IHJvd3NbMF0gOiBbXTtcclxuICAgIGNvbnN0IGRhdGFSb3dzID0gaGFzQ29sdW1uSGVhZGVyID8gcm93cy5zbGljZSgxKSA6IHJvd3M7XHJcblxyXG4gICAgLy8gTm9ybWFsaXplIHJvdyBsZW5ndGhzXHJcbiAgICBjb25zdCBtYXhDb2x1bW5zID0gTWF0aC5tYXgoXHJcbiAgICAgIGhlYWRlcnMubGVuZ3RoLCBcclxuICAgICAgLi4uZGF0YVJvd3MubWFwKHJvdyA9PiByb3cubGVuZ3RoKVxyXG4gICAgKTtcclxuICAgIFxyXG4gICAgY29uc3Qgbm9ybWFsaXplZEhlYWRlcnMgPSBoYXNDb2x1bW5IZWFkZXIgPyB0aGlzLm5vcm1hbGl6ZVJvdyhoZWFkZXJzLCBtYXhDb2x1bW5zKSA6IFtdO1xyXG4gICAgY29uc3Qgbm9ybWFsaXplZFJvd3MgPSBkYXRhUm93cy5tYXAocm93ID0+IHRoaXMubm9ybWFsaXplUm93KHJvdywgbWF4Q29sdW1ucykpO1xyXG5cclxuICAgIHJldHVybiBbdGhpcy5jcmVhdGVUYWJsZU5vZGUobm9ybWFsaXplZEhlYWRlcnMsIG5vcm1hbGl6ZWRSb3dzLCB7XHJcbiAgICAgIGhhc0NvbHVtbkhlYWRlcixcclxuICAgICAgaGFzUm93SGVhZGVyXHJcbiAgICB9KV07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlRGVsaW1pdGVkTGluZShsaW5lOiBzdHJpbmcsIGRlbGltaXRlcjogc3RyaW5nKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgcmVzdWx0OiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgbGV0IGN1cnJlbnQgPSAnJztcclxuICAgIGxldCBpblF1b3RlcyA9IGZhbHNlO1xyXG4gICAgbGV0IGkgPSAwO1xyXG5cclxuICAgIHdoaWxlIChpIDwgbGluZS5sZW5ndGgpIHtcclxuICAgICAgY29uc3QgY2hhciA9IGxpbmVbaV07XHJcbiAgICAgIGNvbnN0IG5leHRDaGFyID0gbGluZVtpICsgMV07XHJcblxyXG4gICAgICBpZiAoY2hhciA9PT0gJ1wiJykge1xyXG4gICAgICAgIGlmIChpblF1b3RlcyAmJiBuZXh0Q2hhciA9PT0gJ1wiJykge1xyXG4gICAgICAgICAgLy8gRXNjYXBlZCBxdW90ZVxyXG4gICAgICAgICAgY3VycmVudCArPSAnXCInO1xyXG4gICAgICAgICAgaSArPSAyO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyBUb2dnbGUgcXVvdGUgc3RhdGVcclxuICAgICAgICAgIGluUXVvdGVzID0gIWluUXVvdGVzO1xyXG4gICAgICAgICAgaSsrO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIGlmIChjaGFyID09PSBkZWxpbWl0ZXIgJiYgIWluUXVvdGVzKSB7XHJcbiAgICAgICAgLy8gRmllbGQgc2VwYXJhdG9yXHJcbiAgICAgICAgcmVzdWx0LnB1c2goY3VycmVudC50cmltKCkpO1xyXG4gICAgICAgIGN1cnJlbnQgPSAnJztcclxuICAgICAgICBpKys7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY3VycmVudCArPSBjaGFyO1xyXG4gICAgICAgIGkrKztcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIEFkZCB0aGUgbGFzdCBmaWVsZFxyXG4gICAgcmVzdWx0LnB1c2goY3VycmVudC50cmltKCkpO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlTWFya2Rvd25UYWJsZShjb250ZW50OiBzdHJpbmcpOiBBU1ROb2RlW10ge1xyXG4gICAgY29uc3QgbGluZXMgPSBjb250ZW50LnNwbGl0KCdcXG4nKS5maWx0ZXIobGluZSA9PiBsaW5lLnRyaW0oKSk7XHJcbiAgICBcclxuICAgIC8vIEZpbmQgdGFibGUgbGluZXMgKGNvbnRhaW5pbmcgfClcclxuICAgIGNvbnN0IHRhYmxlTGluZXMgPSBsaW5lcy5maWx0ZXIobGluZSA9PiBsaW5lLmluY2x1ZGVzKCd8JykpO1xyXG4gICAgXHJcbiAgICBpZiAodGFibGVMaW5lcy5sZW5ndGggPCAyKSB7XHJcbiAgICAgIHJldHVybiBbdGhpcy5jcmVhdGVUZXh0Tm9kZShjb250ZW50KV07XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUGFyc2UgaGVhZGVyc1xyXG4gICAgY29uc3QgaGVhZGVyTGluZSA9IHRhYmxlTGluZXNbMF07XHJcbiAgICBjb25zdCBoZWFkZXJzID0gdGhpcy5wYXJzZU1hcmtkb3duVGFibGVSb3coaGVhZGVyTGluZSk7XHJcblxyXG4gICAgLy8gQ2hlY2sgZm9yIHNlcGFyYXRvciBsaW5lIChpbmRpY2F0ZXMgaGVhZGVycylcclxuICAgIGxldCBkYXRhU3RhcnRJbmRleCA9IDE7XHJcbiAgICBsZXQgaGFzQ29sdW1uSGVhZGVyID0gZmFsc2U7XHJcbiAgICBcclxuICAgIGlmICh0YWJsZUxpbmVzLmxlbmd0aCA+IDEgJiYgdGhpcy5pc01hcmtkb3duU2VwYXJhdG9yTGluZSh0YWJsZUxpbmVzWzFdKSkge1xyXG4gICAgICBkYXRhU3RhcnRJbmRleCA9IDI7XHJcbiAgICAgIGhhc0NvbHVtbkhlYWRlciA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUGFyc2UgZGF0YSByb3dzXHJcbiAgICBjb25zdCBkYXRhUm93cyA9IHRhYmxlTGluZXMuc2xpY2UoZGF0YVN0YXJ0SW5kZXgpXHJcbiAgICAgIC5tYXAobGluZSA9PiB0aGlzLnBhcnNlTWFya2Rvd25UYWJsZVJvdyhsaW5lKSlcclxuICAgICAgLm1hcChyb3cgPT4gdGhpcy5ub3JtYWxpemVSb3cocm93LCBoZWFkZXJzLmxlbmd0aCkpO1xyXG5cclxuICAgIC8vIERldGVjdCByb3cgaGVhZGVyc1xyXG4gICAgY29uc3QgaGFzUm93SGVhZGVyID0gdGhpcy5kZXRlY3RSb3dIZWFkZXJzKFtoZWFkZXJzLCAuLi5kYXRhUm93c10pO1xyXG5cclxuICAgIHJldHVybiBbdGhpcy5jcmVhdGVUYWJsZU5vZGUoaGVhZGVycywgZGF0YVJvd3MsIHtcclxuICAgICAgaGFzQ29sdW1uSGVhZGVyLFxyXG4gICAgICBoYXNSb3dIZWFkZXJcclxuICAgIH0pXTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcGFyc2VNYXJrZG93blRhYmxlUm93KGxpbmU6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgIC8vIFJlbW92ZSBsZWFkaW5nL3RyYWlsaW5nIHBpcGVzIGFuZCBzcGxpdFxyXG4gICAgY29uc3QgdHJpbW1lZCA9IGxpbmUudHJpbSgpO1xyXG4gICAgY29uc3Qgd2l0aG91dE91dGVyUGlwZXMgPSB0cmltbWVkLnN0YXJ0c1dpdGgoJ3wnKSA/IHRyaW1tZWQuc2xpY2UoMSkgOiB0cmltbWVkO1xyXG4gICAgY29uc3Qgd2l0aG91dFRyYWlsaW5nUGlwZSA9IHdpdGhvdXRPdXRlclBpcGVzLmVuZHNXaXRoKCd8JykgXHJcbiAgICAgID8gd2l0aG91dE91dGVyUGlwZXMuc2xpY2UoMCwgLTEpIFxyXG4gICAgICA6IHdpdGhvdXRPdXRlclBpcGVzO1xyXG5cclxuICAgIHJldHVybiB3aXRob3V0VHJhaWxpbmdQaXBlXHJcbiAgICAgIC5zcGxpdCgnfCcpXHJcbiAgICAgIC5tYXAoY2VsbCA9PiBDb250ZW50U2FuaXRpemVyLnNhbml0aXplVGFibGVDZWxsKGNlbGwudHJpbSgpKSlcclxuICAgICAgLmZpbHRlcigoY2VsbCwgaW5kZXgsIGFycmF5KSA9PiB7XHJcbiAgICAgICAgLy8gUmVtb3ZlIGVtcHR5IGNlbGxzIGF0IHRoZSBiZWdpbm5pbmcgYW5kIGVuZFxyXG4gICAgICAgIHJldHVybiAhKGNlbGwgPT09ICcnICYmIChpbmRleCA9PT0gMCB8fCBpbmRleCA9PT0gYXJyYXkubGVuZ3RoIC0gMSkpO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNNYXJrZG93blNlcGFyYXRvckxpbmUobGluZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCB0cmltbWVkID0gbGluZS50cmltKCk7XHJcbiAgICAvLyBDaGVjayBpZiBsaW5lIGNvbnRhaW5zIG9ubHkgfCwgLSwgOiwgYW5kIHNwYWNlc1xyXG4gICAgcmV0dXJuIC9eW1xcfFxcLTpcXHNdKyQvLnRlc3QodHJpbW1lZCkgJiYgdHJpbW1lZC5pbmNsdWRlcygnLScpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBub3JtYWxpemVSb3cocm93OiBzdHJpbmdbXSwgdGFyZ2V0TGVuZ3RoOiBudW1iZXIpOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBub3JtYWxpemVkID0gWy4uLnJvd107XHJcbiAgICBcclxuICAgIC8vIFBhZCB3aXRoIGVtcHR5IHN0cmluZ3MgaWYgdG9vIHNob3J0XHJcbiAgICB3aGlsZSAobm9ybWFsaXplZC5sZW5ndGggPCB0YXJnZXRMZW5ndGgpIHtcclxuICAgICAgbm9ybWFsaXplZC5wdXNoKCcnKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gVHJ1bmNhdGUgaWYgdG9vIGxvbmdcclxuICAgIGlmIChub3JtYWxpemVkLmxlbmd0aCA+IHRhcmdldExlbmd0aCkge1xyXG4gICAgICBub3JtYWxpemVkLmxlbmd0aCA9IHRhcmdldExlbmd0aDtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcmV0dXJuIG5vcm1hbGl6ZWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEw6l0ZWN0ZSBzaSBsYSBwcmVtacOocmUgbGlnbmUgY29udGllbnQgZGVzIGhlYWRlcnMgZGUgY29sb25uZXNcclxuICAgKi9cclxuICBwcml2YXRlIGRldGVjdENvbHVtbkhlYWRlcnMocm93czogc3RyaW5nW11bXSk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKHJvd3MubGVuZ3RoIDwgMikgcmV0dXJuIGZhbHNlO1xyXG4gICAgXHJcbiAgICBjb25zdCBmaXJzdFJvdyA9IHJvd3NbMF07XHJcbiAgICBjb25zdCBzZWNvbmRSb3cgPSByb3dzWzFdO1xyXG4gICAgXHJcbiAgICAvLyBIZXVyaXN0aXF1ZXMgcG91ciBkw6l0ZWN0ZXIgbGVzIGhlYWRlcnMgOlxyXG4gICAgLy8gMS4gUHJlbWnDqHJlIGxpZ25lIGNvbnRpZW50IGR1IHRleHRlLCBkZXV4acOobWUgbGlnbmUgY29udGllbnQgZGVzIG5vbWJyZXNcclxuICAgIGNvbnN0IGZpcnN0Um93SGFzVGV4dCA9IGZpcnN0Um93LnNvbWUoY2VsbCA9PiBcclxuICAgICAgY2VsbCAmJiBpc05hTihOdW1iZXIoY2VsbCkpICYmIGNlbGwudHJpbSgpICE9PSAnJ1xyXG4gICAgKTtcclxuICAgIFxyXG4gICAgY29uc3Qgc2Vjb25kUm93SGFzTnVtYmVycyA9IHNlY29uZFJvdy5zb21lKGNlbGwgPT4gXHJcbiAgICAgIGNlbGwgJiYgIWlzTmFOKE51bWJlcihjZWxsKSlcclxuICAgICk7XHJcbiAgICBcclxuICAgIC8vIDIuIFByZW1pw6hyZSBsaWduZSBhIGRlcyBjZWxsdWxlcyBwbHVzIGxvbmd1ZXMgKG5vbXMgZGVzY3JpcHRpZnMpXHJcbiAgICBjb25zdCBhdmdGaXJzdFJvd0xlbmd0aCA9IGZpcnN0Um93LnJlZHVjZSgoc3VtLCBjZWxsKSA9PiBzdW0gKyBjZWxsLmxlbmd0aCwgMCkgLyBmaXJzdFJvdy5sZW5ndGg7XHJcbiAgICBjb25zdCBhdmdTZWNvbmRSb3dMZW5ndGggPSBzZWNvbmRSb3cucmVkdWNlKChzdW0sIGNlbGwpID0+IHN1bSArIGNlbGwubGVuZ3RoLCAwKSAvIHNlY29uZFJvdy5sZW5ndGg7XHJcbiAgICBcclxuICAgIC8vIDMuIFByZW1pw6hyZSBsaWduZSBjb250aWVudCBkZXMgbW90cyB0eXBpcXVlcyBkZSBoZWFkZXJzXHJcbiAgICBjb25zdCBoZWFkZXJLZXl3b3JkcyA9IFsnbmFtZScsICdpZCcsICdkYXRlJywgJ3RpdGxlJywgJ3R5cGUnLCAnc3RhdHVzJywgJ3ZhbHVlJywgJ2NvdW50J107XHJcbiAgICBjb25zdCBoYXNIZWFkZXJLZXl3b3JkcyA9IGZpcnN0Um93LnNvbWUoY2VsbCA9PiBcclxuICAgICAgaGVhZGVyS2V5d29yZHMuc29tZShrZXl3b3JkID0+IFxyXG4gICAgICAgIGNlbGwudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhrZXl3b3JkKVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gICAgXHJcbiAgICByZXR1cm4gKGZpcnN0Um93SGFzVGV4dCAmJiBzZWNvbmRSb3dIYXNOdW1iZXJzKSB8fCBcclxuICAgICAgICAgICAoYXZnRmlyc3RSb3dMZW5ndGggPiBhdmdTZWNvbmRSb3dMZW5ndGggKiAxLjIpIHx8XHJcbiAgICAgICAgICAgaGFzSGVhZGVyS2V5d29yZHM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEw6l0ZWN0ZSBzaSBsYSBwcmVtacOocmUgY29sb25uZSBjb250aWVudCBkZXMgaGVhZGVycyBkZSBsaWduZXNcclxuICAgKi9cclxuICBwcml2YXRlIGRldGVjdFJvd0hlYWRlcnMocm93czogc3RyaW5nW11bXSk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKHJvd3MubGVuZ3RoIDwgMiB8fCByb3dzWzBdLmxlbmd0aCA8IDIpIHJldHVybiBmYWxzZTtcclxuICAgIFxyXG4gICAgLy8gVsOpcmlmaWVyIHNpIGxhIHByZW1pw6hyZSBjb2xvbm5lIGNvbnRpZW50IGR1IHRleHRlIGRlc2NyaXB0aWZcclxuICAgIC8vIHRhbmRpcyBxdWUgbGVzIGF1dHJlcyBjb2xvbm5lcyBjb250aWVubmVudCBwcmluY2lwYWxlbWVudCBkZXMgZG9ubsOpZXNcclxuICAgIGNvbnN0IGZpcnN0Q29sdW1uID0gcm93cy5tYXAocm93ID0+IHJvd1swXSkuZmlsdGVyKGNlbGwgPT4gY2VsbCAmJiBjZWxsLnRyaW0oKSk7XHJcbiAgICBjb25zdCBvdGhlckNvbHVtbnMgPSByb3dzLm1hcChyb3cgPT4gcm93LnNsaWNlKDEpKS5mbGF0KCkuZmlsdGVyKGNlbGwgPT4gY2VsbCAmJiBjZWxsLnRyaW0oKSk7XHJcbiAgICBcclxuICAgIGlmIChmaXJzdENvbHVtbi5sZW5ndGggPT09IDAgfHwgb3RoZXJDb2x1bW5zLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlO1xyXG4gICAgXHJcbiAgICAvLyBQcmVtacOocmUgY29sb25uZSBtYWpvcml0YWlyZW1lbnQgdGV4dHVlbGxlXHJcbiAgICBjb25zdCBmaXJzdENvbHVtblRleHRSYXRpbyA9IGZpcnN0Q29sdW1uLmZpbHRlcihjZWxsID0+IGlzTmFOKE51bWJlcihjZWxsKSkpLmxlbmd0aCAvIGZpcnN0Q29sdW1uLmxlbmd0aDtcclxuICAgIFxyXG4gICAgLy8gQXV0cmVzIGNvbG9ubmVzIG1ham9yaXRhaXJlbWVudCBudW3DqXJpcXVlc1xyXG4gICAgY29uc3Qgb3RoZXJDb2x1bW5zTnVtZXJpY1JhdGlvID0gb3RoZXJDb2x1bW5zLmZpbHRlcihjZWxsID0+ICFpc05hTihOdW1iZXIoY2VsbCkpKS5sZW5ndGggLyBvdGhlckNvbHVtbnMubGVuZ3RoO1xyXG4gICAgXHJcbiAgICByZXR1cm4gZmlyc3RDb2x1bW5UZXh0UmF0aW8gPiAwLjcgJiYgb3RoZXJDb2x1bW5zTnVtZXJpY1JhdGlvID4gMC41O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3LDqWUgdW4gbsWTdWQgdGFibGUgYXZlYyBsZXMgbcOpdGFkb25uw6llcyBkZSBoZWFkZXJzXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGNyZWF0ZVRhYmxlTm9kZShoZWFkZXJzOiBzdHJpbmdbXSwgcm93czogc3RyaW5nW11bXSwgb3B0aW9uczoge1xyXG4gICAgaGFzQ29sdW1uSGVhZGVyOiBib29sZWFuO1xyXG4gICAgaGFzUm93SGVhZGVyOiBib29sZWFuO1xyXG4gIH0gPSB7IGhhc0NvbHVtbkhlYWRlcjogZmFsc2UsIGhhc1Jvd0hlYWRlcjogZmFsc2UgfSk6IEFTVE5vZGUge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdHlwZTogJ3RhYmxlJyxcclxuICAgICAgY29udGVudDogJycsXHJcbiAgICAgIG1ldGFkYXRhOiB7XHJcbiAgICAgICAgaGVhZGVycyxcclxuICAgICAgICByb3dzLFxyXG4gICAgICAgIGNvbHVtbkNvdW50OiBNYXRoLm1heChoZWFkZXJzLmxlbmd0aCwgLi4ucm93cy5tYXAocm93ID0+IHJvdy5sZW5ndGgpKSxcclxuICAgICAgICByb3dDb3VudDogcm93cy5sZW5ndGggKyAob3B0aW9ucy5oYXNDb2x1bW5IZWFkZXIgPyAxIDogMCksXHJcbiAgICAgICAgaGFzQ29sdW1uSGVhZGVyOiBvcHRpb25zLmhhc0NvbHVtbkhlYWRlcixcclxuICAgICAgICBoYXNSb3dIZWFkZXI6IG9wdGlvbnMuaGFzUm93SGVhZGVyXHJcbiAgICAgIH0sXHJcbiAgICAgIGNoaWxkcmVuOiBbXVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERldGVjdCB0YWJsZSBmb3JtYXQgZnJvbSBjb250ZW50XHJcbiAgICovXHJcbiAgc3RhdGljIGRldGVjdFRhYmxlRm9ybWF0KGNvbnRlbnQ6IHN0cmluZyk6ICdjc3YnIHwgJ3RzdicgfCAnbWFya2Rvd24nIHwgJ25vbmUnIHtcclxuICAgIGNvbnN0IGxpbmVzID0gY29udGVudC5zcGxpdCgnXFxuJykuZmlsdGVyKGxpbmUgPT4gbGluZS50cmltKCkpO1xyXG4gICAgXHJcbiAgICBpZiAobGluZXMubGVuZ3RoIDwgMikgcmV0dXJuICdub25lJztcclxuXHJcbiAgICAvLyBDaGVjayBmb3IgbWFya2Rvd24gdGFibGVcclxuICAgIGNvbnN0IHBpcGVMaW5lcyA9IGxpbmVzLmZpbHRlcihsaW5lID0+IGxpbmUuaW5jbHVkZXMoJ3wnKSkubGVuZ3RoO1xyXG4gICAgaWYgKHBpcGVMaW5lcyA+PSAyICYmIHBpcGVMaW5lcyAvIGxpbmVzLmxlbmd0aCA+IDAuNSkge1xyXG4gICAgICByZXR1cm4gJ21hcmtkb3duJztcclxuICAgIH1cclxuXHJcbiAgICAvLyBDaGVjayBmb3IgVFNWICh0YWItc2VwYXJhdGVkKVxyXG4gICAgY29uc3QgdGFiTGluZXMgPSBsaW5lcy5maWx0ZXIobGluZSA9PiBsaW5lLmluY2x1ZGVzKCdcXHQnKSkubGVuZ3RoO1xyXG4gICAgaWYgKHRhYkxpbmVzIC8gbGluZXMubGVuZ3RoID4gMC43KSB7XHJcbiAgICAgIHJldHVybiAndHN2JztcclxuICAgIH1cclxuXHJcbiAgICAvLyBDaGVjayBmb3IgQ1NWIChjb21tYS1zZXBhcmF0ZWQpXHJcbiAgICBjb25zdCBjb21tYUxpbmVzID0gbGluZXMuZmlsdGVyKGxpbmUgPT4gbGluZS5pbmNsdWRlcygnLCcpKS5sZW5ndGg7XHJcbiAgICBpZiAoY29tbWFMaW5lcyAvIGxpbmVzLmxlbmd0aCA+IDAuNykge1xyXG4gICAgICByZXR1cm4gJ2Nzdic7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuICdub25lJztcclxuICB9XHJcbn0iXSwidmVyc2lvbiI6M30=