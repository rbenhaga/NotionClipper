2a56f8709183e47814c771902056b8f8
"use strict";
/**
 * Tests complets des parsers spécialisés
 * Basé sur le test ultimate exhaustif - Phase 2
 */
Object.defineProperty(exports, "__esModule", { value: true });
const parseContent_1 = require("../../src/parseContent");
describe('Specialized Parsers - Phase 2', () => {
    describe('MarkdownParser - Headers', () => {
        it('should parse all header levels correctly', async () => {
            const content = `# H1 Title
## H2 Subtitle
### H3 Section`;
            const result = (0, parseContent_1.parseContent)(content, { contentType: 'markdown' });
            const blocks = result.blocks;
            const headerTypes = blocks.map((b) => b.type);
            const expectedTypes = ['heading_1', 'heading_2', 'heading_3'];
            expect(expectedTypes.every(type => headerTypes.includes(type))).toBe(true);
        });
        it('should handle headers with formatting', async () => {
            const content = `# **Bold** Header with *italic*
## Header with \`code\``;
            const result = (0, parseContent_1.parseContent)(content, { contentType: 'markdown' });
            const blocks = result.blocks;
            const h1Block = blocks.find((b) => b.type === 'heading_1');
            expect(h1Block?.heading_1?.rich_text).toBeDefined();
            expect(h1Block?.heading_1?.rich_text?.length).toBeGreaterThan(1);
        });
    });
    describe('MarkdownParser - Lists', () => {
        it('should parse nested lists with proper hierarchy', async () => {
            const content = `- Bullet 1
- Bullet 2
  - Nested 1
    - Deep nested
      - Too deep (should be flattened to level 3)

1. Numbered 1
2. Numbered 2
   1. Nested numbered

- [ ] Todo unchecked
- [x] Todo checked`;
            const result = (0, parseContent_1.parseContent)(content, { contentType: 'markdown' });
            const blocks = result.blocks;
            const listTypes = blocks.map((b) => b.type);
            const hasRequiredLists = listTypes.includes('bulleted_list_item') &&
                listTypes.includes('numbered_list_item') &&
                listTypes.includes('to_do');
            expect(hasRequiredLists).toBe(true);
        });
        it('should respect maximum nesting depth of 3', async () => {
            const content = `- Level 1
  - Level 2
    - Level 3
      - Level 4 (should be flattened)
        - Level 5 (should be flattened)`;
            const result = (0, parseContent_1.parseContent)(content, { contentType: 'markdown' });
            const blocks = result.blocks;
            // Vérifier que l'imbrication ne dépasse pas 3 niveaux
            const checkMaxDepth = (block, depth = 0) => {
                if (depth > 3)
                    return depth;
                if (block.children && Array.isArray(block.children)) {
                    return Math.max(depth, ...block.children.map((child) => checkMaxDepth(child, depth + 1)));
                }
                return depth;
            };
            const maxDepth = Math.max(...blocks.map(block => checkMaxDepth(block)));
            expect(maxDepth).toBeLessThanOrEqual(3);
        });
    });
    describe('MarkdownParser - Callouts', () => {
        it('should parse all 6 callout types', async () => {
            const content = `> [!note] Note
> Content

> [!info] Info
> Content

> [!tip] Tip
> Content

> [!warning] Warning
> Content

> [!danger] Danger
> Content

> [!success] Success
> Content`;
            const result = (0, parseContent_1.parseContent)(content, { contentType: 'markdown' });
            const blocks = result.blocks;
            const callouts = blocks.filter((b) => b.type === 'callout');
            expect(callouts.length).toBeGreaterThanOrEqual(6);
            const calloutIcons = callouts.map(c => c.callout?.icon?.emoji).filter(Boolean);
            expect(calloutIcons.length).toBeGreaterThan(0);
        });
        it('should handle callouts with rich text content', async () => {
            const content = `> [!info] Information
> This callout has **bold** and *italic* text with \`code\`.`;
            const result = (0, parseContent_1.parseContent)(content, { contentType: 'markdown' });
            const blocks = result.blocks;
            const callout = blocks.find((b) => b.type === 'callout');
            expect(callout?.callout?.rich_text).toBeDefined();
            expect(callout?.callout?.rich_text?.length).toBeGreaterThan(1);
        });
    });
    describe('MarkdownParser - Rich Text Annotations', () => {
        it('should parse multiple annotation types', async () => {
            const content = `**bold** *italic* ***bold italic*** __underline__ ~~strikethrough~~ \`code\` [link](https://notion.so) $E=mc^2$ inline equation`;
            const result = (0, parseContent_1.parseContent)(content, { contentType: 'markdown' });
            const blocks = result.blocks;
            let annotationTypes = new Set();
            blocks.forEach((block) => {
                if (block.paragraph?.rich_text) {
                    block.paragraph.rich_text.forEach((segment) => {
                        if (segment.annotations) {
                            Object.keys(segment.annotations).forEach(key => {
                                if (segment.annotations[key]) {
                                    annotationTypes.add(key);
                                }
                            });
                        }
                        if (segment.href)
                            annotationTypes.add('link');
                        if (segment.type === 'equation')
                            annotationTypes.add('equation');
                    });
                }
            });
            expect(annotationTypes.size).toBeGreaterThanOrEqual(5);
        });
    });
    describe('AudioParser - Format Support', () => {
        it('should create audio blocks for supported formats', async () => {
            const audioUrls = [
                'https://example.com/audio.mp3',
                'https://example.com/audio.wav',
                'https://soundcloud.com/track/123',
                'https://spotify.com/track/456'
            ];
            let audioBlocksCreated = 0;
            audioUrls.forEach(url => {
                const result = (0, parseContent_1.parseContent)(url, { contentType: 'audio' });
                const blocks = result.blocks;
                const audioBlocks = blocks.filter((b) => b.type === 'audio');
                audioBlocksCreated += audioBlocks.length;
            });
            expect(audioBlocksCreated).toBeGreaterThanOrEqual(2);
        });
        it('should validate audio URL formats', async () => {
            const supportedFormats = ['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac', 'webm'];
            const testUrls = supportedFormats.map(format => `https://example.com/audio.${format}`);
            let validFormats = 0;
            testUrls.forEach(url => {
                try {
                    const result = (0, parseContent_1.parseContent)(url, { contentType: 'audio' });
                    const blocks = result.blocks;
                    if (blocks.some(b => b.type === 'audio')) {
                        validFormats++;
                    }
                }
                catch (error) {
                    // Format non supporté
                }
            });
            expect(validFormats).toBeGreaterThanOrEqual(5);
        });
    });
    describe('TableParser - Header Detection', () => {
        it('should automatically detect CSV headers', async () => {
            const csvWithHeaders = `Name,Age,City
John,30,Paris
Jane,25,London`;
            const result = (0, parseContent_1.parseContent)(csvWithHeaders, { contentType: 'csv' });
            const blocks = result.blocks;
            const tableBlock = blocks.find((b) => b.type === 'table');
            expect(tableBlock?.table?.has_column_header).toBe(true);
        });
        it('should detect row headers when appropriate', async () => {
            const csvWithRowHeaders = `Category,Q1,Q2,Q3,Q4
Sales,100,120,110,130
Marketing,50,60,55,65
Support,30,35,32,38`;
            const result = (0, parseContent_1.parseContent)(csvWithRowHeaders, { contentType: 'csv' });
            const blocks = result.blocks;
            const tableBlock = blocks.find((b) => b.type === 'table');
            // Row headers detection might be implemented
            expect(tableBlock?.table).toBeDefined();
        });
        it('should handle markdown tables with separators', async () => {
            const markdownTable = `| Product | Price | Stock |
|---------|-------|-------|
| Apple   | $1.00 | 50    |
| Orange  | $0.80 | 30    |`;
            const result = (0, parseContent_1.parseContent)(markdownTable, { contentType: 'markdown' });
            const blocks = result.blocks;
            const tableBlock = blocks.find((b) => b.type === 'table');
            expect(tableBlock?.table?.has_column_header).toBe(true);
            expect(tableBlock?.table?.table_width).toBe(3);
        });
    });
    describe('Toggle Headings', () => {
        it('should create toggle headings with children', async () => {
            const content = `> # Toggle Heading 1
> Content under toggle

> ## Toggle Heading 2  
> More content`;
            const result = (0, parseContent_1.parseContent)(content, { contentType: 'markdown' });
            const blocks = result.blocks;
            const toggleHeadings = blocks.filter((b) => (b.type === 'heading_1' || b.type === 'heading_2') &&
                (b.heading_1?.is_toggleable || b.heading_2?.is_toggleable || b.children?.length > 0));
            expect(toggleHeadings.length).toBeGreaterThanOrEqual(1);
        });
        it('should properly nest content under toggle headings', async () => {
            const content = `> # Toggle Heading
> This is content under the toggle
> - List item 1
> - List item 2
> 
> More content`;
            const result = (0, parseContent_1.parseContent)(content, { contentType: 'markdown' });
            const blocks = result.blocks;
            const toggleHeading = blocks.find((b) => b.type === 'heading_1' &&
                (b.heading_1?.is_toggleable || b.children?.length > 0));
            expect(toggleHeading).toBeDefined();
            if (toggleHeading?.children) {
                expect(toggleHeading.children.length).toBeGreaterThan(0);
            }
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxyYXlhblxcRGVza3RvcFxcRGV2XFxOb3Rpb25DbGlwcGVyXFxwYWNrYWdlc1xcbm90aW9uLXBhcnNlclxcdGVzdHNcXGNvbXByZWhlbnNpdmVcXHBhcnNlcnMudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOztBQUVILHlEQUFzRDtBQVF0RCxRQUFRLENBQUMsK0JBQStCLEVBQUUsR0FBRyxFQUFFO0lBQzdDLFFBQVEsQ0FBQywwQkFBMEIsRUFBRSxHQUFHLEVBQUU7UUFDeEMsRUFBRSxDQUFDLDBDQUEwQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3hELE1BQU0sT0FBTyxHQUFHOztlQUVQLENBQUM7WUFFVixNQUFNLE1BQU0sR0FBRyxJQUFBLDJCQUFZLEVBQUMsT0FBTyxFQUFFLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFDbEUsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQXFCLENBQUM7WUFFNUMsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQVksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3pELE1BQU0sYUFBYSxHQUFHLENBQUMsV0FBVyxFQUFFLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUU5RCxNQUFNLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3RSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx1Q0FBdUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNyRCxNQUFNLE9BQU8sR0FBRzt3QkFDRSxDQUFDO1lBRW5CLE1BQU0sTUFBTSxHQUFHLElBQUEsMkJBQVksRUFBQyxPQUFPLEVBQUUsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztZQUNsRSxNQUFNLE1B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QSwyQkFBWSxFQUFDLE9BQU8sRUFBRSxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1lBQ2xFLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFxQixDQUFDO1lBRTVDLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFZLEVBQUUsRUFBRSxDQUNqRCxDQUFDLENBQUMsSUFBSSxLQUFLLFdBQVc7Z0JBQ3RCLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxhQUFhLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQ3ZELENBQUM7WUFFRixNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDcEMsSUFBSSxhQUFhLEVBQUUsUUFBUSxFQUFFLENBQUM7Z0JBQzVCLE1BQU0sQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzRCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xccmF5YW5cXERlc2t0b3BcXERldlxcTm90aW9uQ2xpcHBlclxccGFja2FnZXNcXG5vdGlvbi1wYXJzZXJcXHRlc3RzXFxjb21wcmVoZW5zaXZlXFxwYXJzZXJzLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIFRlc3RzIGNvbXBsZXRzIGRlcyBwYXJzZXJzIHNww6ljaWFsaXPDqXNcclxuICogQmFzw6kgc3VyIGxlIHRlc3QgdWx0aW1hdGUgZXhoYXVzdGlmIC0gUGhhc2UgMlxyXG4gKi9cclxuXHJcbmltcG9ydCB7IHBhcnNlQ29udGVudCB9IGZyb20gJy4uLy4uL3NyYy9wYXJzZUNvbnRlbnQnO1xyXG5cclxuLy8gVHlwZXMgZmxleGlibGVzIHBvdXIgbGVzIHRlc3RzXHJcbnR5cGUgVGVzdEJsb2NrID0ge1xyXG4gIHR5cGU6IHN0cmluZztcclxuICBba2V5OiBzdHJpbmddOiBhbnk7XHJcbn07XHJcblxyXG5kZXNjcmliZSgnU3BlY2lhbGl6ZWQgUGFyc2VycyAtIFBoYXNlIDInLCAoKSA9PiB7XHJcbiAgZGVzY3JpYmUoJ01hcmtkb3duUGFyc2VyIC0gSGVhZGVycycsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgcGFyc2UgYWxsIGhlYWRlciBsZXZlbHMgY29ycmVjdGx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBjb250ZW50ID0gYCMgSDEgVGl0bGVcclxuIyMgSDIgU3VidGl0bGVcclxuIyMjIEgzIFNlY3Rpb25gO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgcmVzdWx0ID0gcGFyc2VDb250ZW50KGNvbnRlbnQsIHsgY29udGVudFR5cGU6ICdtYXJrZG93bicgfSk7XHJcbiAgICAgIGNvbnN0IGJsb2NrcyA9IHJlc3VsdC5ibG9ja3MgYXMgVGVzdEJsb2NrW107XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBoZWFkZXJUeXBlcyA9IGJsb2Nrcy5tYXAoKGI6IFRlc3RCbG9jaykgPT4gYi50eXBlKTtcclxuICAgICAgY29uc3QgZXhwZWN0ZWRUeXBlcyA9IFsnaGVhZGluZ18xJywgJ2hlYWRpbmdfMicsICdoZWFkaW5nXzMnXTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChleHBlY3RlZFR5cGVzLmV2ZXJ5KHR5cGUgPT4gaGVhZGVyVHlwZXMuaW5jbHVkZXModHlwZSkpKS50b0JlKHRydWUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgaGVhZGVycyB3aXRoIGZvcm1hdHRpbmcnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBgIyAqKkJvbGQqKiBIZWFkZXIgd2l0aCAqaXRhbGljKlxyXG4jIyBIZWFkZXIgd2l0aCBcXGBjb2RlXFxgYDtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHBhcnNlQ29udGVudChjb250ZW50LCB7IGNvbnRlbnRUeXBlOiAnbWFya2Rvd24nIH0pO1xyXG4gICAgICBjb25zdCBibG9ja3MgPSByZXN1bHQuYmxvY2tzIGFzIFRlc3RCbG9ja1tdO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgaDFCbG9jayA9IGJsb2Nrcy5maW5kKChiOiBUZXN0QmxvY2spID0+IGIudHlwZSA9PT0gJ2hlYWRpbmdfMScpO1xyXG4gICAgICBleHBlY3QoaDFCbG9jaz8uaGVhZGluZ18xPy5yaWNoX3RleHQpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChoMUJsb2NrPy5oZWFkaW5nXzE/LnJpY2hfdGV4dD8ubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ01hcmtkb3duUGFyc2VyIC0gTGlzdHMnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHBhcnNlIG5lc3RlZCBsaXN0cyB3aXRoIHByb3BlciBoaWVyYXJjaHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBgLSBCdWxsZXQgMVxyXG4tIEJ1bGxldCAyXHJcbiAgLSBOZXN0ZWQgMVxyXG4gICAgLSBEZWVwIG5lc3RlZFxyXG4gICAgICAtIFRvbyBkZWVwIChzaG91bGQgYmUgZmxhdHRlbmVkIHRvIGxldmVsIDMpXHJcblxyXG4xLiBOdW1iZXJlZCAxXHJcbjIuIE51bWJlcmVkIDJcclxuICAgMS4gTmVzdGVkIG51bWJlcmVkXHJcblxyXG4tIFsgXSBUb2RvIHVuY2hlY2tlZFxyXG4tIFt4XSBUb2RvIGNoZWNrZWRgO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgcmVzdWx0ID0gcGFyc2VDb250ZW50KGNvbnRlbnQsIHsgY29udGVudFR5cGU6ICdtYXJrZG93bicgfSk7XHJcbiAgICAgIGNvbnN0IGJsb2NrcyA9IHJlc3VsdC5ibG9ja3MgYXMgVGVzdEJsb2NrW107XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBsaXN0VHlwZXMgPSBibG9ja3MubWFwKChiOiBUZXN0QmxvY2spID0+IGIudHlwZSk7XHJcbiAgICAgIGNvbnN0IGhhc1JlcXVpcmVkTGlzdHMgPSBsaXN0VHlwZXMuaW5jbHVkZXMoJ2J1bGxldGVkX2xpc3RfaXRlbScpICYmIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0VHlwZXMuaW5jbHVkZXMoJ251bWJlcmVkX2xpc3RfaXRlbScpICYmIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0VHlwZXMuaW5jbHVkZXMoJ3RvX2RvJyk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QoaGFzUmVxdWlyZWRMaXN0cykudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgcmVzcGVjdCBtYXhpbXVtIG5lc3RpbmcgZGVwdGggb2YgMycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgY29udGVudCA9IGAtIExldmVsIDFcclxuICAtIExldmVsIDJcclxuICAgIC0gTGV2ZWwgM1xyXG4gICAgICAtIExldmVsIDQgKHNob3VsZCBiZSBmbGF0dGVuZWQpXHJcbiAgICAgICAgLSBMZXZlbCA1IChzaG91bGQgYmUgZmxhdHRlbmVkKWA7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCByZXN1bHQgPSBwYXJzZUNvbnRlbnQoY29udGVudCwgeyBjb250ZW50VHlwZTogJ21hcmtkb3duJyB9KTtcclxuICAgICAgY29uc3QgYmxvY2tzID0gcmVzdWx0LmJsb2NrcyBhcyBUZXN0QmxvY2tbXTtcclxuICAgICAgXHJcbiAgICAgIC8vIFbDqXJpZmllciBxdWUgbCdpbWJyaWNhdGlvbiBuZSBkw6lwYXNzZSBwYXMgMyBuaXZlYXV4XHJcbiAgICAgIGNvbnN0IGNoZWNrTWF4RGVwdGggPSAoYmxvY2s6IGFueSwgZGVwdGggPSAwKTogbnVtYmVyID0+IHtcclxuICAgICAgICBpZiAoZGVwdGggPiAzKSByZXR1cm4gZGVwdGg7XHJcbiAgICAgICAgaWYgKGJsb2NrLmNoaWxkcmVuICYmIEFycmF5LmlzQXJyYXkoYmxvY2suY2hpbGRyZW4pKSB7XHJcbiAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoZGVwdGgsIC4uLmJsb2NrLmNoaWxkcmVuLm1hcCgoY2hpbGQ6IGFueSkgPT4gY2hlY2tNYXhEZXB0aChjaGlsZCwgZGVwdGggKyAxKSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZGVwdGg7XHJcbiAgICAgIH07XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBtYXhEZXB0aCA9IE1hdGgubWF4KC4uLmJsb2Nrcy5tYXAoYmxvY2sgPT4gY2hlY2tNYXhEZXB0aChibG9jaykpKTtcclxuICAgICAgZXhwZWN0KG1heERlcHRoKS50b0JlTGVzc1RoYW5PckVxdWFsKDMpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdNYXJrZG93blBhcnNlciAtIENhbGxvdXRzJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBwYXJzZSBhbGwgNiBjYWxsb3V0IHR5cGVzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBjb250ZW50ID0gYD4gWyFub3RlXSBOb3RlXHJcbj4gQ29udGVudFxyXG5cclxuPiBbIWluZm9dIEluZm9cclxuPiBDb250ZW50XHJcblxyXG4+IFshdGlwXSBUaXBcclxuPiBDb250ZW50XHJcblxyXG4+IFshd2FybmluZ10gV2FybmluZ1xyXG4+IENvbnRlbnRcclxuXHJcbj4gWyFkYW5nZXJdIERhbmdlclxyXG4+IENvbnRlbnRcclxuXHJcbj4gWyFzdWNjZXNzXSBTdWNjZXNzXHJcbj4gQ29udGVudGA7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCByZXN1bHQgPSBwYXJzZUNvbnRlbnQoY29udGVudCwgeyBjb250ZW50VHlwZTogJ21hcmtkb3duJyB9KTtcclxuICAgICAgY29uc3QgYmxvY2tzID0gcmVzdWx0LmJsb2NrcyBhcyBUZXN0QmxvY2tbXTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGNhbGxvdXRzID0gYmxvY2tzLmZpbHRlcigoYjogVGVzdEJsb2NrKSA9PiBiLnR5cGUgPT09ICdjYWxsb3V0Jyk7XHJcbiAgICAgIGV4cGVjdChjYWxsb3V0cy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoNik7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCBjYWxsb3V0SWNvbnMgPSBjYWxsb3V0cy5tYXAoYyA9PiBjLmNhbGxvdXQ/Lmljb24/LmVtb2ppKS5maWx0ZXIoQm9vbGVhbik7XHJcbiAgICAgIGV4cGVjdChjYWxsb3V0SWNvbnMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBjYWxsb3V0cyB3aXRoIHJpY2ggdGV4dCBjb250ZW50JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBjb250ZW50ID0gYD4gWyFpbmZvXSBJbmZvcm1hdGlvblxyXG4+IFRoaXMgY2FsbG91dCBoYXMgKipib2xkKiogYW5kICppdGFsaWMqIHRleHQgd2l0aCBcXGBjb2RlXFxgLmA7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCByZXN1bHQgPSBwYXJzZUNvbnRlbnQoY29udGVudCwgeyBjb250ZW50VHlwZTogJ21hcmtkb3duJyB9KTtcclxuICAgICAgY29uc3QgYmxvY2tzID0gcmVzdWx0LmJsb2NrcyBhcyBUZXN0QmxvY2tbXTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGNhbGxvdXQgPSBibG9ja3MuZmluZCgoYjogVGVzdEJsb2NrKSA9PiBiLnR5cGUgPT09ICdjYWxsb3V0Jyk7XHJcbiAgICAgIGV4cGVjdChjYWxsb3V0Py5jYWxsb3V0Py5yaWNoX3RleHQpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgIGV4cGVjdChjYWxsb3V0Py5jYWxsb3V0Py5yaWNoX3RleHQ/Lmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDEpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdNYXJrZG93blBhcnNlciAtIFJpY2ggVGV4dCBBbm5vdGF0aW9ucycsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgcGFyc2UgbXVsdGlwbGUgYW5ub3RhdGlvbiB0eXBlcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgY29udGVudCA9IGAqKmJvbGQqKiAqaXRhbGljKiAqKipib2xkIGl0YWxpYyoqKiBfX3VuZGVybGluZV9fIH5+c3RyaWtldGhyb3VnaH5+IFxcYGNvZGVcXGAgW2xpbmtdKGh0dHBzOi8vbm90aW9uLnNvKSAkRT1tY14yJCBpbmxpbmUgZXF1YXRpb25gO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgcmVzdWx0ID0gcGFyc2VDb250ZW50KGNvbnRlbnQsIHsgY29udGVudFR5cGU6ICdtYXJrZG93bicgfSk7XHJcbiAgICAgIGNvbnN0IGJsb2NrcyA9IHJlc3VsdC5ibG9ja3MgYXMgVGVzdEJsb2NrW107XHJcbiAgICAgIFxyXG4gICAgICBsZXQgYW5ub3RhdGlvblR5cGVzID0gbmV3IFNldDxzdHJpbmc+KCk7XHJcbiAgICAgIGJsb2Nrcy5mb3JFYWNoKChibG9jazogVGVzdEJsb2NrKSA9PiB7XHJcbiAgICAgICAgaWYgKGJsb2NrLnBhcmFncmFwaD8ucmljaF90ZXh0KSB7XHJcbiAgICAgICAgICBibG9jay5wYXJhZ3JhcGgucmljaF90ZXh0LmZvckVhY2goKHNlZ21lbnQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2VnbWVudC5hbm5vdGF0aW9ucykge1xyXG4gICAgICAgICAgICAgIE9iamVjdC5rZXlzKHNlZ21lbnQuYW5ub3RhdGlvbnMpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChzZWdtZW50LmFubm90YXRpb25zW2tleV0pIHtcclxuICAgICAgICAgICAgICAgICAgYW5ub3RhdGlvblR5cGVzLmFkZChrZXkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChzZWdtZW50LmhyZWYpIGFubm90YXRpb25UeXBlcy5hZGQoJ2xpbmsnKTtcclxuICAgICAgICAgICAgaWYgKHNlZ21lbnQudHlwZSA9PT0gJ2VxdWF0aW9uJykgYW5ub3RhdGlvblR5cGVzLmFkZCgnZXF1YXRpb24nKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QoYW5ub3RhdGlvblR5cGVzLnNpemUpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoNSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0F1ZGlvUGFyc2VyIC0gRm9ybWF0IFN1cHBvcnQnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBhdWRpbyBibG9ja3MgZm9yIHN1cHBvcnRlZCBmb3JtYXRzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBhdWRpb1VybHMgPSBbXHJcbiAgICAgICAgJ2h0dHBzOi8vZXhhbXBsZS5jb20vYXVkaW8ubXAzJyxcclxuICAgICAgICAnaHR0cHM6Ly9leGFtcGxlLmNvbS9hdWRpby53YXYnLFxyXG4gICAgICAgICdodHRwczovL3NvdW5kY2xvdWQuY29tL3RyYWNrLzEyMycsXHJcbiAgICAgICAgJ2h0dHBzOi8vc3BvdGlmeS5jb20vdHJhY2svNDU2J1xyXG4gICAgICBdO1xyXG4gICAgICBcclxuICAgICAgbGV0IGF1ZGlvQmxvY2tzQ3JlYXRlZCA9IDA7XHJcbiAgICAgIFxyXG4gICAgICBhdWRpb1VybHMuZm9yRWFjaCh1cmwgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHBhcnNlQ29udGVudCh1cmwsIHsgY29udGVudFR5cGU6ICdhdWRpbycgfSk7XHJcbiAgICAgICAgY29uc3QgYmxvY2tzID0gcmVzdWx0LmJsb2NrcyBhcyBUZXN0QmxvY2tbXTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBhdWRpb0Jsb2NrcyA9IGJsb2Nrcy5maWx0ZXIoKGI6IFRlc3RCbG9jaykgPT4gYi50eXBlID09PSAnYXVkaW8nKTtcclxuICAgICAgICBhdWRpb0Jsb2Nrc0NyZWF0ZWQgKz0gYXVkaW9CbG9ja3MubGVuZ3RoO1xyXG4gICAgICB9KTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChhdWRpb0Jsb2Nrc0NyZWF0ZWQpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHZhbGlkYXRlIGF1ZGlvIFVSTCBmb3JtYXRzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBzdXBwb3J0ZWRGb3JtYXRzID0gWydtcDMnLCAnd2F2JywgJ29nZycsICdtNGEnLCAnYWFjJywgJ2ZsYWMnLCAnd2VibSddO1xyXG4gICAgICBjb25zdCB0ZXN0VXJscyA9IHN1cHBvcnRlZEZvcm1hdHMubWFwKGZvcm1hdCA9PiBgaHR0cHM6Ly9leGFtcGxlLmNvbS9hdWRpby4ke2Zvcm1hdH1gKTtcclxuICAgICAgXHJcbiAgICAgIGxldCB2YWxpZEZvcm1hdHMgPSAwO1xyXG4gICAgICBcclxuICAgICAgdGVzdFVybHMuZm9yRWFjaCh1cmwgPT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBjb25zdCByZXN1bHQgPSBwYXJzZUNvbnRlbnQodXJsLCB7IGNvbnRlbnRUeXBlOiAnYXVkaW8nIH0pO1xyXG4gICAgICAgICAgY29uc3QgYmxvY2tzID0gcmVzdWx0LmJsb2NrcyBhcyBUZXN0QmxvY2tbXTtcclxuICAgICAgICAgIFxyXG4gICAgICAgICAgaWYgKGJsb2Nrcy5zb21lKGIgPT4gYi50eXBlID09PSAnYXVkaW8nKSkge1xyXG4gICAgICAgICAgICB2YWxpZEZvcm1hdHMrKztcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgLy8gRm9ybWF0IG5vbiBzdXBwb3J0w6lcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KHZhbGlkRm9ybWF0cykudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCg1KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnVGFibGVQYXJzZXIgLSBIZWFkZXIgRGV0ZWN0aW9uJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBhdXRvbWF0aWNhbGx5IGRldGVjdCBDU1YgaGVhZGVycycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgY3N2V2l0aEhlYWRlcnMgPSBgTmFtZSxBZ2UsQ2l0eVxyXG5Kb2huLDMwLFBhcmlzXHJcbkphbmUsMjUsTG9uZG9uYDtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHBhcnNlQ29udGVudChjc3ZXaXRoSGVhZGVycywgeyBjb250ZW50VHlwZTogJ2NzdicgfSk7XHJcbiAgICAgIGNvbnN0IGJsb2NrcyA9IHJlc3VsdC5ibG9ja3MgYXMgVGVzdEJsb2NrW107XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCB0YWJsZUJsb2NrID0gYmxvY2tzLmZpbmQoKGI6IFRlc3RCbG9jaykgPT4gYi50eXBlID09PSAndGFibGUnKTtcclxuICAgICAgZXhwZWN0KHRhYmxlQmxvY2s/LnRhYmxlPy5oYXNfY29sdW1uX2hlYWRlcikudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgZGV0ZWN0IHJvdyBoZWFkZXJzIHdoZW4gYXBwcm9wcmlhdGUnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNzdldpdGhSb3dIZWFkZXJzID0gYENhdGVnb3J5LFExLFEyLFEzLFE0XHJcblNhbGVzLDEwMCwxMjAsMTEwLDEzMFxyXG5NYXJrZXRpbmcsNTAsNjAsNTUsNjVcclxuU3VwcG9ydCwzMCwzNSwzMiwzOGA7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCByZXN1bHQgPSBwYXJzZUNvbnRlbnQoY3N2V2l0aFJvd0hlYWRlcnMsIHsgY29udGVudFR5cGU6ICdjc3YnIH0pO1xyXG4gICAgICBjb25zdCBibG9ja3MgPSByZXN1bHQuYmxvY2tzIGFzIFRlc3RCbG9ja1tdO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgdGFibGVCbG9jayA9IGJsb2Nrcy5maW5kKChiOiBUZXN0QmxvY2spID0+IGIudHlwZSA9PT0gJ3RhYmxlJyk7XHJcbiAgICAgIC8vIFJvdyBoZWFkZXJzIGRldGVjdGlvbiBtaWdodCBiZSBpbXBsZW1lbnRlZFxyXG4gICAgICBleHBlY3QodGFibGVCbG9jaz8udGFibGUpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtYXJrZG93biB0YWJsZXMgd2l0aCBzZXBhcmF0b3JzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtYXJrZG93blRhYmxlID0gYHwgUHJvZHVjdCB8IFByaWNlIHwgU3RvY2sgfFxyXG58LS0tLS0tLS0tfC0tLS0tLS18LS0tLS0tLXxcclxufCBBcHBsZSAgIHwgJDEuMDAgfCA1MCAgICB8XHJcbnwgT3JhbmdlICB8ICQwLjgwIHwgMzAgICAgfGA7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCByZXN1bHQgPSBwYXJzZUNvbnRlbnQobWFya2Rvd25UYWJsZSwgeyBjb250ZW50VHlwZTogJ21hcmtkb3duJyB9KTtcclxuICAgICAgY29uc3QgYmxvY2tzID0gcmVzdWx0LmJsb2NrcyBhcyBUZXN0QmxvY2tbXTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHRhYmxlQmxvY2sgPSBibG9ja3MuZmluZCgoYjogVGVzdEJsb2NrKSA9PiBiLnR5cGUgPT09ICd0YWJsZScpO1xyXG4gICAgICBleHBlY3QodGFibGVCbG9jaz8udGFibGU/Lmhhc19jb2x1bW5faGVhZGVyKS50b0JlKHRydWUpO1xyXG4gICAgICBleHBlY3QodGFibGVCbG9jaz8udGFibGU/LnRhYmxlX3dpZHRoKS50b0JlKDMpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdUb2dnbGUgSGVhZGluZ3MnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSB0b2dnbGUgaGVhZGluZ3Mgd2l0aCBjaGlsZHJlbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgY29udGVudCA9IGA+ICMgVG9nZ2xlIEhlYWRpbmcgMVxyXG4+IENvbnRlbnQgdW5kZXIgdG9nZ2xlXHJcblxyXG4+ICMjIFRvZ2dsZSBIZWFkaW5nIDIgIFxyXG4+IE1vcmUgY29udGVudGA7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCByZXN1bHQgPSBwYXJzZUNvbnRlbnQoY29udGVudCwgeyBjb250ZW50VHlwZTogJ21hcmtkb3duJyB9KTtcclxuICAgICAgY29uc3QgYmxvY2tzID0gcmVzdWx0LmJsb2NrcyBhcyBUZXN0QmxvY2tbXTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHRvZ2dsZUhlYWRpbmdzID0gYmxvY2tzLmZpbHRlcigoYjogVGVzdEJsb2NrKSA9PiBcclxuICAgICAgICAoYi50eXBlID09PSAnaGVhZGluZ18xJyB8fCBiLnR5cGUgPT09ICdoZWFkaW5nXzInKSAmJiBcclxuICAgICAgICAoYi5oZWFkaW5nXzE/LmlzX3RvZ2dsZWFibGUgfHwgYi5oZWFkaW5nXzI/LmlzX3RvZ2dsZWFibGUgfHwgYi5jaGlsZHJlbj8ubGVuZ3RoID4gMClcclxuICAgICAgKTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdCh0b2dnbGVIZWFkaW5ncy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHByb3Blcmx5IG5lc3QgY29udGVudCB1bmRlciB0b2dnbGUgaGVhZGluZ3MnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBgPiAjIFRvZ2dsZSBIZWFkaW5nXHJcbj4gVGhpcyBpcyBjb250ZW50IHVuZGVyIHRoZSB0b2dnbGVcclxuPiAtIExpc3QgaXRlbSAxXHJcbj4gLSBMaXN0IGl0ZW0gMlxyXG4+IFxyXG4+IE1vcmUgY29udGVudGA7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCByZXN1bHQgPSBwYXJzZUNvbnRlbnQoY29udGVudCwgeyBjb250ZW50VHlwZTogJ21hcmtkb3duJyB9KTtcclxuICAgICAgY29uc3QgYmxvY2tzID0gcmVzdWx0LmJsb2NrcyBhcyBUZXN0QmxvY2tbXTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHRvZ2dsZUhlYWRpbmcgPSBibG9ja3MuZmluZCgoYjogVGVzdEJsb2NrKSA9PiBcclxuICAgICAgICBiLnR5cGUgPT09ICdoZWFkaW5nXzEnICYmIFxyXG4gICAgICAgIChiLmhlYWRpbmdfMT8uaXNfdG9nZ2xlYWJsZSB8fCBiLmNoaWxkcmVuPy5sZW5ndGggPiAwKVxyXG4gICAgICApO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KHRvZ2dsZUhlYWRpbmcpLnRvQmVEZWZpbmVkKCk7XHJcbiAgICAgIGlmICh0b2dnbGVIZWFkaW5nPy5jaGlsZHJlbikge1xyXG4gICAgICAgIGV4cGVjdCh0b2dnbGVIZWFkaW5nLmNoaWxkcmVuLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7Il0sInZlcnNpb24iOjN9