1c53f8be8b90975f0bedbe53c4d851f5
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RichTextConverter = void 0;
class RichTextConverter {
    parseRichText(text, options) {
        if (!text)
            return [];
        // Traiter les échappements d'abord
        const processedText = this.processEscapes(text);
        // Nouvelle approche: tokenisation puis reconstruction
        const tokens = this.tokenizeText(processedText, options);
        return this.tokensToRichText(tokens, processedText);
    }
    processEscapes(text) {
        // Remplacer les échappements par des placeholders temporaires
        const escapeMap = new Map();
        let counter = 0;
        // Traiter les échappements de caractères spéciaux
        const escapedChars = ['*', '_', '`', '~', '[', ']', '(', ')', '$'];
        let result = text;
        escapedChars.forEach(char => {
            const escapedPattern = new RegExp(`\\\\\\${char}`, 'g');
            result = result.replace(escapedPattern, () => {
                const placeholder = `§ESC${counter++}§`;
                escapeMap.set(placeholder, char);
                return placeholder;
            });
        });
        // Stocker la map pour la restauration
        this._escapeMap = escapeMap;
        return result;
    }
    restoreEscapes(text) {
        const escapeMap = this._escapeMap;
        if (!escapeMap)
            return text;
        let result = text;
        escapeMap.forEach((char, placeholder) => {
            result = result.replace(new RegExp(placeholder, 'g'), char);
        });
        return result;
    }
    tokenizeText(text, options) {
        // Définir tous les patterns avec leurs priorités
        const patterns = [
            // Équations (priorité la plus haute - pas d'imbrication)
            { regex: /\$([^$]+)\$/g, type: 'equation', priority: 1 },
            // Code inline (priorité haute - peut être imbriqué)
            { regex: /`([^`]+)`/g, type: 'code', priority: 2 },
            // Bold + Italic (***text***)
            { regex: /\*\*\*([^*]+)\*\*\*/g, type: 'bold-italic', priority: 4 },
            // Bold (**text**)
            { regex: /\*\*([^*]+)\*\*/g, type: 'bold', priority: 5 },
            // Underline (__text__)
            { regex: /__([^_]+)__/g, type: 'underline', priority: 6 },
            // Italic (*text* or _text_)
            { regex: /\*([^*]+)\*/g, type: 'italic', priority: 7 },
            { regex: /_([^_]+)_/g, type: 'italic', priority: 7 },
            // Strikethrough (~~text~~)
            { regex: /~~([^~]+)~~/g, type: 'strikethrough', priority: 8 }
        ];
        // Ajouter les patterns de liens seulement si convertLinks n'est pas false
        if (options?.convertLinks !== false) {
            patterns.push(
            // Links (priorité haute - peut contenir du formatage)
            { regex: /\[([^\]]+)\]\(([^)]+)\)/g, type: 'link', priority: 3 }, 
            // URLs auto-détectées (priorité haute)
            { regex: /(https?:\/\/[^\s<>"{}|\\^`[\]]+)/g, type: 'auto-link', priority: 3 });
        }
        // Trouver tous les matches avec leurs positions
        const allMatches = [];
        patterns.forEach(pattern => {
            let match;
            const regex = new RegExp(pattern.regex.source, 'g');
            while ((match = regex.exec(text)) !== null) {
                const start = match.index;
                const end = match.index + match[0].length;
                let content = match[1];
                let url;
                let expression;
                if (pattern.type === 'link') {
                    content = match[1];
                    url = match[2];
                }
                else if (pattern.type === 'auto-link') {
                    content = match[1];
                    url = match[1];
                }
                else if (pattern.type === 'equation') {
                    expression = match[1];
                    content = match[1];
                }
                else if (pattern.type === 'bold-italic') {
                    // Traiter comme bold ET italic
                    allMatches.push({
                        match,
                        type: 'bold',
                        priority: pattern.priority,
                        start,
                        end,
                        content
                    });
                    allMatches.push({
                        match,
                        type: 'italic',
                        priority: pattern.priority,
                        start,
                        end,
                        content
                    });
                    continue;
                }
                allMatches.push({
                    match,
                    type: pattern.type,
                    priority: pattern.priority,
                    start,
                    end,
                    content,
                    url,
                    expression
                });
            }
        });
        // Trier par position puis par priorité
        allMatches.sort((a, b) => {
            if (a.start !== b.start)
                return a.start - b.start;
            return a.priority - b.priority;
        });
        return allMatches.map(m => ({
            type: m.type,
            content: m.content,
            start: m.start,
            end: m.end,
            url: m.url,
            expression: m.expression
        }));
    }
    tokensToRichText(tokens, originalText) {
        if (tokens.length === 0) {
            return [{
                    type: 'text',
                    text: { content: this.restoreEscapes(originalText) }
                }];
        }
        const result = [];
        const segments = this.createSegments(tokens, originalText);
        segments.forEach(segment => {
            if (segment.type === 'equation') {
                result.push({
                    type: 'equation',
                    equation: { expression: segment.expression || segment.content }
                });
            }
            else {
                const annotations = {};
                // Appliquer toutes les annotations qui s'appliquent à ce segment
                if (segment.bold)
                    annotations.bold = true;
                if (segment.italic)
                    annotations.italic = true;
                if (segment.code)
                    annotations.code = true;
                if (segment.strikethrough)
                    annotations.strikethrough = true;
                if (segment.underline)
                    annotations.underline = true;
                const textContent = { content: segment.content };
                if (segment.link) {
                    textContent.link = { url: segment.link.url };
                }
                // Restaurer les échappements dans le contenu
                textContent.content = this.restoreEscapes(textContent.content);
                result.push({
                    type: 'text',
                    text: textContent,
                    annotations: Object.keys(annotations).length > 0 ? annotations : undefined,
                    href: segment.link ? segment.link.url : null
                });
            }
        });
        return result;
    }
    createSegments(tokens, originalText) {
        // Créer une liste de tous les points de changement
        const changePoints = new Set();
        changePoints.add(0);
        changePoints.add(originalText.length);
        tokens.forEach(token => {
            changePoints.add(token.start);
            changePoints.add(token.end);
        });
        const sortedPoints = Array.from(changePoints).sort((a, b) => a - b);
        const segments = [];
        // Créer des segments entre chaque point de changement
        for (let i = 0; i < sortedPoints.length - 1; i++) {
            const start = sortedPoints[i];
            const end = sortedPoints[i + 1];
            if (start === end)
                continue;
            const content = originalText.slice(start, end);
            if (!content)
                continue;
            // Déterminer quels tokens s'appliquent à ce segment
            const applicableTokens = tokens.filter(token => {
                // Un token s'applique si le segment est complètement à l'intérieur du token
                return token.start <= start && end <= token.end;
            });
            // Vérifier si c'est une équation (priorité absolue)
            const equationToken = applicableTokens.find(t => t.type === 'equation');
            if (equationToken) {
                segments.push({
                    content: equationToken.content,
                    start,
                    end,
                    type: 'equation',
                    expression: equationToken.expression
                });
                continue;
            }
            // Construire les annotations pour ce segment
            const segment = {
                content,
                start,
                end,
                type: 'text'
            };
            applicableTokens.forEach(token => {
                switch (token.type) {
                    case 'bold':
                        segment.bold = true;
                        break;
                    case 'italic':
                        segment.italic = true;
                        break;
                    case 'code':
                        segment.code = true;
                        break;
                    case 'strikethrough':
                        segment.strikethrough = true;
                        break;
                    case 'underline':
                        segment.underline = true;
                        break;
                    case 'link':
                    case 'auto-link':
                        segment.link = { url: token.url };
                        break;
                }
            });
            segments.push(segment);
        }
        // Filtrer les segments vides et fusionner les segments adjacents identiques
        return this.mergeAdjacentSegments(segments.filter(s => s.content.trim() || s.type === 'equation'));
    }
    mergeAdjacentSegments(segments) {
        if (segments.length <= 1)
            return segments;
        const merged = [];
        let current = { ...segments[0] };
        for (let i = 1; i < segments.length; i++) {
            const next = segments[i];
            // Vérifier si les segments peuvent être fusionnés
            if (this.canMergeSegments(current, next)) {
                current.content += next.content;
                current.end = next.end;
            }
            else {
                merged.push(current);
                current = { ...next };
            }
        }
        merged.push(current);
        return merged;
    }
    canMergeSegments(a, b) {
        if (a.type !== b.type)
            return false;
        if (a.type === 'equation')
            return false; // Ne jamais fusionner les équations
        // Comparer toutes les propriétés de formatage
        return a.bold === b.bold &&
            a.italic === b.italic &&
            a.code === b.code &&
            a.strikethrough === b.strikethrough &&
            a.underline === b.underline &&
            JSON.stringify(a.link) === JSON.stringify(b.link);
    }
    /**
     * Convertit du texte simple en rich text
     */
    createSimpleRichText(content) {
        return [{
                type: 'text',
                text: { content }
            }];
    }
    /**
     * Crée un rich text avec formatage spécifique
     */
    createFormattedRichText(content, formatting = {}) {
        return [{
                type: 'text',
                text: { content },
                annotations: formatting
            }];
    }
    /**
     * Crée un rich text avec lien
     */
    createLinkRichText(content, url) {
        return [{
                type: 'text',
                text: {
                    content,
                    link: { url }
                }
            }];
    }
    /**
     * Crée un rich text équation
     */
    createEquationRichText(expression) {
        return [{
                type: 'equation',
                equation: { expression }
            }];
    }
    /**
     * Combine plusieurs rich text arrays
     */
    combineRichText(...richTexts) {
        return richTexts.flat();
    }
    /**
     * Tronque le rich text si nécessaire
     */
    truncateRichText(richText, maxLength) {
        let currentLength = 0;
        const result = [];
        for (const item of richText) {
            const content = item.type === 'text'
                ? item.text?.content || ''
                : item.type === 'equation'
                    ? item.equation?.expression || ''
                    : '';
            if (currentLength + content.length <= maxLength) {
                result.push(item);
                currentLength += content.length;
            }
            else {
                const remainingLength = maxLength - currentLength;
                if (remainingLength > 10) {
                    const truncatedContent = content.substring(0, remainingLength - 10) + '...';
                    if (item.type === 'text') {
                        result.push({
                            ...item,
                            text: {
                                ...item.text,
                                content: truncatedContent
                            }
                        });
                    }
                    else if (item.type === 'equation') {
                        result.push({
                            type: 'text',
                            text: { content: truncatedContent }
                        });
                    }
                }
                break;
            }
        }
        return result;
    }
}
exports.RichTextConverter = RichTextConverter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxyYXlhblxcRGVza3RvcFxcRGV2XFxOb3Rpb25DbGlwcGVyXFxwYWNrYWdlc1xcbm90aW9uLXBhcnNlclxcc3JjXFxjb252ZXJ0ZXJzXFxSaWNoVGV4dENvbnZlcnRlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFhQSxNQUFhLGlCQUFpQjtJQUM1QixhQUFhLENBQUMsSUFBWSxFQUFFLE9BQW9DO1FBQzlELElBQUksQ0FBQyxJQUFJO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFFckIsbUNBQW1DO1FBQ25DLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFaEQsc0RBQXNEO1FBQ3RELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3pELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxhQUFhLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRU8sY0FBYyxDQUFDLElBQVk7UUFDakMsOERBQThEO1FBQzlELE1BQU0sU0FBUyxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBQzVDLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztRQUVoQixrREFBa0Q7UUFDbEQsTUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRW5FLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQztRQUVsQixZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzFCLE1BQU0sY0FBYyxHQUFHLElBQUksTUFBTSxDQUFDLFNBQVMsSUFBSSxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDeEQsTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtnQkFDM0MsTUFBTSxXQUFXLEdB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QUFFO2dDQUNKLEdBQUcsSUFBSSxDQUFDLElBQUk7Z0NBQ1osT0FBTyxFQUFFLGdCQUFnQjs2QkFDMUI7eUJBQ0YsQ0FBQyxDQUFDO29CQUNMLENBQUM7eUJBQU0sSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFVBQVUsRUFBRSxDQUFDO3dCQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDOzRCQUNWLElBQUksRUFBRSxNQUFNOzRCQUNaLElBQUksRUFBRSxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRTt5QkFDcEMsQ0FBQyxDQUFDO29CQUNMLENBQUM7Z0JBQ0gsQ0FBQztnQkFDRCxNQUFNO1lBQ1IsQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0NBQ0Y7QUFqZEQsOENBaWRDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xccmF5YW5cXERlc2t0b3BcXERldlxcTm90aW9uQ2xpcHBlclxccGFja2FnZXNcXG5vdGlvbi1wYXJzZXJcXHNyY1xcY29udmVydGVyc1xcUmljaFRleHRDb252ZXJ0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBOb3Rpb25SaWNoVGV4dCwgTm90aW9uQ29sb3IgfSBmcm9tICcuLi90eXBlcyc7XHJcblxyXG5pbnRlcmZhY2UgVGV4dFRva2VuIHtcclxuICB0eXBlOiAndGV4dCcgfCAnYm9sZCcgfCAnaXRhbGljJyB8ICdjb2RlJyB8ICdzdHJpa2V0aHJvdWdoJyB8ICd1bmRlcmxpbmUnIHwgJ2xpbmsnIHwgJ2F1dG8tbGluaycgfCAnZXF1YXRpb24nIHwgJ2JvbGQtaXRhbGljJztcclxuICBjb250ZW50OiBzdHJpbmc7XHJcbiAgc3RhcnQ6IG51bWJlcjtcclxuICBlbmQ6IG51bWJlcjtcclxuICB1cmw/OiBzdHJpbmc7XHJcbiAgZXhwcmVzc2lvbj86IHN0cmluZztcclxufVxyXG5cclxuXHJcblxyXG5leHBvcnQgY2xhc3MgUmljaFRleHRDb252ZXJ0ZXIge1xyXG4gIHBhcnNlUmljaFRleHQodGV4dDogc3RyaW5nLCBvcHRpb25zPzogeyBjb252ZXJ0TGlua3M/OiBib29sZWFuIH0pOiBOb3Rpb25SaWNoVGV4dFtdIHtcclxuICAgIGlmICghdGV4dCkgcmV0dXJuIFtdO1xyXG5cclxuICAgIC8vIFRyYWl0ZXIgbGVzIMOpY2hhcHBlbWVudHMgZCdhYm9yZFxyXG4gICAgY29uc3QgcHJvY2Vzc2VkVGV4dCA9IHRoaXMucHJvY2Vzc0VzY2FwZXModGV4dCk7XHJcblxyXG4gICAgLy8gTm91dmVsbGUgYXBwcm9jaGU6IHRva2VuaXNhdGlvbiBwdWlzIHJlY29uc3RydWN0aW9uXHJcbiAgICBjb25zdCB0b2tlbnMgPSB0aGlzLnRva2VuaXplVGV4dChwcm9jZXNzZWRUZXh0LCBvcHRpb25zKTtcclxuICAgIHJldHVybiB0aGlzLnRva2Vuc1RvUmljaFRleHQodG9rZW5zLCBwcm9jZXNzZWRUZXh0KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcHJvY2Vzc0VzY2FwZXModGV4dDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIC8vIFJlbXBsYWNlciBsZXMgw6ljaGFwcGVtZW50cyBwYXIgZGVzIHBsYWNlaG9sZGVycyB0ZW1wb3JhaXJlc1xyXG4gICAgY29uc3QgZXNjYXBlTWFwID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcclxuICAgIGxldCBjb3VudGVyID0gMDtcclxuXHJcbiAgICAvLyBUcmFpdGVyIGxlcyDDqWNoYXBwZW1lbnRzIGRlIGNhcmFjdMOocmVzIHNww6ljaWF1eFxyXG4gICAgY29uc3QgZXNjYXBlZENoYXJzID0gWycqJywgJ18nLCAnYCcsICd+JywgJ1snLCAnXScsICcoJywgJyknLCAnJCddO1xyXG5cclxuICAgIGxldCByZXN1bHQgPSB0ZXh0O1xyXG5cclxuICAgIGVzY2FwZWRDaGFycy5mb3JFYWNoKGNoYXIgPT4ge1xyXG4gICAgICBjb25zdCBlc2NhcGVkUGF0dGVybiA9IG5ldyBSZWdFeHAoYFxcXFxcXFxcXFxcXCR7Y2hhcn1gLCAnZycpO1xyXG4gICAgICByZXN1bHQgPSByZXN1bHQucmVwbGFjZShlc2NhcGVkUGF0dGVybiwgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyID0gYMKnRVNDJHtjb3VudGVyKyt9wqdgO1xyXG4gICAgICAgIGVzY2FwZU1hcC5zZXQocGxhY2Vob2xkZXIsIGNoYXIpO1xyXG4gICAgICAgIHJldHVybiBwbGFjZWhvbGRlcjtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBTdG9ja2VyIGxhIG1hcCBwb3VyIGxhIHJlc3RhdXJhdGlvblxyXG4gICAgKHRoaXMgYXMgYW55KS5fZXNjYXBlTWFwID0gZXNjYXBlTWFwO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlc3RvcmVFc2NhcGVzKHRleHQ6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBlc2NhcGVNYXAgPSAodGhpcyBhcyBhbnkpLl9lc2NhcGVNYXAgYXMgTWFwPHN0cmluZywgc3RyaW5nPjtcclxuICAgIGlmICghZXNjYXBlTWFwKSByZXR1cm4gdGV4dDtcclxuXHJcbiAgICBsZXQgcmVzdWx0ID0gdGV4dDtcclxuICAgIGVzY2FwZU1hcC5mb3JFYWNoKChjaGFyLCBwbGFjZWhvbGRlcikgPT4ge1xyXG4gICAgICByZXN1bHQgPSByZXN1bHQucmVwbGFjZShuZXcgUmVnRXhwKHBsYWNlaG9sZGVyLCAnZycpLCBjaGFyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRva2VuaXplVGV4dCh0ZXh0OiBzdHJpbmcsIG9wdGlvbnM/OiB7IGNvbnZlcnRMaW5rcz86IGJvb2xlYW4gfSk6IFRleHRUb2tlbltdIHtcclxuXHJcbiAgICAvLyBEw6lmaW5pciB0b3VzIGxlcyBwYXR0ZXJucyBhdmVjIGxldXJzIHByaW9yaXTDqXNcclxuICAgIGNvbnN0IHBhdHRlcm5zOiBBcnJheTx7IHJlZ2V4OiBSZWdFeHA7IHR5cGU6IFRleHRUb2tlblsndHlwZSddOyBwcmlvcml0eTogbnVtYmVyIH0+ID0gW1xyXG4gICAgICAvLyDDiXF1YXRpb25zIChwcmlvcml0w6kgbGEgcGx1cyBoYXV0ZSAtIHBhcyBkJ2ltYnJpY2F0aW9uKVxyXG4gICAgICB7IHJlZ2V4OiAvXFwkKFteJF0rKVxcJC9nLCB0eXBlOiAnZXF1YXRpb24nLCBwcmlvcml0eTogMSB9LFxyXG5cclxuICAgICAgLy8gQ29kZSBpbmxpbmUgKHByaW9yaXTDqSBoYXV0ZSAtIHBldXQgw6p0cmUgaW1icmlxdcOpKVxyXG4gICAgICB7IHJlZ2V4OiAvYChbXmBdKylgL2csIHR5cGU6ICdjb2RlJywgcHJpb3JpdHk6IDIgfSxcclxuXHJcbiAgICAgIC8vIEJvbGQgKyBJdGFsaWMgKCoqKnRleHQqKiopXHJcbiAgICAgIHsgcmVnZXg6IC9cXCpcXCpcXCooW14qXSspXFwqXFwqXFwqL2csIHR5cGU6ICdib2xkLWl0YWxpYycsIHByaW9yaXR5OiA0IH0sXHJcblxyXG4gICAgICAvLyBCb2xkICgqKnRleHQqKilcclxuICAgICAgeyByZWdleDogL1xcKlxcKihbXipdKylcXCpcXCovZywgdHlwZTogJ2JvbGQnLCBwcmlvcml0eTogNSB9LFxyXG5cclxuICAgICAgLy8gVW5kZXJsaW5lIChfX3RleHRfXylcclxuICAgICAgeyByZWdleDogL19fKFteX10rKV9fL2csIHR5cGU6ICd1bmRlcmxpbmUnLCBwcmlvcml0eTogNiB9LFxyXG5cclxuICAgICAgLy8gSXRhbGljICgqdGV4dCogb3IgX3RleHRfKVxyXG4gICAgICB7IHJlZ2V4OiAvXFwqKFteKl0rKVxcKi9nLCB0eXBlOiAnaXRhbGljJywgcHJpb3JpdHk6IDcgfSxcclxuICAgICAgeyByZWdleDogL18oW15fXSspXy9nLCB0eXBlOiAnaXRhbGljJywgcHJpb3JpdHk6IDcgfSxcclxuXHJcbiAgICAgIC8vIFN0cmlrZXRocm91Z2ggKH5+dGV4dH5+KVxyXG4gICAgICB7IHJlZ2V4OiAvfn4oW15+XSspfn4vZywgdHlwZTogJ3N0cmlrZXRocm91Z2gnLCBwcmlvcml0eTogOCB9XHJcbiAgICBdO1xyXG5cclxuICAgIC8vIEFqb3V0ZXIgbGVzIHBhdHRlcm5zIGRlIGxpZW5zIHNldWxlbWVudCBzaSBjb252ZXJ0TGlua3Mgbidlc3QgcGFzIGZhbHNlXHJcbiAgICBpZiAob3B0aW9ucz8uY29udmVydExpbmtzICE9PSBmYWxzZSkge1xyXG4gICAgICBwYXR0ZXJucy5wdXNoKFxyXG4gICAgICAgIC8vIExpbmtzIChwcmlvcml0w6kgaGF1dGUgLSBwZXV0IGNvbnRlbmlyIGR1IGZvcm1hdGFnZSlcclxuICAgICAgICB7IHJlZ2V4OiAvXFxbKFteXFxdXSspXFxdXFwoKFteKV0rKVxcKS9nLCB0eXBlOiAnbGluaycsIHByaW9yaXR5OiAzIH0sXHJcblxyXG4gICAgICAgIC8vIFVSTHMgYXV0by1kw6l0ZWN0w6llcyAocHJpb3JpdMOpIGhhdXRlKVxyXG4gICAgICAgIHsgcmVnZXg6IC8oaHR0cHM/OlxcL1xcL1teXFxzPD5cInt9fFxcXFxeYFtcXF1dKykvZywgdHlwZTogJ2F1dG8tbGluaycsIHByaW9yaXR5OiAzIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBUcm91dmVyIHRvdXMgbGVzIG1hdGNoZXMgYXZlYyBsZXVycyBwb3NpdGlvbnNcclxuICAgIGNvbnN0IGFsbE1hdGNoZXM6IEFycmF5PHtcclxuICAgICAgbWF0Y2g6IFJlZ0V4cEV4ZWNBcnJheTtcclxuICAgICAgdHlwZTogc3RyaW5nO1xyXG4gICAgICBwcmlvcml0eTogbnVtYmVyO1xyXG4gICAgICBzdGFydDogbnVtYmVyO1xyXG4gICAgICBlbmQ6IG51bWJlcjtcclxuICAgICAgY29udGVudDogc3RyaW5nO1xyXG4gICAgICB1cmw/OiBzdHJpbmc7XHJcbiAgICAgIGV4cHJlc3Npb24/OiBzdHJpbmc7XHJcbiAgICB9PiA9IFtdO1xyXG5cclxuICAgIHBhdHRlcm5zLmZvckVhY2gocGF0dGVybiA9PiB7XHJcbiAgICAgIGxldCBtYXRjaDtcclxuICAgICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHBhdHRlcm4ucmVnZXguc291cmNlLCAnZycpO1xyXG5cclxuICAgICAgd2hpbGUgKChtYXRjaCA9IHJlZ2V4LmV4ZWModGV4dCkpICE9PSBudWxsKSB7XHJcbiAgICAgICAgY29uc3Qgc3RhcnQgPSBtYXRjaC5pbmRleDtcclxuICAgICAgICBjb25zdCBlbmQgPSBtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aDtcclxuXHJcbiAgICAgICAgbGV0IGNvbnRlbnQgPSBtYXRjaFsxXTtcclxuICAgICAgICBsZXQgdXJsOiBzdHJpbmcgfCB1bmRlZmluZWQ7XHJcbiAgICAgICAgbGV0IGV4cHJlc3Npb246IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuXHJcbiAgICAgICAgaWYgKHBhdHRlcm4udHlwZSA9PT0gJ2xpbmsnKSB7XHJcbiAgICAgICAgICBjb250ZW50ID0gbWF0Y2hbMV07XHJcbiAgICAgICAgICB1cmwgPSBtYXRjaFsyXTtcclxuICAgICAgICB9IGVsc2UgaWYgKHBhdHRlcm4udHlwZSA9PT0gJ2F1dG8tbGluaycpIHtcclxuICAgICAgICAgIGNvbnRlbnQgPSBtYXRjaFsxXTtcclxuICAgICAgICAgIHVybCA9IG1hdGNoWzFdO1xyXG4gICAgICAgIH0gZWxzZSBpZiAocGF0dGVybi50eXBlID09PSAnZXF1YXRpb24nKSB7XHJcbiAgICAgICAgICBleHByZXNzaW9uID0gbWF0Y2hbMV07XHJcbiAgICAgICAgICBjb250ZW50ID0gbWF0Y2hbMV07XHJcbiAgICAgICAgfSBlbHNlIGlmIChwYXR0ZXJuLnR5cGUgPT09ICdib2xkLWl0YWxpYycpIHtcclxuICAgICAgICAgIC8vIFRyYWl0ZXIgY29tbWUgYm9sZCBFVCBpdGFsaWNcclxuICAgICAgICAgIGFsbE1hdGNoZXMucHVzaCh7XHJcbiAgICAgICAgICAgIG1hdGNoLFxyXG4gICAgICAgICAgICB0eXBlOiAnYm9sZCcsXHJcbiAgICAgICAgICAgIHByaW9yaXR5OiBwYXR0ZXJuLnByaW9yaXR5LFxyXG4gICAgICAgICAgICBzdGFydCxcclxuICAgICAgICAgICAgZW5kLFxyXG4gICAgICAgICAgICBjb250ZW50XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIGFsbE1hdGNoZXMucHVzaCh7XHJcbiAgICAgICAgICAgIG1hdGNoLFxyXG4gICAgICAgICAgICB0eXBlOiAnaXRhbGljJyxcclxuICAgICAgICAgICAgcHJpb3JpdHk6IHBhdHRlcm4ucHJpb3JpdHksXHJcbiAgICAgICAgICAgIHN0YXJ0LFxyXG4gICAgICAgICAgICBlbmQsXHJcbiAgICAgICAgICAgIGNvbnRlbnRcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBhbGxNYXRjaGVzLnB1c2goe1xyXG4gICAgICAgICAgbWF0Y2gsXHJcbiAgICAgICAgICB0eXBlOiBwYXR0ZXJuLnR5cGUsXHJcbiAgICAgICAgICBwcmlvcml0eTogcGF0dGVybi5wcmlvcml0eSxcclxuICAgICAgICAgIHN0YXJ0LFxyXG4gICAgICAgICAgZW5kLFxyXG4gICAgICAgICAgY29udGVudCxcclxuICAgICAgICAgIHVybCxcclxuICAgICAgICAgIGV4cHJlc3Npb25cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gVHJpZXIgcGFyIHBvc2l0aW9uIHB1aXMgcGFyIHByaW9yaXTDqVxyXG4gICAgYWxsTWF0Y2hlcy5zb3J0KChhLCBiKSA9PiB7XHJcbiAgICAgIGlmIChhLnN0YXJ0ICE9PSBiLnN0YXJ0KSByZXR1cm4gYS5zdGFydCAtIGIuc3RhcnQ7XHJcbiAgICAgIHJldHVybiBhLnByaW9yaXR5IC0gYi5wcmlvcml0eTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBhbGxNYXRjaGVzLm1hcChtID0+ICh7XHJcbiAgICAgIHR5cGU6IG0udHlwZSBhcyBUZXh0VG9rZW5bJ3R5cGUnXSxcclxuICAgICAgY29udGVudDogbS5jb250ZW50LFxyXG4gICAgICBzdGFydDogbS5zdGFydCxcclxuICAgICAgZW5kOiBtLmVuZCxcclxuICAgICAgdXJsOiBtLnVybCxcclxuICAgICAgZXhwcmVzc2lvbjogbS5leHByZXNzaW9uXHJcbiAgICB9KSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRva2Vuc1RvUmljaFRleHQodG9rZW5zOiBUZXh0VG9rZW5bXSwgb3JpZ2luYWxUZXh0OiBzdHJpbmcpOiBOb3Rpb25SaWNoVGV4dFtdIHtcclxuICAgIGlmICh0b2tlbnMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBbe1xyXG4gICAgICAgIHR5cGU6ICd0ZXh0JyxcclxuICAgICAgICB0ZXh0OiB7IGNvbnRlbnQ6IHRoaXMucmVzdG9yZUVzY2FwZXMob3JpZ2luYWxUZXh0KSB9XHJcbiAgICAgIH1dO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJlc3VsdDogTm90aW9uUmljaFRleHRbXSA9IFtdO1xyXG4gICAgY29uc3Qgc2VnbWVudHMgPSB0aGlzLmNyZWF0ZVNlZ21lbnRzKHRva2Vucywgb3JpZ2luYWxUZXh0KTtcclxuXHJcbiAgICBzZWdtZW50cy5mb3JFYWNoKHNlZ21lbnQgPT4ge1xyXG4gICAgICBpZiAoc2VnbWVudC50eXBlID09PSAnZXF1YXRpb24nKSB7XHJcbiAgICAgICAgcmVzdWx0LnB1c2goe1xyXG4gICAgICAgICAgdHlwZTogJ2VxdWF0aW9uJyxcclxuICAgICAgICAgIGVxdWF0aW9uOiB7IGV4cHJlc3Npb246IHNlZ21lbnQuZXhwcmVzc2lvbiB8fCBzZWdtZW50LmNvbnRlbnQgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IGFubm90YXRpb25zOiBhbnkgPSB7fTtcclxuXHJcbiAgICAgICAgLy8gQXBwbGlxdWVyIHRvdXRlcyBsZXMgYW5ub3RhdGlvbnMgcXVpIHMnYXBwbGlxdWVudCDDoCBjZSBzZWdtZW50XHJcbiAgICAgICAgaWYgKHNlZ21lbnQuYm9sZCkgYW5ub3RhdGlvbnMuYm9sZCA9IHRydWU7XHJcbiAgICAgICAgaWYgKHNlZ21lbnQuaXRhbGljKSBhbm5vdGF0aW9ucy5pdGFsaWMgPSB0cnVlO1xyXG4gICAgICAgIGlmIChzZWdtZW50LmNvZGUpIGFubm90YXRpb25zLmNvZGUgPSB0cnVlO1xyXG4gICAgICAgIGlmIChzZWdtZW50LnN0cmlrZXRocm91Z2gpIGFubm90YXRpb25zLnN0cmlrZXRocm91Z2ggPSB0cnVlO1xyXG4gICAgICAgIGlmIChzZWdtZW50LnVuZGVybGluZSkgYW5ub3RhdGlvbnMudW5kZXJsaW5lID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgY29uc3QgdGV4dENvbnRlbnQ6IGFueSA9IHsgY29udGVudDogc2VnbWVudC5jb250ZW50IH07XHJcbiAgICAgICAgaWYgKHNlZ21lbnQubGluaykge1xyXG4gICAgICAgICAgdGV4dENvbnRlbnQubGluayA9IHsgdXJsOiBzZWdtZW50LmxpbmsudXJsIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBSZXN0YXVyZXIgbGVzIMOpY2hhcHBlbWVudHMgZGFucyBsZSBjb250ZW51XHJcbiAgICAgICAgdGV4dENvbnRlbnQuY29udGVudCA9IHRoaXMucmVzdG9yZUVzY2FwZXModGV4dENvbnRlbnQuY29udGVudCk7XHJcblxyXG4gICAgICAgIHJlc3VsdC5wdXNoKHtcclxuICAgICAgICAgIHR5cGU6ICd0ZXh0JyxcclxuICAgICAgICAgIHRleHQ6IHRleHRDb250ZW50LFxyXG4gICAgICAgICAgYW5ub3RhdGlvbnM6IE9iamVjdC5rZXlzKGFubm90YXRpb25zKS5sZW5ndGggPiAwID8gYW5ub3RhdGlvbnMgOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICBocmVmOiBzZWdtZW50LmxpbmsgPyBzZWdtZW50LmxpbmsudXJsIDogbnVsbFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjcmVhdGVTZWdtZW50cyh0b2tlbnM6IFRleHRUb2tlbltdLCBvcmlnaW5hbFRleHQ6IHN0cmluZyk6IEFycmF5PHtcclxuICAgIGNvbnRlbnQ6IHN0cmluZztcclxuICAgIHN0YXJ0OiBudW1iZXI7XHJcbiAgICBlbmQ6IG51bWJlcjtcclxuICAgIHR5cGU6ICd0ZXh0JyB8ICdlcXVhdGlvbic7XHJcbiAgICBib2xkPzogYm9vbGVhbjtcclxuICAgIGl0YWxpYz86IGJvb2xlYW47XHJcbiAgICBjb2RlPzogYm9vbGVhbjtcclxuICAgIHN0cmlrZXRocm91Z2g/OiBib29sZWFuO1xyXG4gICAgdW5kZXJsaW5lPzogYm9vbGVhbjtcclxuICAgIGxpbms/OiB7IHVybDogc3RyaW5nIH07XHJcbiAgICBleHByZXNzaW9uPzogc3RyaW5nO1xyXG4gIH0+IHtcclxuICAgIC8vIENyw6llciB1bmUgbGlzdGUgZGUgdG91cyBsZXMgcG9pbnRzIGRlIGNoYW5nZW1lbnRcclxuICAgIGNvbnN0IGNoYW5nZVBvaW50cyA9IG5ldyBTZXQ8bnVtYmVyPigpO1xyXG4gICAgY2hhbmdlUG9pbnRzLmFkZCgwKTtcclxuICAgIGNoYW5nZVBvaW50cy5hZGQob3JpZ2luYWxUZXh0Lmxlbmd0aCk7XHJcblxyXG4gICAgdG9rZW5zLmZvckVhY2godG9rZW4gPT4ge1xyXG4gICAgICBjaGFuZ2VQb2ludHMuYWRkKHRva2VuLnN0YXJ0KTtcclxuICAgICAgY2hhbmdlUG9pbnRzLmFkZCh0b2tlbi5lbmQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3Qgc29ydGVkUG9pbnRzID0gQXJyYXkuZnJvbShjaGFuZ2VQb2ludHMpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTtcclxuICAgIGNvbnN0IHNlZ21lbnRzOiBBcnJheTx7XHJcbiAgICAgIGNvbnRlbnQ6IHN0cmluZztcclxuICAgICAgc3RhcnQ6IG51bWJlcjtcclxuICAgICAgZW5kOiBudW1iZXI7XHJcbiAgICAgIHR5cGU6ICd0ZXh0JyB8ICdlcXVhdGlvbic7XHJcbiAgICAgIGJvbGQ/OiBib29sZWFuO1xyXG4gICAgICBpdGFsaWM/OiBib29sZWFuO1xyXG4gICAgICBjb2RlPzogYm9vbGVhbjtcclxuICAgICAgc3RyaWtldGhyb3VnaD86IGJvb2xlYW47XHJcbiAgICAgIHVuZGVybGluZT86IGJvb2xlYW47XHJcbiAgICAgIGxpbms/OiB7IHVybDogc3RyaW5nIH07XHJcbiAgICAgIGV4cHJlc3Npb24/OiBzdHJpbmc7XHJcbiAgICB9PiA9IFtdO1xyXG5cclxuICAgIC8vIENyw6llciBkZXMgc2VnbWVudHMgZW50cmUgY2hhcXVlIHBvaW50IGRlIGNoYW5nZW1lbnRcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc29ydGVkUG9pbnRzLmxlbmd0aCAtIDE7IGkrKykge1xyXG4gICAgICBjb25zdCBzdGFydCA9IHNvcnRlZFBvaW50c1tpXTtcclxuICAgICAgY29uc3QgZW5kID0gc29ydGVkUG9pbnRzW2kgKyAxXTtcclxuXHJcbiAgICAgIGlmIChzdGFydCA9PT0gZW5kKSBjb250aW51ZTtcclxuXHJcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBvcmlnaW5hbFRleHQuc2xpY2Uoc3RhcnQsIGVuZCk7XHJcbiAgICAgIGlmICghY29udGVudCkgY29udGludWU7XHJcblxyXG4gICAgICAvLyBEw6l0ZXJtaW5lciBxdWVscyB0b2tlbnMgcydhcHBsaXF1ZW50IMOgIGNlIHNlZ21lbnRcclxuICAgICAgY29uc3QgYXBwbGljYWJsZVRva2VucyA9IHRva2Vucy5maWx0ZXIodG9rZW4gPT4ge1xyXG4gICAgICAgIC8vIFVuIHRva2VuIHMnYXBwbGlxdWUgc2kgbGUgc2VnbWVudCBlc3QgY29tcGzDqHRlbWVudCDDoCBsJ2ludMOpcmlldXIgZHUgdG9rZW5cclxuICAgICAgICByZXR1cm4gdG9rZW4uc3RhcnQgPD0gc3RhcnQgJiYgZW5kIDw9IHRva2VuLmVuZDtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyBWw6lyaWZpZXIgc2kgYydlc3QgdW5lIMOpcXVhdGlvbiAocHJpb3JpdMOpIGFic29sdWUpXHJcbiAgICAgIGNvbnN0IGVxdWF0aW9uVG9rZW4gPSBhcHBsaWNhYmxlVG9rZW5zLmZpbmQodCA9PiB0LnR5cGUgPT09ICdlcXVhdGlvbicpO1xyXG4gICAgICBpZiAoZXF1YXRpb25Ub2tlbikge1xyXG4gICAgICAgIHNlZ21lbnRzLnB1c2goe1xyXG4gICAgICAgICAgY29udGVudDogZXF1YXRpb25Ub2tlbi5jb250ZW50LFxyXG4gICAgICAgICAgc3RhcnQsXHJcbiAgICAgICAgICBlbmQsXHJcbiAgICAgICAgICB0eXBlOiAnZXF1YXRpb24nLFxyXG4gICAgICAgICAgZXhwcmVzc2lvbjogZXF1YXRpb25Ub2tlbi5leHByZXNzaW9uXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIENvbnN0cnVpcmUgbGVzIGFubm90YXRpb25zIHBvdXIgY2Ugc2VnbWVudFxyXG4gICAgICBjb25zdCBzZWdtZW50OiBhbnkgPSB7XHJcbiAgICAgICAgY29udGVudCxcclxuICAgICAgICBzdGFydCxcclxuICAgICAgICBlbmQsXHJcbiAgICAgICAgdHlwZTogJ3RleHQnXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBhcHBsaWNhYmxlVG9rZW5zLmZvckVhY2godG9rZW4gPT4ge1xyXG4gICAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkge1xyXG4gICAgICAgICAgY2FzZSAnYm9sZCc6XHJcbiAgICAgICAgICAgIHNlZ21lbnQuYm9sZCA9IHRydWU7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgY2FzZSAnaXRhbGljJzpcclxuICAgICAgICAgICAgc2VnbWVudC5pdGFsaWMgPSB0cnVlO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGNhc2UgJ2NvZGUnOlxyXG4gICAgICAgICAgICBzZWdtZW50LmNvZGUgPSB0cnVlO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGNhc2UgJ3N0cmlrZXRocm91Z2gnOlxyXG4gICAgICAgICAgICBzZWdtZW50LnN0cmlrZXRocm91Z2ggPSB0cnVlO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGNhc2UgJ3VuZGVybGluZSc6XHJcbiAgICAgICAgICAgIHNlZ21lbnQudW5kZXJsaW5lID0gdHJ1ZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICBjYXNlICdsaW5rJzpcclxuICAgICAgICAgIGNhc2UgJ2F1dG8tbGluayc6XHJcbiAgICAgICAgICAgIHNlZ21lbnQubGluayA9IHsgdXJsOiB0b2tlbi51cmwhIH07XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICBzZWdtZW50cy5wdXNoKHNlZ21lbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEZpbHRyZXIgbGVzIHNlZ21lbnRzIHZpZGVzIGV0IGZ1c2lvbm5lciBsZXMgc2VnbWVudHMgYWRqYWNlbnRzIGlkZW50aXF1ZXNcclxuICAgIHJldHVybiB0aGlzLm1lcmdlQWRqYWNlbnRTZWdtZW50cyhzZWdtZW50cy5maWx0ZXIocyA9PiBzLmNvbnRlbnQudHJpbSgpIHx8IHMudHlwZSA9PT0gJ2VxdWF0aW9uJykpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBtZXJnZUFkamFjZW50U2VnbWVudHMoc2VnbWVudHM6IGFueVtdKTogYW55W10ge1xyXG4gICAgaWYgKHNlZ21lbnRzLmxlbmd0aCA8PSAxKSByZXR1cm4gc2VnbWVudHM7XHJcblxyXG4gICAgY29uc3QgbWVyZ2VkOiBhbnlbXSA9IFtdO1xyXG4gICAgbGV0IGN1cnJlbnQgPSB7IC4uLnNlZ21lbnRzWzBdIH07XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCBzZWdtZW50cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBjb25zdCBuZXh0ID0gc2VnbWVudHNbaV07XHJcblxyXG4gICAgICAvLyBWw6lyaWZpZXIgc2kgbGVzIHNlZ21lbnRzIHBldXZlbnQgw6p0cmUgZnVzaW9ubsOpc1xyXG4gICAgICBpZiAodGhpcy5jYW5NZXJnZVNlZ21lbnRzKGN1cnJlbnQsIG5leHQpKSB7XHJcbiAgICAgICAgY3VycmVudC5jb250ZW50ICs9IG5leHQuY29udGVudDtcclxuICAgICAgICBjdXJyZW50LmVuZCA9IG5leHQuZW5kO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1lcmdlZC5wdXNoKGN1cnJlbnQpO1xyXG4gICAgICAgIGN1cnJlbnQgPSB7IC4uLm5leHQgfTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG1lcmdlZC5wdXNoKGN1cnJlbnQpO1xyXG4gICAgcmV0dXJuIG1lcmdlZDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2FuTWVyZ2VTZWdtZW50cyhhOiBhbnksIGI6IGFueSk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKGEudHlwZSAhPT0gYi50eXBlKSByZXR1cm4gZmFsc2U7XHJcbiAgICBpZiAoYS50eXBlID09PSAnZXF1YXRpb24nKSByZXR1cm4gZmFsc2U7IC8vIE5lIGphbWFpcyBmdXNpb25uZXIgbGVzIMOpcXVhdGlvbnNcclxuXHJcbiAgICAvLyBDb21wYXJlciB0b3V0ZXMgbGVzIHByb3ByacOpdMOpcyBkZSBmb3JtYXRhZ2VcclxuICAgIHJldHVybiBhLmJvbGQgPT09IGIuYm9sZCAmJlxyXG4gICAgICBhLml0YWxpYyA9PT0gYi5pdGFsaWMgJiZcclxuICAgICAgYS5jb2RlID09PSBiLmNvZGUgJiZcclxuICAgICAgYS5zdHJpa2V0aHJvdWdoID09PSBiLnN0cmlrZXRocm91Z2ggJiZcclxuICAgICAgYS51bmRlcmxpbmUgPT09IGIudW5kZXJsaW5lICYmXHJcbiAgICAgIEpTT04uc3RyaW5naWZ5KGEubGluaykgPT09IEpTT04uc3RyaW5naWZ5KGIubGluayk7XHJcbiAgfVxyXG5cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIENvbnZlcnRpdCBkdSB0ZXh0ZSBzaW1wbGUgZW4gcmljaCB0ZXh0XHJcbiAgICovXHJcbiAgY3JlYXRlU2ltcGxlUmljaFRleHQoY29udGVudDogc3RyaW5nKTogTm90aW9uUmljaFRleHRbXSB7XHJcbiAgICByZXR1cm4gW3tcclxuICAgICAgdHlwZTogJ3RleHQnLFxyXG4gICAgICB0ZXh0OiB7IGNvbnRlbnQgfVxyXG4gICAgfV07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDcsOpZSB1biByaWNoIHRleHQgYXZlYyBmb3JtYXRhZ2Ugc3DDqWNpZmlxdWVcclxuICAgKi9cclxuICBjcmVhdGVGb3JtYXR0ZWRSaWNoVGV4dChcclxuICAgIGNvbnRlbnQ6IHN0cmluZyxcclxuICAgIGZvcm1hdHRpbmc6IHtcclxuICAgICAgYm9sZD86IGJvb2xlYW47XHJcbiAgICAgIGl0YWxpYz86IGJvb2xlYW47XHJcbiAgICAgIHN0cmlrZXRocm91Z2g/OiBib29sZWFuO1xyXG4gICAgICB1bmRlcmxpbmU/OiBib29sZWFuO1xyXG4gICAgICBjb2RlPzogYm9vbGVhbjtcclxuICAgICAgY29sb3I/OiBOb3Rpb25Db2xvcjtcclxuICAgIH0gPSB7fVxyXG4gICk6IE5vdGlvblJpY2hUZXh0W10ge1xyXG4gICAgcmV0dXJuIFt7XHJcbiAgICAgIHR5cGU6ICd0ZXh0JyxcclxuICAgICAgdGV4dDogeyBjb250ZW50IH0sXHJcbiAgICAgIGFubm90YXRpb25zOiBmb3JtYXR0aW5nXHJcbiAgICB9XTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyw6llIHVuIHJpY2ggdGV4dCBhdmVjIGxpZW5cclxuICAgKi9cclxuICBjcmVhdGVMaW5rUmljaFRleHQoY29udGVudDogc3RyaW5nLCB1cmw6IHN0cmluZyk6IE5vdGlvblJpY2hUZXh0W10ge1xyXG4gICAgcmV0dXJuIFt7XHJcbiAgICAgIHR5cGU6ICd0ZXh0JyxcclxuICAgICAgdGV4dDoge1xyXG4gICAgICAgIGNvbnRlbnQsXHJcbiAgICAgICAgbGluazogeyB1cmwgfVxyXG4gICAgICB9XHJcbiAgICB9XTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyw6llIHVuIHJpY2ggdGV4dCDDqXF1YXRpb25cclxuICAgKi9cclxuICBjcmVhdGVFcXVhdGlvblJpY2hUZXh0KGV4cHJlc3Npb246IHN0cmluZyk6IE5vdGlvblJpY2hUZXh0W10ge1xyXG4gICAgcmV0dXJuIFt7XHJcbiAgICAgIHR5cGU6ICdlcXVhdGlvbicsXHJcbiAgICAgIGVxdWF0aW9uOiB7IGV4cHJlc3Npb24gfVxyXG4gICAgfV07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDb21iaW5lIHBsdXNpZXVycyByaWNoIHRleHQgYXJyYXlzXHJcbiAgICovXHJcbiAgY29tYmluZVJpY2hUZXh0KC4uLnJpY2hUZXh0czogTm90aW9uUmljaFRleHRbXVtdKTogTm90aW9uUmljaFRleHRbXSB7XHJcbiAgICByZXR1cm4gcmljaFRleHRzLmZsYXQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRyb25xdWUgbGUgcmljaCB0ZXh0IHNpIG7DqWNlc3NhaXJlXHJcbiAgICovXHJcbiAgdHJ1bmNhdGVSaWNoVGV4dChyaWNoVGV4dDogTm90aW9uUmljaFRleHRbXSwgbWF4TGVuZ3RoOiBudW1iZXIpOiBOb3Rpb25SaWNoVGV4dFtdIHtcclxuICAgIGxldCBjdXJyZW50TGVuZ3RoID0gMDtcclxuICAgIGNvbnN0IHJlc3VsdDogTm90aW9uUmljaFRleHRbXSA9IFtdO1xyXG5cclxuICAgIGZvciAoY29uc3QgaXRlbSBvZiByaWNoVGV4dCkge1xyXG4gICAgICBjb25zdCBjb250ZW50ID0gaXRlbS50eXBlID09PSAndGV4dCdcclxuICAgICAgICA/IGl0ZW0udGV4dD8uY29udGVudCB8fCAnJ1xyXG4gICAgICAgIDogaXRlbS50eXBlID09PSAnZXF1YXRpb24nXHJcbiAgICAgICAgICA/IGl0ZW0uZXF1YXRpb24/LmV4cHJlc3Npb24gfHwgJydcclxuICAgICAgICAgIDogJyc7XHJcblxyXG4gICAgICBpZiAoY3VycmVudExlbmd0aCArIGNvbnRlbnQubGVuZ3RoIDw9IG1heExlbmd0aCkge1xyXG4gICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pO1xyXG4gICAgICAgIGN1cnJlbnRMZW5ndGggKz0gY29udGVudC5sZW5ndGg7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgcmVtYWluaW5nTGVuZ3RoID0gbWF4TGVuZ3RoIC0gY3VycmVudExlbmd0aDtcclxuICAgICAgICBpZiAocmVtYWluaW5nTGVuZ3RoID4gMTApIHtcclxuICAgICAgICAgIGNvbnN0IHRydW5jYXRlZENvbnRlbnQgPSBjb250ZW50LnN1YnN0cmluZygwLCByZW1haW5pbmdMZW5ndGggLSAxMCkgKyAnLi4uJztcclxuXHJcbiAgICAgICAgICBpZiAoaXRlbS50eXBlID09PSAndGV4dCcpIHtcclxuICAgICAgICAgICAgcmVzdWx0LnB1c2goe1xyXG4gICAgICAgICAgICAgIC4uLml0ZW0sXHJcbiAgICAgICAgICAgICAgdGV4dDoge1xyXG4gICAgICAgICAgICAgICAgLi4uaXRlbS50ZXh0LFxyXG4gICAgICAgICAgICAgICAgY29udGVudDogdHJ1bmNhdGVkQ29udGVudFxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0udHlwZSA9PT0gJ2VxdWF0aW9uJykge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh7XHJcbiAgICAgICAgICAgICAgdHlwZTogJ3RleHQnLFxyXG4gICAgICAgICAgICAgIHRleHQ6IHsgY29udGVudDogdHJ1bmNhdGVkQ29udGVudCB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG59Il0sInZlcnNpb24iOjN9