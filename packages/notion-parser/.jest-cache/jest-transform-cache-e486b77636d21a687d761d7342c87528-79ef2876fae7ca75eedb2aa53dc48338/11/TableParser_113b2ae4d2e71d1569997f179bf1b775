71e0bf979028b0e1541d7b14578fc780
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TableParser = void 0;
const BaseParser_1 = require("./BaseParser");
class TableParser extends BaseParser_1.BaseParser {
    constructor(options = {}) {
        super(options);
    }
    parse(content) {
        if (!content?.trim())
            return [];
        const contentType = this.options.contentType;
        switch (contentType) {
            case 'csv':
                return this.parseCsv(content);
            case 'tsv':
                return this.parseTsv(content);
            case 'table':
            default:
                return this.parseMarkdownTable(content);
        }
    }
    parseCsv(content) {
        return this.parseDelimitedTable(content, ',');
    }
    parseTsv(content) {
        return this.parseDelimitedTable(content, '\t');
    }
    parseDelimitedTable(content, delimiter) {
        const lines = content.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            // Not enough data for a table, return as text
            return [this.createTextNode(content)];
        }
        // Parse CSV/TSV with proper quote handling
        const rows = lines.map(line => this.parseDelimitedLine(line, delimiter));
        // Detect headers
        const hasColumnHeader = this.detectColumnHeaders(rows);
        const hasRowHeader = this.detectRowHeaders(rows);
        // Use first row as headers if detected
        const headers = hasColumnHeader ? rows[0] : [];
        const dataRows = hasColumnHeader ? rows.slice(1) : rows;
        // Normalize row lengths
        const maxColumns = Math.max(headers.length, ...dataRows.map(row => row.length));
        const normalizedHeaders = hasColumnHeader ? this.normalizeRow(headers, maxColumns) : [];
        const normalizedRows = dataRows.map(row => this.normalizeRow(row, maxColumns));
        return [this.createTableNode(normalizedHeaders, normalizedRows, {
                hasColumnHeader,
                hasRowHeader
            })];
    }
    parseDelimitedLine(line, delimiter) {
        const result = [];
        let current = '';
        let inQuotes = false;
        let i = 0;
        while (i < line.length) {
            const char = line[i];
            const nextChar = line[i + 1];
            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    // Escaped quote
                    current += '"';
                    i += 2;
                }
                else {
                    // Toggle quote state
                    inQuotes = !inQuotes;
                    i++;
                }
            }
            else if (char === delimiter && !inQuotes) {
                // Field separator
                result.push(current.trim());
                current = '';
                i++;
            }
            else {
                current += char;
                i++;
            }
        }
        // Add the last field
        result.push(current.trim());
        return result;
    }
    parseMarkdownTable(content) {
        const lines = content.split('\n').filter(line => line.trim());
        // Find table lines (containing |)
        const tableLines = lines.filter(line => line.includes('|'));
        if (tableLines.length < 2) {
            return [this.createTextNode(content)];
        }
        // Parse headers
        const headerLine = tableLines[0];
        const headers = this.parseMarkdownTableRow(headerLine);
        // Check for separator line (indicates headers)
        let dataStartIndex = 1;
        let hasColumnHeader = false;
        if (tableLines.length > 1 && this.isMarkdownSeparatorLine(tableLines[1])) {
            dataStartIndex = 2;
            hasColumnHeader = true;
        }
        // Parse data rows
        const dataRows = tableLines.slice(dataStartIndex)
            .map(line => this.parseMarkdownTableRow(line))
            .map(row => this.normalizeRow(row, headers.length));
        // Detect row headers
        const hasRowHeader = this.detectRowHeaders([headers, ...dataRows]);
        return [this.createTableNode(headers, dataRows, {
                hasColumnHeader,
                hasRowHeader
            })];
    }
    parseMarkdownTableRow(line) {
        // Remove leading/trailing pipes and split
        const trimmed = line.trim();
        const withoutOuterPipes = trimmed.startsWith('|') ? trimmed.slice(1) : trimmed;
        const withoutTrailingPipe = withoutOuterPipes.endsWith('|')
            ? withoutOuterPipes.slice(0, -1)
            : withoutOuterPipes;
        return withoutTrailingPipe
            .split('|')
            .map(cell => cell.trim())
            .filter((cell, index, array) => {
            // Remove empty cells at the beginning and end
            return !(cell === '' && (index === 0 || index === array.length - 1));
        });
    }
    isMarkdownSeparatorLine(line) {
        const trimmed = line.trim();
        // Check if line contains only |, -, :, and spaces
        return /^[\|\-:\s]+$/.test(trimmed) && trimmed.includes('-');
    }
    normalizeRow(row, targetLength) {
        const normalized = [...row];
        // Pad with empty strings if too short
        while (normalized.length < targetLength) {
            normalized.push('');
        }
        // Truncate if too long
        if (normalized.length > targetLength) {
            normalized.length = targetLength;
        }
        return normalized;
    }
    /**
     * Détecte si la première ligne contient des headers de colonnes
     */
    detectColumnHeaders(rows) {
        if (rows.length < 2)
            return false;
        const firstRow = rows[0];
        const secondRow = rows[1];
        // Heuristiques pour détecter les headers :
        // 1. Première ligne contient du texte, deuxième ligne contient des nombres
        const firstRowHasText = firstRow.some(cell => cell && isNaN(Number(cell)) && cell.trim() !== '');
        const secondRowHasNumbers = secondRow.some(cell => cell && !isNaN(Number(cell)));
        // 2. Première ligne a des cellules plus longues (noms descriptifs)
        const avgFirstRowLength = firstRow.reduce((sum, cell) => sum + cell.length, 0) / firstRow.length;
        const avgSecondRowLength = secondRow.reduce((sum, cell) => sum + cell.length, 0) / secondRow.length;
        // 3. Première ligne contient des mots typiques de headers
        const headerKeywords = ['name', 'id', 'date', 'title', 'type', 'status', 'value', 'count'];
        const hasHeaderKeywords = firstRow.some(cell => headerKeywords.some(keyword => cell.toLowerCase().includes(keyword)));
        return (firstRowHasText && secondRowHasNumbers) ||
            (avgFirstRowLength > avgSecondRowLength * 1.2) ||
            hasHeaderKeywords;
    }
    /**
     * Détecte si la première colonne contient des headers de lignes
     */
    detectRowHeaders(rows) {
        if (rows.length < 2 || rows[0].length < 2)
            return false;
        // Vérifier si la première colonne contient du texte descriptif
        // tandis que les autres colonnes contiennent principalement des données
        const firstColumn = rows.map(row => row[0]).filter(cell => cell && cell.trim());
        const otherColumns = rows.map(row => row.slice(1)).flat().filter(cell => cell && cell.trim());
        if (firstColumn.length === 0 || otherColumns.length === 0)
            return false;
        // Première colonne majoritairement textuelle
        const firstColumnTextRatio = firstColumn.filter(cell => isNaN(Number(cell))).length / firstColumn.length;
        // Autres colonnes majoritairement numériques
        const otherColumnsNumericRatio = otherColumns.filter(cell => !isNaN(Number(cell))).length / otherColumns.length;
        return firstColumnTextRatio > 0.7 && otherColumnsNumericRatio > 0.5;
    }
    /**
     * Crée un nœud table avec les métadonnées de headers
     */
    createTableNode(headers, rows, options = { hasColumnHeader: false, hasRowHeader: false }) {
        return {
            type: 'table',
            content: '',
            metadata: {
                headers,
                rows,
                columnCount: Math.max(headers.length, ...rows.map(row => row.length)),
                rowCount: rows.length + (options.hasColumnHeader ? 1 : 0),
                hasColumnHeader: options.hasColumnHeader,
                hasRowHeader: options.hasRowHeader
            },
            children: []
        };
    }
    /**
     * Detect table format from content
     */
    static detectTableFormat(content) {
        const lines = content.split('\n').filter(line => line.trim());
        if (lines.length < 2)
            return 'none';
        // Check for markdown table
        const pipeLines = lines.filter(line => line.includes('|')).length;
        if (pipeLines >= 2 && pipeLines / lines.length > 0.5) {
            return 'markdown';
        }
        // Check for TSV (tab-separated)
        const tabLines = lines.filter(line => line.includes('\t')).length;
        if (tabLines / lines.length > 0.7) {
            return 'tsv';
        }
        // Check for CSV (comma-separated)
        const commaLines = lines.filter(line => line.includes(',')).length;
        if (commaLines / lines.length > 0.7) {
            return 'csv';
        }
        return 'none';
    }
}
exports.TableParser = TableParser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxyYXlhblxcRGVza3RvcFxcRGV2XFxOb3Rpb25DbGlwcGVyXFxwYWNrYWdlc1xcbm90aW9uLXBhcnNlclxcc3JjXFxwYXJzZXJzXFxUYWJsZVBhcnNlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSw2Q0FBMEM7QUFHMUMsTUFBYSxXQUFZLFNBQVEsdUJBQVU7SUFDekMsWUFBWSxVQUF3QixFQUFFO1FBQ3BDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNqQixDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQWU7UUFDbkIsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUU7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUVoQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQztRQUU3QyxRQUFRLFdBQVcsRUFBRSxDQUFDO1lBQ3BCLEtBQUssS0FBSztnQkFDUixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDaEMsS0FBSyxLQUFLO2dCQUNSLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNoQyxLQUFLLE9BQU8sQ0FBQztZQUNiO2dCQUNFLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzVDLENBQUM7SUFDSCxDQUFDO0lBRU8sUUFBUSxDQUFDLE9BQWU7UUFDOUIsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFTyxRQUFRLENBQUMsT0FBZTtRQUM5QixPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVPLG1CQUFtQixDQUFDLE9BQWUsRUFBRSxTQUFpQjtRQUM1RCxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRTlELElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNyQiw4Q0FBOEM7WUFDOUMsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUN4QyxDQUFDO1FBRUQsMkNBQTJDO1FBQzNDLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFFekUsaUJBQWlCO1FBQ2pCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2RCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFakQsdUNBQXVDO1FBQ3ZDLE1BQU0sT0FBTyxHQUFHLGVBQWUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDL0MsTUFBTSxRQUFRLEdBQUcsZUFBZSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFFeEQsd0JBQXdCO1FBQ3hCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQ3pCLE9BQU8sQ0FBQyxNQUFNLEVBQ2QsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUNuQyxDQUFDO1FBRUYsTUFBTSxpQkFBaUIsR0FBRyxlQUFlLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDeEYsTUFBTSxjQUFjLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFFL0UsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLEVBQUUsY0FBYyxFQUFFO2dCQUM5RCxlQUFlO2dCQUNmLFlBQVk7YUFDYixDQUFDLENBQUMsQ0FBQztJQUNOLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxJQUFZLEVBQUUsU0FBaUI7UUFDeEQsTUFBTSxNQUFNLEdBQWEsRUFBRSxDQUFDO1FBQzVCLElBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNqQixJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUM7UUFDckIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRVYsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBRTdCLElBQUksSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDO2dCQUNqQixJQUFJLFFBQVEsSUFBSSxRQUFRLEtBQUssR0FBRyxFQUFFLENBQUM7b0JBQ2pDLGdCQUFnQjtvQkFDaEIsT0FBTyxJQUFJLEdBQUcsQ0FBQztvQkFDZixDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNULENBQUM7cUJBQU0sQ0FBQztvQkFDTixxQkFBcUI7b0JBQ3JCLFFBQVEsR0FBRyxDQUFDLFFBQVEsQ0FBQztvQkFDckIsQ0FBQyxFQUFFLENBQUM7Z0JBQ04sQ0FBQztZQUNILENBQUM7aUJBQU0sSUFBSSxJQUFJLEtBQUssU0FBUyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQzNDLGtCQUFrQjtnQkFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFDNUIsT0FBTyxHQUFHLEVBQUUsQ0FBQztnQkFDYixDQUFDLEVBQUUsQ0FBQztZQUNOLENBQUM7aUJBQU0sQ0FBQztnQkFDTixPQUFPLElBQUksSUFBSSxDQUFDO2dCQUNoQixDQUFDLEVBQUUsQ0FBQztZQUNOLENBQUM7UUFDSCxDQUFDO1FBRUQscUJBQXFCO1FBQ3JCLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFFNUIsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVPLGtCQUFrQixDQUFDLE9BQWU7UUFDeEMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUU5RCxrQ0FBa0M7UUFDbEMsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUU1RCxJQUFJLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDMUIsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUN4QyxDQUFDO1FBRUQsZ0JBQWdCO1FBQ2hCLE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFdkQsK0NBQStDO1FBQy9DLElBQUksY0FBYyxHQUFHLENBQUMsQ0FBQztRQUN2QixJQUFJLGVBQWUsR0FBRyxLQUFLLENBQUM7UUFFNUIsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsdUJBQXVCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUN6RSxjQUFjLEdBQUcsQ0FBQyxDQUFDO1lBQ25CLGVBQWUsR0FBRyxJQUFJLENBQUM7UUFDekIsQ0FBQztRQUVELGtCQUFrQjtRQUNsQixNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQzthQUM5QyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDN0MsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFFdEQscUJBQXFCO1FBQ3JCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFFbkUsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRTtnQkFDOUMsZUFBZTtnQkFDZixZQUFZO2FBQ2IsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDO0lBRU8scUJBQXFCLENBQUMsSUFBWTtRQUN4QywwQ0FBMEM7UUFDMUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzVCLE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQy9FLE1BQU0sbUJBQW1CLEdBQUcsaUJBQWlCLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQztZQUN6RCxDQUFDLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNoQyxDQUFDLENBQUMsaUJBQWlCLENBQUM7UUFFdEIsT0FBTyxtQkFBbUI7YUFDdkIsS0FBSyxDQUFDLEdBQUcsQ0FBQzthQUNWLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQzthQUN4QixNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQzdCLDhDQUE4QztZQUM5QyxPQUFPLENBQUMsQ0FBQyxJQUFJLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxLQUFLLENBQUMsSUFBSSxLQUFLLEtBQUssS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZFLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVPLHVCQUF1QixDQUFDLElBQVk7UUFDMUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzVCLGtEQUFrRDtRQUNsRCxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBRU8sWUFBWSxDQUFDLEdBQWEsRUFBRSxZQUFvQjtRQUN0RCxNQUFNLFVBQVUsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFFNUIsc0NBQXNDO1FBQ3RDLE9BQU8sVUFBVSxDQUFDLE1BQU0sR0FBRyxZQUFZLEVBQUUsQ0FBQztZQUN4QyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3RCLENBQUM7UUFFRCx1QkFBdUI7UUFDdkIsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLFlBQVksRUFBRSxDQUFDO1lBQ3JDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDO1FBQ25DLENBQUM7UUFFRCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxtQkFBbUIsQ0FBQyxJQUFnQjtRQUMxQyxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUFFLE9BQU8sS0FBSyxDQUFDO1FBRWxDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6QixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFMUIsMkNBQTJDO1FBQzNDLDJFQUEyRTtRQUMzRSxNQUFNLGVBQWUsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQzNDLElBQUksSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FDbEQsQ0FBQztRQUVGLE1BQU0sbUJBQW1CLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUNoRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQzdCLENBQUM7UUFFRixtRUFBbUU7UUFDbkUsTUFBTSxpQkFBaUIsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQztRQUNqRyxNQUFNLGtCQUFrQixHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDO1FBRXBHLDBEQUEwRDtRQUMxRCxNQUFNLGNBQWMsR0FBRyxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMzRixNQUFNLGlCQUFpQixHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FDN0MsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUM1QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUNyQyxDQUNGLENBQUM7UUFFRixPQUFPLENBQUMsZUFBZSxJQUFJLG1CQUFtQixDQUFDO1lBQ3hDLENBQUMsaUJBQWlCLEdBQUcsa0JBQWtCLEdBQUcsR0FBRyxDQUFDO1lBQzlDLGlCQUFpQixDQUFDO0lBQzNCLENBQUM7SUFFRDs7T0FFRztJQUNLLGdCQUFnQixDQUFDLElBQWdCO1FBQ3ZDLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFFeEQsK0RBQStEO1FBQy9ELHdFQUF3RTtRQUN4RSxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ2hGLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRTlGLElBQUksV0FBVyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFFeEUsNkNBQTZDO1FBQzdDLE1BQU0sb0JBQW9CLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDO1FBRXpHLDZDQUE2QztRQUM3QyxNQUFNLHdCQUF3QixHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDO1FBRWhILE9BQU8sb0JBQW9CLEdBQUcsR0FBRyxJQUFJLHdCQUF3QixHQUFHLEdBQUcsQ0FBQztJQUN0RSxDQUFDO0lBRUQ7O09BRUc7SUFDTyxlQUFlLENBQUMsT0FBaUIsRUFBRSxJQUFnQixFQUFFLFVBRzNELEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFO1FBQ2pELE9BQU87WUFDTCxJQUFJLEVBQUUsT0FBTztZQUNiLE9BQU8sRUFBRSxFQUFFO1lBQ1gsUUFBUSxFQUFFO2dCQUNSLE9BQU87Z0JBQ1AsSUFBSTtnQkFDSixXQUFXLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDckUsUUFBUSxFQUFFLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekQsZUFBZSxFQUFFLE9BQU8sQ0FBQyxlQUFlO2dCQUN4QyxZQUFZLEVBQUUsT0FBTyxDQUFDLFlBQVk7YUFDbkM7WUFDRCxRQUFRLEVBQUUsRUFBRTtTQUNiLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsaUJBQWlCLENBQUMsT0FBZTtRQUN0QyxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRTlELElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQUUsT0FBTyxNQUFNLENBQUM7UUFFcEMsMkJBQTJCO1FBQzNCLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2xFLElBQUksU0FBUyxJQUFJLENBQUMsSUFBSSxTQUFTLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQztZQUNyRCxPQUFPLFVBQVUsQ0FBQztRQUNwQixDQUFDO1FBRUQsZ0NBQWdDO1FBQ2hDLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2xFLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDbEMsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsa0NBQWtDO1FBQ2xDLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ25FLElBQUksVUFBVSxHQUFHLEtBQUssQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDcEMsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztDQUNGO0FBNVJELGtDQTRSQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHJheWFuXFxEZXNrdG9wXFxEZXZcXE5vdGlvbkNsaXBwZXJcXHBhY2thZ2VzXFxub3Rpb24tcGFyc2VyXFxzcmNcXHBhcnNlcnNcXFRhYmxlUGFyc2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VQYXJzZXIgfSBmcm9tICcuL0Jhc2VQYXJzZXInO1xyXG5pbXBvcnQgdHlwZSB7IEFTVE5vZGUsIFBhcnNlT3B0aW9ucyB9IGZyb20gJy4uL3R5cGVzJztcclxuXHJcbmV4cG9ydCBjbGFzcyBUYWJsZVBhcnNlciBleHRlbmRzIEJhc2VQYXJzZXIge1xyXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFBhcnNlT3B0aW9ucyA9IHt9KSB7XHJcbiAgICBzdXBlcihvcHRpb25zKTtcclxuICB9XHJcblxyXG4gIHBhcnNlKGNvbnRlbnQ6IHN0cmluZyk6IEFTVE5vZGVbXSB7XHJcbiAgICBpZiAoIWNvbnRlbnQ/LnRyaW0oKSkgcmV0dXJuIFtdO1xyXG5cclxuICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gdGhpcy5vcHRpb25zLmNvbnRlbnRUeXBlO1xyXG4gICAgXHJcbiAgICBzd2l0Y2ggKGNvbnRlbnRUeXBlKSB7XHJcbiAgICAgIGNhc2UgJ2Nzdic6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VDc3YoY29udGVudCk7XHJcbiAgICAgIGNhc2UgJ3Rzdic6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VUc3YoY29udGVudCk7XHJcbiAgICAgIGNhc2UgJ3RhYmxlJzpcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICByZXR1cm4gdGhpcy5wYXJzZU1hcmtkb3duVGFibGUoY29udGVudCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlQ3N2KGNvbnRlbnQ6IHN0cmluZyk6IEFTVE5vZGVbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5wYXJzZURlbGltaXRlZFRhYmxlKGNvbnRlbnQsICcsJyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlVHN2KGNvbnRlbnQ6IHN0cmluZyk6IEFTVE5vZGVbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5wYXJzZURlbGltaXRlZFRhYmxlKGNvbnRlbnQsICdcXHQnKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcGFyc2VEZWxpbWl0ZWRUYWJsZShjb250ZW50OiBzdHJpbmcsIGRlbGltaXRlcjogc3RyaW5nKTogQVNUTm9kZVtdIHtcclxuICAgIGNvbnN0IGxpbmVzID0gY29udGVudC5zcGxpdCgnXFxuJykuZmlsdGVyKGxpbmUgPT4gbGluZS50cmltKCkpO1xyXG4gICAgXHJcbiAgICBpZiAobGluZXMubGVuZ3RoIDwgMikge1xyXG4gICAgICAvLyBOb3QgZW5vdWdoIGRhdGEgZm9yIGEgdGFibGUsIHJldHVybiBhcyB0ZXh0XHJcbiAgICAgIHJldHVybiBbdGhpcy5jcmVhdGVUZXh0Tm9kZShjb250ZW50KV07XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUGFyc2UgQ1NWL1RTViB3aXRoIHByb3BlciBxdW90ZSBoYW5kbGluZ1xyXG4gICAgY29uc3Qgcm93cyA9IGxpbmVzLm1hcChsaW5lID0+IHRoaXMucGFyc2VEZWxpbWl0ZWRMaW5lKGxpbmUsIGRlbGltaXRlcikpO1xyXG4gICAgXHJcbiAgICAvLyBEZXRlY3QgaGVhZGVyc1xyXG4gICAgY29uc3QgaGFzQ29sdW1uSGVhZGVyID0gdGhpcy5kZXRlY3RDb2x1bW5IZWFkZXJzKHJvd3MpO1xyXG4gICAgY29uc3QgaGFzUm93SGVhZGVyID0gdGhpcy5kZXRlY3RSb3dIZWFkZXJzKHJvd3MpO1xyXG4gICAgXHJcbiAgICAvLyBVc2UgZmlyc3Qgcm93IGFzIGhlYWRlcnMgaWYgZGV0ZWN0ZWRcclxuICAgIGNvbnN0IGhlYWRlcnMgPSBoYXNDb2x1bW5IZWFkZXIgPyByb3dzWzBdIDogW107XHJcbiAgICBjb25zdCBkYXRhUm93cyA9IGhhc0NvbHVtbkhlYWRlciA/IHJvd3Muc2xpY2UoMSkgOiByb3dzO1xyXG5cclxuICAgIC8vIE5vcm1hbGl6ZSByb3cgbGVuZ3Roc1xyXG4gICAgY29uc3QgbWF4Q29sdW1ucyA9IE1hdGgubWF4KFxyXG4gICAgICBoZWFkZXJzLmxlbmd0aCwgXHJcbiAgICAgIC4uLmRhdGFSb3dzLm1hcChyb3cgPT4gcm93Lmxlbmd0aClcclxuICAgICk7XHJcbiAgICBcclxuICAgIGNvbnN0IG5vcm1hbGl6ZWRIZWFkZXJzID0gaGFzQ29sdW1uSGVhZGVyID8gdGhpcy5ub3JtYWxpemVSb3coaGVhZGVycywgbWF4Q29sdW1ucykgOiBbXTtcclxuICAgIGNvbnN0IG5vcm1hbGl6ZWRSb3dzID0gZGF0YVJvd3MubWFwKHJvdyA9PiB0aGlzLm5vcm1hbGl6ZVJvdyhyb3csIG1heENvbHVtbnMpKTtcclxuXHJcbiAgICByZXR1cm4gW3RoaXMuY3JlYXRlVGFibGVOb2RlKG5vcm1hbGl6ZWRIZWFkZXJzLCBub3JtYWxpemVkUm93cywge1xyXG4gICAgICBoYXNDb2x1bW5IZWFkZXIsXHJcbiAgICAgIGhhc1Jvd0hlYWRlclxyXG4gICAgfSldO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwYXJzZURlbGltaXRlZExpbmUobGluZTogc3RyaW5nLCBkZWxpbWl0ZXI6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgIGNvbnN0IHJlc3VsdDogc3RyaW5nW10gPSBbXTtcclxuICAgIGxldCBjdXJyZW50ID0gJyc7XHJcbiAgICBsZXQgaW5RdW90ZXMgPSBmYWxzZTtcclxuICAgIGxldCBpID0gMDtcclxuXHJcbiAgICB3aGlsZSAoaSA8IGxpbmUubGVuZ3RoKSB7XHJcbiAgICAgIGNvbnN0IGNoYXIgPSBsaW5lW2ldO1xyXG4gICAgICBjb25zdCBuZXh0Q2hhciA9IGxpbmVbaSArIDFdO1xyXG5cclxuICAgICAgaWYgKGNoYXIgPT09ICdcIicpIHtcclxuICAgICAgICBpZiAoaW5RdW90ZXMgJiYgbmV4dENoYXIgPT09ICdcIicpIHtcclxuICAgICAgICAgIC8vIEVzY2FwZWQgcXVvdGVcclxuICAgICAgICAgIGN1cnJlbnQgKz0gJ1wiJztcclxuICAgICAgICAgIGkgKz0gMjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8gVG9nZ2xlIHF1b3RlIHN0YXRlXHJcbiAgICAgICAgICBpblF1b3RlcyA9ICFpblF1b3RlcztcclxuICAgICAgICAgIGkrKztcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gZGVsaW1pdGVyICYmICFpblF1b3Rlcykge1xyXG4gICAgICAgIC8vIEZpZWxkIHNlcGFyYXRvclxyXG4gICAgICAgIHJlc3VsdC5wdXNoKGN1cnJlbnQudHJpbSgpKTtcclxuICAgICAgICBjdXJyZW50ID0gJyc7XHJcbiAgICAgICAgaSsrO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGN1cnJlbnQgKz0gY2hhcjtcclxuICAgICAgICBpKys7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBBZGQgdGhlIGxhc3QgZmllbGRcclxuICAgIHJlc3VsdC5wdXNoKGN1cnJlbnQudHJpbSgpKTtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwYXJzZU1hcmtkb3duVGFibGUoY29udGVudDogc3RyaW5nKTogQVNUTm9kZVtdIHtcclxuICAgIGNvbnN0IGxpbmVzID0gY29udGVudC5zcGxpdCgnXFxuJykuZmlsdGVyKGxpbmUgPT4gbGluZS50cmltKCkpO1xyXG4gICAgXHJcbiAgICAvLyBGaW5kIHRhYmxlIGxpbmVzIChjb250YWluaW5nIHwpXHJcbiAgICBjb25zdCB0YWJsZUxpbmVzID0gbGluZXMuZmlsdGVyKGxpbmUgPT4gbGluZS5pbmNsdWRlcygnfCcpKTtcclxuICAgIFxyXG4gICAgaWYgKHRhYmxlTGluZXMubGVuZ3RoIDwgMikge1xyXG4gICAgICByZXR1cm4gW3RoaXMuY3JlYXRlVGV4dE5vZGUoY29udGVudCldO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFBhcnNlIGhlYWRlcnNcclxuICAgIGNvbnN0IGhlYWRlckxpbmUgPSB0YWJsZUxpbmVzWzBdO1xyXG4gICAgY29uc3QgaGVhZGVycyA9IHRoaXMucGFyc2VNYXJrZG93blRhYmxlUm93KGhlYWRlckxpbmUpO1xyXG5cclxuICAgIC8vIENoZWNrIGZvciBzZXBhcmF0b3IgbGluZSAoaW5kaWNhdGVzIGhlYWRlcnMpXHJcbiAgICBsZXQgZGF0YVN0YXJ0SW5kZXggPSAxO1xyXG4gICAgbGV0IGhhc0NvbHVtbkhlYWRlciA9IGZhbHNlO1xyXG4gICAgXHJcbiAgICBpZiAodGFibGVMaW5lcy5sZW5ndGggPiAxICYmIHRoaXMuaXNNYXJrZG93blNlcGFyYXRvckxpbmUodGFibGVMaW5lc1sxXSkpIHtcclxuICAgICAgZGF0YVN0YXJ0SW5kZXggPSAyO1xyXG4gICAgICBoYXNDb2x1bW5IZWFkZXIgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFBhcnNlIGRhdGEgcm93c1xyXG4gICAgY29uc3QgZGF0YVJvd3MgPSB0YWJsZUxpbmVzLnNsaWNlKGRhdGFTdGFydEluZGV4KVxyXG4gICAgICAubWFwKGxpbmUgPT4gdGhpcy5wYXJzZU1hcmtkb3duVGFibGVSb3cobGluZSkpXHJcbiAgICAgIC5tYXAocm93ID0+IHRoaXMubm9ybWFsaXplUm93KHJvdywgaGVhZGVycy5sZW5ndGgpKTtcclxuXHJcbiAgICAvLyBEZXRlY3Qgcm93IGhlYWRlcnNcclxuICAgIGNvbnN0IGhhc1Jvd0hlYWRlciA9IHRoaXMuZGV0ZWN0Um93SGVhZGVycyhbaGVhZGVycywgLi4uZGF0YVJvd3NdKTtcclxuXHJcbiAgICByZXR1cm4gW3RoaXMuY3JlYXRlVGFibGVOb2RlKGhlYWRlcnMsIGRhdGFSb3dzLCB7XHJcbiAgICAgIGhhc0NvbHVtbkhlYWRlcixcclxuICAgICAgaGFzUm93SGVhZGVyXHJcbiAgICB9KV07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlTWFya2Rvd25UYWJsZVJvdyhsaW5lOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICAvLyBSZW1vdmUgbGVhZGluZy90cmFpbGluZyBwaXBlcyBhbmQgc3BsaXRcclxuICAgIGNvbnN0IHRyaW1tZWQgPSBsaW5lLnRyaW0oKTtcclxuICAgIGNvbnN0IHdpdGhvdXRPdXRlclBpcGVzID0gdHJpbW1lZC5zdGFydHNXaXRoKCd8JykgPyB0cmltbWVkLnNsaWNlKDEpIDogdHJpbW1lZDtcclxuICAgIGNvbnN0IHdpdGhvdXRUcmFpbGluZ1BpcGUgPSB3aXRob3V0T3V0ZXJQaXBlcy5lbmRzV2l0aCgnfCcpIFxyXG4gICAgICA/IHdpdGhvdXRPdXRlclBpcGVzLnNsaWNlKDAsIC0xKSBcclxuICAgICAgOiB3aXRob3V0T3V0ZXJQaXBlcztcclxuXHJcbiAgICByZXR1cm4gd2l0aG91dFRyYWlsaW5nUGlwZVxyXG4gICAgICAuc3BsaXQoJ3wnKVxyXG4gICAgICAubWFwKGNlbGwgPT4gY2VsbC50cmltKCkpXHJcbiAgICAgIC5maWx0ZXIoKGNlbGwsIGluZGV4LCBhcnJheSkgPT4ge1xyXG4gICAgICAgIC8vIFJlbW92ZSBlbXB0eSBjZWxscyBhdCB0aGUgYmVnaW5uaW5nIGFuZCBlbmRcclxuICAgICAgICByZXR1cm4gIShjZWxsID09PSAnJyAmJiAoaW5kZXggPT09IDAgfHwgaW5kZXggPT09IGFycmF5Lmxlbmd0aCAtIDEpKTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzTWFya2Rvd25TZXBhcmF0b3JMaW5lKGxpbmU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgdHJpbW1lZCA9IGxpbmUudHJpbSgpO1xyXG4gICAgLy8gQ2hlY2sgaWYgbGluZSBjb250YWlucyBvbmx5IHwsIC0sIDosIGFuZCBzcGFjZXNcclxuICAgIHJldHVybiAvXltcXHxcXC06XFxzXSskLy50ZXN0KHRyaW1tZWQpICYmIHRyaW1tZWQuaW5jbHVkZXMoJy0nKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbm9ybWFsaXplUm93KHJvdzogc3RyaW5nW10sIHRhcmdldExlbmd0aDogbnVtYmVyKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IFsuLi5yb3ddO1xyXG4gICAgXHJcbiAgICAvLyBQYWQgd2l0aCBlbXB0eSBzdHJpbmdzIGlmIHRvbyBzaG9ydFxyXG4gICAgd2hpbGUgKG5vcm1hbGl6ZWQubGVuZ3RoIDwgdGFyZ2V0TGVuZ3RoKSB7XHJcbiAgICAgIG5vcm1hbGl6ZWQucHVzaCgnJyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIFRydW5jYXRlIGlmIHRvbyBsb25nXHJcbiAgICBpZiAobm9ybWFsaXplZC5sZW5ndGggPiB0YXJnZXRMZW5ndGgpIHtcclxuICAgICAgbm9ybWFsaXplZC5sZW5ndGggPSB0YXJnZXRMZW5ndGg7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHJldHVybiBub3JtYWxpemVkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRMOpdGVjdGUgc2kgbGEgcHJlbWnDqHJlIGxpZ25lIGNvbnRpZW50IGRlcyBoZWFkZXJzIGRlIGNvbG9ubmVzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBkZXRlY3RDb2x1bW5IZWFkZXJzKHJvd3M6IHN0cmluZ1tdW10pOiBib29sZWFuIHtcclxuICAgIGlmIChyb3dzLmxlbmd0aCA8IDIpIHJldHVybiBmYWxzZTtcclxuICAgIFxyXG4gICAgY29uc3QgZmlyc3RSb3cgPSByb3dzWzBdO1xyXG4gICAgY29uc3Qgc2Vjb25kUm93ID0gcm93c1sxXTtcclxuICAgIFxyXG4gICAgLy8gSGV1cmlzdGlxdWVzIHBvdXIgZMOpdGVjdGVyIGxlcyBoZWFkZXJzIDpcclxuICAgIC8vIDEuIFByZW1pw6hyZSBsaWduZSBjb250aWVudCBkdSB0ZXh0ZSwgZGV1eGnDqG1lIGxpZ25lIGNvbnRpZW50IGRlcyBub21icmVzXHJcbiAgICBjb25zdCBmaXJzdFJvd0hhc1RleHQgPSBmaXJzdFJvdy5zb21lKGNlbGwgPT4gXHJcbiAgICAgIGNlbGwgJiYgaXNOYU4oTnVtYmVyKGNlbGwpKSAmJiBjZWxsLnRyaW0oKSAhPT0gJydcclxuICAgICk7XHJcbiAgICBcclxuICAgIGNvbnN0IHNlY29uZFJvd0hhc051bWJlcnMgPSBzZWNvbmRSb3cuc29tZShjZWxsID0+IFxyXG4gICAgICBjZWxsICYmICFpc05hTihOdW1iZXIoY2VsbCkpXHJcbiAgICApO1xyXG4gICAgXHJcbiAgICAvLyAyLiBQcmVtacOocmUgbGlnbmUgYSBkZXMgY2VsbHVsZXMgcGx1cyBsb25ndWVzIChub21zIGRlc2NyaXB0aWZzKVxyXG4gICAgY29uc3QgYXZnRmlyc3RSb3dMZW5ndGggPSBmaXJzdFJvdy5yZWR1Y2UoKHN1bSwgY2VsbCkgPT4gc3VtICsgY2VsbC5sZW5ndGgsIDApIC8gZmlyc3RSb3cubGVuZ3RoO1xyXG4gICAgY29uc3QgYXZnU2Vjb25kUm93TGVuZ3RoID0gc2Vjb25kUm93LnJlZHVjZSgoc3VtLCBjZWxsKSA9PiBzdW0gKyBjZWxsLmxlbmd0aCwgMCkgLyBzZWNvbmRSb3cubGVuZ3RoO1xyXG4gICAgXHJcbiAgICAvLyAzLiBQcmVtacOocmUgbGlnbmUgY29udGllbnQgZGVzIG1vdHMgdHlwaXF1ZXMgZGUgaGVhZGVyc1xyXG4gICAgY29uc3QgaGVhZGVyS2V5d29yZHMgPSBbJ25hbWUnLCAnaWQnLCAnZGF0ZScsICd0aXRsZScsICd0eXBlJywgJ3N0YXR1cycsICd2YWx1ZScsICdjb3VudCddO1xyXG4gICAgY29uc3QgaGFzSGVhZGVyS2V5d29yZHMgPSBmaXJzdFJvdy5zb21lKGNlbGwgPT4gXHJcbiAgICAgIGhlYWRlcktleXdvcmRzLnNvbWUoa2V5d29yZCA9PiBcclxuICAgICAgICBjZWxsLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoa2V5d29yZClcclxuICAgICAgKVxyXG4gICAgKTtcclxuICAgIFxyXG4gICAgcmV0dXJuIChmaXJzdFJvd0hhc1RleHQgJiYgc2Vjb25kUm93SGFzTnVtYmVycykgfHwgXHJcbiAgICAgICAgICAgKGF2Z0ZpcnN0Um93TGVuZ3RoID4gYXZnU2Vjb25kUm93TGVuZ3RoICogMS4yKSB8fFxyXG4gICAgICAgICAgIGhhc0hlYWRlcktleXdvcmRzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRMOpdGVjdGUgc2kgbGEgcHJlbWnDqHJlIGNvbG9ubmUgY29udGllbnQgZGVzIGhlYWRlcnMgZGUgbGlnbmVzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBkZXRlY3RSb3dIZWFkZXJzKHJvd3M6IHN0cmluZ1tdW10pOiBib29sZWFuIHtcclxuICAgIGlmIChyb3dzLmxlbmd0aCA8IDIgfHwgcm93c1swXS5sZW5ndGggPCAyKSByZXR1cm4gZmFsc2U7XHJcbiAgICBcclxuICAgIC8vIFbDqXJpZmllciBzaSBsYSBwcmVtacOocmUgY29sb25uZSBjb250aWVudCBkdSB0ZXh0ZSBkZXNjcmlwdGlmXHJcbiAgICAvLyB0YW5kaXMgcXVlIGxlcyBhdXRyZXMgY29sb25uZXMgY29udGllbm5lbnQgcHJpbmNpcGFsZW1lbnQgZGVzIGRvbm7DqWVzXHJcbiAgICBjb25zdCBmaXJzdENvbHVtbiA9IHJvd3MubWFwKHJvdyA9PiByb3dbMF0pLmZpbHRlcihjZWxsID0+IGNlbGwgJiYgY2VsbC50cmltKCkpO1xyXG4gICAgY29uc3Qgb3RoZXJDb2x1bW5zID0gcm93cy5tYXAocm93ID0+IHJvdy5zbGljZSgxKSkuZmxhdCgpLmZpbHRlcihjZWxsID0+IGNlbGwgJiYgY2VsbC50cmltKCkpO1xyXG4gICAgXHJcbiAgICBpZiAoZmlyc3RDb2x1bW4ubGVuZ3RoID09PSAwIHx8IG90aGVyQ29sdW1ucy5sZW5ndGggPT09IDApIHJldHVybiBmYWxzZTtcclxuICAgIFxyXG4gICAgLy8gUHJlbWnDqHJlIGNvbG9ubmUgbWFqb3JpdGFpcmVtZW50IHRleHR1ZWxsZVxyXG4gICAgY29uc3QgZmlyc3RDb2x1bW5UZXh0UmF0aW8gPSBmaXJzdENvbHVtbi5maWx0ZXIoY2VsbCA9PiBpc05hTihOdW1iZXIoY2VsbCkpKS5sZW5ndGggLyBmaXJzdENvbHVtbi5sZW5ndGg7XHJcbiAgICBcclxuICAgIC8vIEF1dHJlcyBjb2xvbm5lcyBtYWpvcml0YWlyZW1lbnQgbnVtw6lyaXF1ZXNcclxuICAgIGNvbnN0IG90aGVyQ29sdW1uc051bWVyaWNSYXRpbyA9IG90aGVyQ29sdW1ucy5maWx0ZXIoY2VsbCA9PiAhaXNOYU4oTnVtYmVyKGNlbGwpKSkubGVuZ3RoIC8gb3RoZXJDb2x1bW5zLmxlbmd0aDtcclxuICAgIFxyXG4gICAgcmV0dXJuIGZpcnN0Q29sdW1uVGV4dFJhdGlvID4gMC43ICYmIG90aGVyQ29sdW1uc051bWVyaWNSYXRpbyA+IDAuNTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyw6llIHVuIG7Fk3VkIHRhYmxlIGF2ZWMgbGVzIG3DqXRhZG9ubsOpZXMgZGUgaGVhZGVyc1xyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBjcmVhdGVUYWJsZU5vZGUoaGVhZGVyczogc3RyaW5nW10sIHJvd3M6IHN0cmluZ1tdW10sIG9wdGlvbnM6IHtcclxuICAgIGhhc0NvbHVtbkhlYWRlcjogYm9vbGVhbjtcclxuICAgIGhhc1Jvd0hlYWRlcjogYm9vbGVhbjtcclxuICB9ID0geyBoYXNDb2x1bW5IZWFkZXI6IGZhbHNlLCBoYXNSb3dIZWFkZXI6IGZhbHNlIH0pOiBBU1ROb2RlIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHR5cGU6ICd0YWJsZScsXHJcbiAgICAgIGNvbnRlbnQ6ICcnLFxyXG4gICAgICBtZXRhZGF0YToge1xyXG4gICAgICAgIGhlYWRlcnMsXHJcbiAgICAgICAgcm93cyxcclxuICAgICAgICBjb2x1bW5Db3VudDogTWF0aC5tYXgoaGVhZGVycy5sZW5ndGgsIC4uLnJvd3MubWFwKHJvdyA9PiByb3cubGVuZ3RoKSksXHJcbiAgICAgICAgcm93Q291bnQ6IHJvd3MubGVuZ3RoICsgKG9wdGlvbnMuaGFzQ29sdW1uSGVhZGVyID8gMSA6IDApLFxyXG4gICAgICAgIGhhc0NvbHVtbkhlYWRlcjogb3B0aW9ucy5oYXNDb2x1bW5IZWFkZXIsXHJcbiAgICAgICAgaGFzUm93SGVhZGVyOiBvcHRpb25zLmhhc1Jvd0hlYWRlclxyXG4gICAgICB9LFxyXG4gICAgICBjaGlsZHJlbjogW11cclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBEZXRlY3QgdGFibGUgZm9ybWF0IGZyb20gY29udGVudFxyXG4gICAqL1xyXG4gIHN0YXRpYyBkZXRlY3RUYWJsZUZvcm1hdChjb250ZW50OiBzdHJpbmcpOiAnY3N2JyB8ICd0c3YnIHwgJ21hcmtkb3duJyB8ICdub25lJyB7XHJcbiAgICBjb25zdCBsaW5lcyA9IGNvbnRlbnQuc3BsaXQoJ1xcbicpLmZpbHRlcihsaW5lID0+IGxpbmUudHJpbSgpKTtcclxuICAgIFxyXG4gICAgaWYgKGxpbmVzLmxlbmd0aCA8IDIpIHJldHVybiAnbm9uZSc7XHJcblxyXG4gICAgLy8gQ2hlY2sgZm9yIG1hcmtkb3duIHRhYmxlXHJcbiAgICBjb25zdCBwaXBlTGluZXMgPSBsaW5lcy5maWx0ZXIobGluZSA9PiBsaW5lLmluY2x1ZGVzKCd8JykpLmxlbmd0aDtcclxuICAgIGlmIChwaXBlTGluZXMgPj0gMiAmJiBwaXBlTGluZXMgLyBsaW5lcy5sZW5ndGggPiAwLjUpIHtcclxuICAgICAgcmV0dXJuICdtYXJrZG93bic7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ2hlY2sgZm9yIFRTViAodGFiLXNlcGFyYXRlZClcclxuICAgIGNvbnN0IHRhYkxpbmVzID0gbGluZXMuZmlsdGVyKGxpbmUgPT4gbGluZS5pbmNsdWRlcygnXFx0JykpLmxlbmd0aDtcclxuICAgIGlmICh0YWJMaW5lcyAvIGxpbmVzLmxlbmd0aCA+IDAuNykge1xyXG4gICAgICByZXR1cm4gJ3Rzdic7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ2hlY2sgZm9yIENTViAoY29tbWEtc2VwYXJhdGVkKVxyXG4gICAgY29uc3QgY29tbWFMaW5lcyA9IGxpbmVzLmZpbHRlcihsaW5lID0+IGxpbmUuaW5jbHVkZXMoJywnKSkubGVuZ3RoO1xyXG4gICAgaWYgKGNvbW1hTGluZXMgLyBsaW5lcy5sZW5ndGggPiAwLjcpIHtcclxuICAgICAgcmV0dXJuICdjc3YnO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiAnbm9uZSc7XHJcbiAgfVxyXG59Il0sInZlcnNpb24iOjN9