{"file":"C:\\Users\\rayan\\Desktop\\Dev\\NotionClipper\\packages\\notion-parser\\src\\utils\\FileUploadHandler.ts","mappings":"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","names":[],"sources":["C:\\Users\\rayan\\Desktop\\Dev\\NotionClipper\\packages\\notion-parser\\src\\utils\\FileUploadHandler.ts"],"sourcesContent":["import type { NotionBlock } from '../types';\r\nimport type { FileUploadOptions } from '../types/options';\r\n\r\nexport interface FileUploadResult {\r\n  success: boolean;\r\n  url?: string;\r\n  publicId?: string;\r\n  error?: string;\r\n  metadata?: {\r\n    originalName: string;\r\n    size: number;\r\n    type: string;\r\n    width?: number;\r\n    height?: number;\r\n    duration?: number;\r\n  };\r\n}\r\n\r\n/**\r\n * Gestionnaire d'upload de fichiers vers Notion API native\r\n */\r\nexport class FileUploadHandler {\r\n  private options: FileUploadOptions;\r\n\r\n  constructor(options: FileUploadOptions) {\r\n    this.options = {\r\n      maxFileSize: 20 * 1024 * 1024, // 20MB par défaut\r\n      retryAttempts: 3,\r\n      generateUniqueName: false,\r\n      ...options\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Upload un fichier vers Notion API native\r\n   */\r\n  async uploadFile(file: File | Blob, filename?: string): Promise<FileUploadResult> {\r\n    try {\r\n      // Validation du fichier\r\n      const validationResult = this.validateFile(file);\r\n      if (!validationResult.valid) {\r\n        return {\r\n          success: false,\r\n          error: validationResult.error\r\n        };\r\n      }\r\n\r\n      // Génération du nom unique si nécessaire\r\n      const finalFilename = this.options.generateUniqueName \r\n        ? this.generateUniqueName(filename || 'file')\r\n        : filename || 'file';\r\n\r\n      // Upload vers Notion API native uniquement\r\n      return await this.uploadToNotion(file, finalFilename);\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: `Erreur d'upload: ${error instanceof Error ? error.message : 'Erreur inconnue'}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Valide un fichier avant upload\r\n   */\r\n  private validateFile(file: File | Blob): { valid: boolean; error?: string } {\r\n    // Vérifier la taille\r\n    if (file.size > this.options.maxFileSize!) {\r\n      return {\r\n        valid: false,\r\n        error: `Fichier trop volumineux: ${(file.size / 1024 / 1024).toFixed(1)}MB > ${(this.options.maxFileSize! / 1024 / 1024).toFixed(1)}MB`\r\n      };\r\n    }\r\n\r\n    // Vérifier le type si spécifié\r\n    if (file instanceof File && this.options.allowedTypes) {\r\n      const isAllowed = this.options.allowedTypes.some((allowedType: string) => {\r\n        return file.type === allowedType || file.type.startsWith(allowedType.replace('*', ''));\r\n      });\r\n\r\n      if (!isAllowed) {\r\n        return {\r\n          valid: false,\r\n          error: `Type de fichier non autorisé: ${file.type}. Types autorisés: ${this.options.allowedTypes.join(', ')}`\r\n        };\r\n      }\r\n    }\r\n\r\n    return { valid: true };\r\n  }\r\n\r\n  /**\r\n   * Génère un nom de fichier unique\r\n   */\r\n  private generateUniqueName(originalName: string): string {\r\n    const timestamp = Date.now();\r\n    const random = Math.random().toString(36).substring(2, 8);\r\n    const extension = originalName.split('.').pop();\r\n    const baseName = originalName.replace(/\\.[^/.]+$/, '');\r\n    \r\n    return `${baseName}_${timestamp}_${random}.${extension}`;\r\n  }\r\n\r\n  /**\r\n   * Upload vers Notion API native\r\n   */\r\n  private async uploadToNotion(file: File | Blob, filename: string): Promise<FileUploadResult> {\r\n    if (!this.options.notionToken) {\r\n      return {\r\n        success: false,\r\n        error: 'Token Notion manquant'\r\n      };\r\n    }\r\n\r\n    try {\r\n      // Étape 1: Créer le FileUpload\r\n      const fileUpload = await this.createNotionFileUpload(file, filename);\r\n      \r\n      // Étape 2: Envoyer le fichier\r\n      await this.sendFileToNotion(fileUpload.id, file, filename);\r\n      \r\n      return {\r\n        success: true,\r\n        url: fileUpload.id, // Utiliser l'ID comme URL\r\n        publicId: fileUpload.id,\r\n        metadata: {\r\n          originalName: filename,\r\n          size: file.size,\r\n          type: file instanceof File ? file.type : 'application/octet-stream'\r\n        }\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: `Erreur upload Notion: ${error instanceof Error ? error.message : 'Erreur inconnue'}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Crée un FileUpload dans Notion\r\n   */\r\n  private async createNotionFileUpload(file: File | Blob, filename: string): Promise<any> {\r\n    const response = await fetch('https://api.notion.com/v1/file_uploads', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${this.options.notionToken}`,\r\n        'Notion-Version': '2025-09-03',\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        name: filename,\r\n        file_size: file.size,\r\n        mime_type: file instanceof File ? file.type : 'application/octet-stream'\r\n      })\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Erreur création FileUpload: ${response.status}`);\r\n    }\r\n\r\n    return await response.json();\r\n  }\r\n\r\n  /**\r\n   * Envoie le fichier vers Notion\r\n   */\r\n  private async sendFileToNotion(fileUploadId: string, file: File | Blob, filename: string): Promise<void> {\r\n    const formData = new FormData();\r\n    formData.append('file', file, filename);\r\n\r\n    const response = await fetch(`https://api.notion.com/v1/file_uploads/${fileUploadId}/send`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${this.options.notionToken}`,\r\n        'Notion-Version': '2025-09-03'\r\n      },\r\n      body: formData\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Erreur envoi fichier: ${response.status}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Crée un bloc Notion depuis un résultat d'upload\r\n   */\r\n  createNotionBlock(blockType: string, uploadResult: FileUploadResult): NotionBlock {\r\n    const baseBlock: any = {\r\n      object: 'block',\r\n      type: blockType\r\n    };\r\n\r\n    if (blockType === 'image') {\r\n      baseBlock.image = {\r\n        type: 'file_upload',\r\n        file_upload: {\r\n          id: uploadResult.publicId\r\n        },\r\n        caption: []\r\n      };\r\n    } else if (blockType === 'video') {\r\n      baseBlock.video = {\r\n        type: 'file_upload',\r\n        file_upload: {\r\n          id: uploadResult.publicId\r\n        },\r\n        caption: []\r\n      };\r\n    } else if (blockType === 'audio') {\r\n      baseBlock.audio = {\r\n        type: 'file_upload',\r\n        file_upload: {\r\n          id: uploadResult.publicId\r\n        },\r\n        caption: []\r\n      };\r\n    } else if (blockType === 'file') {\r\n      baseBlock.file = {\r\n        type: 'file_upload',\r\n        file_upload: {\r\n          id: uploadResult.publicId\r\n        },\r\n        caption: []\r\n      };\r\n    }\r\n\r\n    return baseBlock as NotionBlock;\r\n  }\r\n}\r\n\r\n/**\r\n * Upload un fichier et parse le résultat\r\n */\r\nexport async function uploadFileAndParse(\r\n  file: File | Blob,\r\n  options: {\r\n    upload: FileUploadOptions;\r\n    parse?: any;\r\n  }\r\n): Promise<{\r\n  uploadResult: FileUploadResult;\r\n  block?: NotionBlock;\r\n  errors?: Error[];\r\n}> {\r\n  try {\r\n    const uploader = new FileUploadHandler(options.upload);\r\n    \r\n    const uploadResult = await uploader.uploadFile(file);\r\n    \r\n    if (!uploadResult.success) {\r\n      return {\r\n        uploadResult,\r\n        errors: [new Error(uploadResult.error || 'Upload failed')]\r\n      };\r\n    }\r\n\r\n    // Déterminer le type de bloc\r\n    let blockType = 'file';\r\n    if (file instanceof File) {\r\n      if (file.type.startsWith('image/')) blockType = 'image';\r\n      else if (file.type.startsWith('video/')) blockType = 'video';\r\n      else if (file.type.startsWith('audio/')) blockType = 'audio';\r\n    }\r\n\r\n    const block = uploader.createNotionBlock(blockType, uploadResult);\r\n\r\n    return {\r\n      uploadResult,\r\n      block\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      uploadResult: { success: false, error: 'Upload failed' },\r\n      errors: [error as Error]\r\n    };\r\n  }\r\n}"],"version":3}