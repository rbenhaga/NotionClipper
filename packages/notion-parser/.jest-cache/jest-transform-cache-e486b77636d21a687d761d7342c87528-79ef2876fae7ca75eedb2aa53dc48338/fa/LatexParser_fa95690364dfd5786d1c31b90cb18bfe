5577e3567b532e8ef8ed0ca14826874e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LatexParser = void 0;
const BaseParser_1 = require("./BaseParser");
class LatexParser extends BaseParser_1.BaseParser {
    constructor(options = {}) {
        super(options);
        this.maxEquationLength = 1000;
    }
    parse(content) {
        if (!content?.trim())
            return [];
        const nodes = [];
        const lines = content.split('\n');
        let i = 0;
        while (i < lines.length) {
            const line = lines[i].trim();
            // Block equations ($$...$$)
            if (line.startsWith('$$')) {
                const { node, consumed } = this.parseBlockEquation(lines, i);
                if (node)
                    nodes.push(node);
                i += consumed;
                continue;
            }
            // LaTeX environments
            if (line.match(/\\begin\{(\w+)\}/)) {
                const { node, consumed } = this.parseLatexEnvironment(lines, i);
                if (node)
                    nodes.push(node);
                i += consumed;
                continue;
            }
            // Inline equations and text
            const lineNodes = this.parseLineWithInlineEquations(line);
            nodes.push(...lineNodes);
            i++;
        }
        return nodes.slice(0, this.options.maxBlocks || 100);
    }
    parseBlockEquation(lines, startIdx) {
        const startLine = lines[startIdx];
        let equationContent = '';
        let i = startIdx;
        // Handle single line $$equation$$
        if (startLine.startsWith('$$') && startLine.endsWith('$$') && startLine.length > 4) {
            equationContent = startLine.slice(2, -2).trim();
            return {
                node: this.createEquationNode(equationContent, true),
                consumed: 1
            };
        }
        // Handle multi-line $$...$$
        if (startLine === '$$') {
            i++;
            const equationLines = [];
            while (i < lines.length && lines[i].trim() !== '$$') {
                equationLines.push(lines[i]);
                i++;
            }
            if (i >= lines.length) {
                // No closing $$, treat as text
                return { node: this.createTextNode(lines[startIdx]), consumed: 1 };
            }
            equationContent = equationLines.join('\n').trim();
        }
        else {
            // Single line starting with $$
            equationContent = startLine.slice(2).trim();
        }
        if (!equationContent) {
            return { node: null, consumed: i - startIdx + 1 };
        }
        const truncatedExpression = this.truncateContent(equationContent, this.maxEquationLength);
        return {
            node: this.createEquationNode(truncatedExpression, true),
            consumed: i - startIdx + 1
        };
    }
    parseLatexEnvironment(lines, startIdx) {
        const startLine = lines[startIdx];
        const envMatch = startLine.match(/\\begin\{(\w+)\}/);
        if (!envMatch) {
            return { node: this.createTextNode(startLine), consumed: 1 };
        }
        const envName = envMatch[1];
        const envLines = [startLine];
        let i = startIdx + 1;
        // Find matching \end{environment}
        while (i < lines.length) {
            envLines.push(lines[i]);
            if (lines[i].includes(`\\end{${envName}}`)) {
                break;
            }
            i++;
        }
        if (i >= lines.length) {
            // No matching \end found
            return { node: this.createTextNode(startLine), consumed: 1 };
        }
        const content = envLines.join('\n');
        // Handle different LaTeX environments
        switch (envName) {
            case 'equation':
            case 'align':
            case 'gather':
            case 'multline':
            case 'eqnarray':
            case 'alignat':
                return {
                    node: this.createEquationNode(content, true),
                    consumed: i - startIdx + 1
                };
            case 'itemize':
            case 'enumerate':
                return {
                    node: this.parseLatexList(content, envName),
                    consumed: i - startIdx + 1
                };
            case 'tabular':
            case 'array':
            case 'matrix':
            case 'pmatrix':
            case 'bmatrix':
                return {
                    node: this.parseLatexTable(content),
                    consumed: i - startIdx + 1
                };
            case 'figure':
            case 'table':
                return {
                    node: this.parseLatexFloat(content, envName),
                    consumed: i - startIdx + 1
                };
            default:
                // Unknown environment, treat as code
                return {
                    node: this.createCodeNode(content, 'latex', true),
                    consumed: i - startIdx + 1
                };
        }
    }
    parseLineWithInlineEquations(line) {
        if (!line.includes('$')) {
            return line.trim() ? [this.createTextNode(line)] : [];
        }
        const nodes = [];
        const parts = this.splitInlineEquations(line);
        for (const part of parts) {
            if (part.isEquation) {
                const truncatedExpression = this.truncateContent(part.content, this.maxEquationLength);
                nodes.push(this.createEquationNode(truncatedExpression, false));
            }
            else if (part.content.trim()) {
                nodes.push(this.createTextNode(part.content));
            }
        }
        return nodes;
    }
    splitInlineEquations(line) {
        const parts = [];
        let current = '';
        let inEquation = false;
        let i = 0;
        while (i < line.length) {
            const char = line[i];
            const nextChar = line[i + 1];
            if (char === '$') {
                if (nextChar === '$') {
                    // Double $ - skip for now (should be handled as block)
                    current += '$$';
                    i += 2;
                }
                else {
                    // Single $ - inline equation delimiter
                    if (current) {
                        parts.push({ content: current, isEquation: inEquation });
                        current = '';
                    }
                    inEquation = !inEquation;
                    i++;
                }
            }
            else {
                current += char;
                i++;
            }
        }
        if (current) {
            parts.push({ content: current, isEquation: inEquation });
        }
        return parts;
    }
    parseLatexList(content, envType) {
        const items = [];
        // Extract content between \begin and \end
        const contentMatch = content.match(/\\begin\{\w+\}([\s\S]*?)\\end\{\w+\}/);
        const listContent = contentMatch ? contentMatch[1] : content;
        // Find all \item entries
        const itemMatches = listContent.match(/\\item\s*([^\n\\]*(?:\n(?!\\item)[^\n\\]*)*)/g);
        if (itemMatches) {
            for (const match of itemMatches) {
                const itemContent = match.replace(/\\item\s*/, '').trim();
                if (itemContent) {
                    items.push(this.createListItemNode(itemContent));
                }
            }
        }
        const listType = envType === 'enumerate' ? 'numbered' : 'bulleted';
        return this.createListNode(items, listType);
    }
    parseLatexTable(content) {
        // Extract content between \begin and \end
        const contentMatch = content.match(/\\begin\{\w+\}(?:\{[^}]*\})?([\s\S]*?)\\end\{\w+\}/);
        const tableContent = contentMatch ? contentMatch[1] : content;
        // Split by lines and filter out LaTeX commands
        const lines = tableContent.split('\n')
            .map(line => line.trim())
            .filter(line => line &&
            !line.startsWith('\\hline') &&
            !line.startsWith('\\cline') &&
            !line.startsWith('\\toprule') &&
            !line.startsWith('\\midrule') &&
            !line.startsWith('\\bottomrule'));
        if (lines.length === 0) {
            return this.createTextNode(content);
        }
        // Parse table rows (split by &, end with \\)
        const rows = lines.map(line => {
            const cleaned = line.replace(/\\\\/g, '').trim();
            return cleaned.split('&').map(cell => cell.trim());
        }).filter(row => row.length > 1);
        if (rows.length === 0) {
            return this.createTextNode(content);
        }
        // Use first row as headers
        const headers = rows[0];
        const dataRows = rows.slice(1);
        return this.createTableNode(headers, dataRows);
    }
    parseLatexFloat(content, _envType) {
        // Extract content between \begin and \end
        const contentMatch = content.match(/\\begin\{\w+\}([\s\S]*?)\\end\{\w+\}/);
        const floatContent = contentMatch ? contentMatch[1] : content;
        // Look for \caption
        const captionMatch = floatContent.match(/\\caption\{([^}]*)\}/);
        const caption = captionMatch ? captionMatch[1] : '';
        // Look for \includegraphics or \centering content
        const includeMatch = floatContent.match(/\\includegraphics(?:\[[^\]]*\])?\{([^}]*)\}/);
        if (includeMatch) {
            const imagePath = includeMatch[1];
            return this.createMediaNode('image', imagePath, caption);
        }
        // If no specific content found, treat as text block
        const cleanContent = floatContent
            .replace(/\\caption\{[^}]*\}/g, '')
            .replace(/\\centering/g, '')
            .replace(/\\label\{[^}]*\}/g, '')
            .trim();
        if (cleanContent) {
            return this.createTextNode(cleanContent + (caption ? `\n\n${caption}` : ''));
        }
        return this.createTextNode(caption || content);
    }
    /**
     * Validate LaTeX syntax (basic validation)
     */
    static validateLatex(content) {
        const errors = [];
        // Check for balanced braces
        let braceCount = 0;
        for (const char of content) {
            if (char === '{')
                braceCount++;
            if (char === '}')
                braceCount--;
            if (braceCount < 0) {
                errors.push('Unmatched closing brace');
                break;
            }
        }
        if (braceCount > 0) {
            errors.push('Unmatched opening brace');
        }
        // Check for balanced environments
        const beginMatches = content.match(/\\begin\{(\w+)\}/g) || [];
        const endMatches = content.match(/\\end\{(\w+)\}/g) || [];
        if (beginMatches.length !== endMatches.length) {
            errors.push('Unmatched LaTeX environments');
        }
        // Check for balanced equation delimiters
        const singleDollarCount = (content.match(/(?<!\$)\$(?!\$)/g) || []).length;
        if (singleDollarCount % 2 !== 0) {
            errors.push('Unmatched equation delimiters ($)');
        }
        return {
            isValid: errors.length === 0,
            errors
        };
    }
    /**
     * Extract all equations from LaTeX content
     */
    static extractEquations(content) {
        const equations = [];
        // Block equations $$...$$
        const blockMatches = content.match(/\$\$([\s\S]*?)\$\$/g);
        if (blockMatches) {
            equations.push(...blockMatches.map(match => match.slice(2, -2).trim()));
        }
        // Inline equations $...$
        const inlineMatches = content.match(/(?<!\$)\$([^$]+)\$(?!\$)/g);
        if (inlineMatches) {
            equations.push(...inlineMatches.map(match => match.slice(1, -1).trim()));
        }
        // Environment equations
        const envMatches = content.match(/\\begin\{(equation|align|gather|multline)\}([\s\S]*?)\\end\{\1\}/g);
        if (envMatches) {
            equations.push(...envMatches);
        }
        return equations;
    }
}
exports.LatexParser = LatexParser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxyYXlhblxcRGVza3RvcFxcRGV2XFxOb3Rpb25DbGlwcGVyXFxwYWNrYWdlc1xcbm90aW9uLXBhcnNlclxcc3JjXFxwYXJzZXJzXFxMYXRleFBhcnNlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSw2Q0FBMEM7QUFHMUMsTUFBYSxXQUFZLFNBQVEsdUJBQVU7SUFHekMsWUFBWSxVQUF3QixFQUFFO1FBQ3BDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUhBLHNCQUFpQixHQUFHLElBQUksQ0FBQztJQUkxQyxDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQWU7UUFDbkIsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUU7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUVoQyxNQUFNLEtBQUssR0FBYyxFQUFFLENBQUM7UUFDNUIsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFVixPQUFPLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDeEIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1lBRTdCLDRCQUE0QjtZQUM1QixJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztnQkFDMUIsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUM3RCxJQUFJLElBQUk7b0JBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDM0IsQ0FBQyxJQUFJLFFBQVEsQ0FBQztnQkFDZCxTQUFTO1lBQ1gsQ0FBQztZQUVELHFCQUFxQjtZQUNyQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsRUFBRSxDQUFDO2dCQUNuQyxNQUFNLEVBQUUsSUFB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dEcsSUFBSSxVQUFVLEVBQUUsQ0FBQztZQUNmLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsQ0FBQztRQUNoQyxDQUFDO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQUNGO0FBM1hELGtDQTJYQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHJheWFuXFxEZXNrdG9wXFxEZXZcXE5vdGlvbkNsaXBwZXJcXHBhY2thZ2VzXFxub3Rpb24tcGFyc2VyXFxzcmNcXHBhcnNlcnNcXExhdGV4UGFyc2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VQYXJzZXIgfSBmcm9tICcuL0Jhc2VQYXJzZXInO1xyXG5pbXBvcnQgdHlwZSB7IEFTVE5vZGUsIFBhcnNlT3B0aW9ucyB9IGZyb20gJy4uL3R5cGVzJztcclxuXHJcbmV4cG9ydCBjbGFzcyBMYXRleFBhcnNlciBleHRlbmRzIEJhc2VQYXJzZXIge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbWF4RXF1YXRpb25MZW5ndGggPSAxMDAwO1xyXG5cclxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBQYXJzZU9wdGlvbnMgPSB7fSkge1xyXG4gICAgc3VwZXIob3B0aW9ucyk7XHJcbiAgfVxyXG5cclxuICBwYXJzZShjb250ZW50OiBzdHJpbmcpOiBBU1ROb2RlW10ge1xyXG4gICAgaWYgKCFjb250ZW50Py50cmltKCkpIHJldHVybiBbXTtcclxuXHJcbiAgICBjb25zdCBub2RlczogQVNUTm9kZVtdID0gW107XHJcbiAgICBjb25zdCBsaW5lcyA9IGNvbnRlbnQuc3BsaXQoJ1xcbicpO1xyXG4gICAgbGV0IGkgPSAwO1xyXG5cclxuICAgIHdoaWxlIChpIDwgbGluZXMubGVuZ3RoKSB7XHJcbiAgICAgIGNvbnN0IGxpbmUgPSBsaW5lc1tpXS50cmltKCk7XHJcblxyXG4gICAgICAvLyBCbG9jayBlcXVhdGlvbnMgKCQkLi4uJCQpXHJcbiAgICAgIGlmIChsaW5lLnN0YXJ0c1dpdGgoJyQkJykpIHtcclxuICAgICAgICBjb25zdCB7IG5vZGUsIGNvbnN1bWVkIH0gPSB0aGlzLnBhcnNlQmxvY2tFcXVhdGlvbihsaW5lcywgaSk7XHJcbiAgICAgICAgaWYgKG5vZGUpIG5vZGVzLnB1c2gobm9kZSk7XHJcbiAgICAgICAgaSArPSBjb25zdW1lZDtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gTGFUZVggZW52aXJvbm1lbnRzXHJcbiAgICAgIGlmIChsaW5lLm1hdGNoKC9cXFxcYmVnaW5cXHsoXFx3KylcXH0vKSkge1xyXG4gICAgICAgIGNvbnN0IHsgbm9kZSwgY29uc3VtZWQgfSA9IHRoaXMucGFyc2VMYXRleEVudmlyb25tZW50KGxpbmVzLCBpKTtcclxuICAgICAgICBpZiAobm9kZSkgbm9kZXMucHVzaChub2RlKTtcclxuICAgICAgICBpICs9IGNvbnN1bWVkO1xyXG4gICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBJbmxpbmUgZXF1YXRpb25zIGFuZCB0ZXh0XHJcbiAgICAgIGNvbnN0IGxpbmVOb2RlcyA9IHRoaXMucGFyc2VMaW5lV2l0aElubGluZUVxdWF0aW9ucyhsaW5lKTtcclxuICAgICAgbm9kZXMucHVzaCguLi5saW5lTm9kZXMpO1xyXG5cclxuICAgICAgaSsrO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBub2Rlcy5zbGljZSgwLCB0aGlzLm9wdGlvbnMubWF4QmxvY2tzIHx8IDEwMCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlQmxvY2tFcXVhdGlvbihsaW5lczogc3RyaW5nW10sIHN0YXJ0SWR4OiBudW1iZXIpOiB7IG5vZGU6IEFTVE5vZGUgfCBudWxsOyBjb25zdW1lZDogbnVtYmVyIH0ge1xyXG4gICAgY29uc3Qgc3RhcnRMaW5lID0gbGluZXNbc3RhcnRJZHhdO1xyXG4gICAgbGV0IGVxdWF0aW9uQ29udGVudCA9ICcnO1xyXG4gICAgbGV0IGkgPSBzdGFydElkeDtcclxuXHJcbiAgICAvLyBIYW5kbGUgc2luZ2xlIGxpbmUgJCRlcXVhdGlvbiQkXHJcbiAgICBpZiAoc3RhcnRMaW5lLnN0YXJ0c1dpdGgoJyQkJykgJiYgc3RhcnRMaW5lLmVuZHNXaXRoKCckJCcpICYmIHN0YXJ0TGluZS5sZW5ndGggPiA0KSB7XHJcbiAgICAgIGVxdWF0aW9uQ29udGVudCA9IHN0YXJ0TGluZS5zbGljZSgyLCAtMikudHJpbSgpO1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIG5vZGU6IHRoaXMuY3JlYXRlRXF1YXRpb25Ob2RlKGVxdWF0aW9uQ29udGVudCwgdHJ1ZSksXHJcbiAgICAgICAgY29uc3VtZWQ6IDFcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBIYW5kbGUgbXVsdGktbGluZSAkJC4uLiQkXHJcbiAgICBpZiAoc3RhcnRMaW5lID09PSAnJCQnKSB7XHJcbiAgICAgIGkrKztcclxuICAgICAgY29uc3QgZXF1YXRpb25MaW5lczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgXHJcbiAgICAgIHdoaWxlIChpIDwgbGluZXMubGVuZ3RoICYmIGxpbmVzW2ldLnRyaW0oKSAhPT0gJyQkJykge1xyXG4gICAgICAgIGVxdWF0aW9uTGluZXMucHVzaChsaW5lc1tpXSk7XHJcbiAgICAgICAgaSsrO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoaSA+PSBsaW5lcy5sZW5ndGgpIHtcclxuICAgICAgICAvLyBObyBjbG9zaW5nICQkLCB0cmVhdCBhcyB0ZXh0XHJcbiAgICAgICAgcmV0dXJuIHsgbm9kZTogdGhpcy5jcmVhdGVUZXh0Tm9kZShsaW5lc1tzdGFydElkeF0pLCBjb25zdW1lZDogMSB9O1xyXG4gICAgICB9XHJcblxyXG4gICAgICBlcXVhdGlvbkNvbnRlbnQgPSBlcXVhdGlvbkxpbmVzLmpvaW4oJ1xcbicpLnRyaW0oKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIFNpbmdsZSBsaW5lIHN0YXJ0aW5nIHdpdGggJCRcclxuICAgICAgZXF1YXRpb25Db250ZW50ID0gc3RhcnRMaW5lLnNsaWNlKDIpLnRyaW0oKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWVxdWF0aW9uQ29udGVudCkge1xyXG4gICAgICByZXR1cm4geyBub2RlOiBudWxsLCBjb25zdW1lZDogaSAtIHN0YXJ0SWR4ICsgMSB9O1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRydW5jYXRlZEV4cHJlc3Npb24gPSB0aGlzLnRydW5jYXRlQ29udGVudChlcXVhdGlvbkNvbnRlbnQsIHRoaXMubWF4RXF1YXRpb25MZW5ndGgpO1xyXG4gICAgXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBub2RlOiB0aGlzLmNyZWF0ZUVxdWF0aW9uTm9kZSh0cnVuY2F0ZWRFeHByZXNzaW9uLCB0cnVlKSxcclxuICAgICAgY29uc3VtZWQ6IGkgLSBzdGFydElkeCArIDFcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlTGF0ZXhFbnZpcm9ubWVudChsaW5lczogc3RyaW5nW10sIHN0YXJ0SWR4OiBudW1iZXIpOiB7IG5vZGU6IEFTVE5vZGUgfCBudWxsOyBjb25zdW1lZDogbnVtYmVyIH0ge1xyXG4gICAgY29uc3Qgc3RhcnRMaW5lID0gbGluZXNbc3RhcnRJZHhdO1xyXG4gICAgY29uc3QgZW52TWF0Y2ggPSBzdGFydExpbmUubWF0Y2goL1xcXFxiZWdpblxceyhcXHcrKVxcfS8pO1xyXG4gICAgXHJcbiAgICBpZiAoIWVudk1hdGNoKSB7XHJcbiAgICAgIHJldHVybiB7IG5vZGU6IHRoaXMuY3JlYXRlVGV4dE5vZGUoc3RhcnRMaW5lKSwgY29uc3VtZWQ6IDEgfTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBlbnZOYW1lID0gZW52TWF0Y2hbMV07XHJcbiAgICBjb25zdCBlbnZMaW5lczogc3RyaW5nW10gPSBbc3RhcnRMaW5lXTtcclxuICAgIGxldCBpID0gc3RhcnRJZHggKyAxO1xyXG5cclxuICAgIC8vIEZpbmQgbWF0Y2hpbmcgXFxlbmR7ZW52aXJvbm1lbnR9XHJcbiAgICB3aGlsZSAoaSA8IGxpbmVzLmxlbmd0aCkge1xyXG4gICAgICBlbnZMaW5lcy5wdXNoKGxpbmVzW2ldKTtcclxuICAgICAgaWYgKGxpbmVzW2ldLmluY2x1ZGVzKGBcXFxcZW5keyR7ZW52TmFtZX19YCkpIHtcclxuICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgICBpKys7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGkgPj0gbGluZXMubGVuZ3RoKSB7XHJcbiAgICAgIC8vIE5vIG1hdGNoaW5nIFxcZW5kIGZvdW5kXHJcbiAgICAgIHJldHVybiB7IG5vZGU6IHRoaXMuY3JlYXRlVGV4dE5vZGUoc3RhcnRMaW5lKSwgY29uc3VtZWQ6IDEgfTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjb250ZW50ID0gZW52TGluZXMuam9pbignXFxuJyk7XHJcblxyXG4gICAgLy8gSGFuZGxlIGRpZmZlcmVudCBMYVRlWCBlbnZpcm9ubWVudHNcclxuICAgIHN3aXRjaCAoZW52TmFtZSkge1xyXG4gICAgICBjYXNlICdlcXVhdGlvbic6XHJcbiAgICAgIGNhc2UgJ2FsaWduJzpcclxuICAgICAgY2FzZSAnZ2F0aGVyJzpcclxuICAgICAgY2FzZSAnbXVsdGxpbmUnOlxyXG4gICAgICBjYXNlICdlcW5hcnJheSc6XHJcbiAgICAgIGNhc2UgJ2FsaWduYXQnOlxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBub2RlOiB0aGlzLmNyZWF0ZUVxdWF0aW9uTm9kZShjb250ZW50LCB0cnVlKSxcclxuICAgICAgICAgIGNvbnN1bWVkOiBpIC0gc3RhcnRJZHggKyAxXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgIGNhc2UgJ2l0ZW1pemUnOlxyXG4gICAgICBjYXNlICdlbnVtZXJhdGUnOlxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBub2RlOiB0aGlzLnBhcnNlTGF0ZXhMaXN0KGNvbnRlbnQsIGVudk5hbWUpLFxyXG4gICAgICAgICAgY29uc3VtZWQ6IGkgLSBzdGFydElkeCArIDFcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgY2FzZSAndGFidWxhcic6XHJcbiAgICAgIGNhc2UgJ2FycmF5JzpcclxuICAgICAgY2FzZSAnbWF0cml4JzpcclxuICAgICAgY2FzZSAncG1hdHJpeCc6XHJcbiAgICAgIGNhc2UgJ2JtYXRyaXgnOlxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBub2RlOiB0aGlzLnBhcnNlTGF0ZXhUYWJsZShjb250ZW50KSxcclxuICAgICAgICAgIGNvbnN1bWVkOiBpIC0gc3RhcnRJZHggKyAxXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgIGNhc2UgJ2ZpZ3VyZSc6XHJcbiAgICAgIGNhc2UgJ3RhYmxlJzpcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgbm9kZTogdGhpcy5wYXJzZUxhdGV4RmxvYXQoY29udGVudCwgZW52TmFtZSksXHJcbiAgICAgICAgICBjb25zdW1lZDogaSAtIHN0YXJ0SWR4ICsgMVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIC8vIFVua25vd24gZW52aXJvbm1lbnQsIHRyZWF0IGFzIGNvZGVcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgbm9kZTogdGhpcy5jcmVhdGVDb2RlTm9kZShjb250ZW50LCAnbGF0ZXgnLCB0cnVlKSxcclxuICAgICAgICAgIGNvbnN1bWVkOiBpIC0gc3RhcnRJZHggKyAxXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgcGFyc2VMaW5lV2l0aElubGluZUVxdWF0aW9ucyhsaW5lOiBzdHJpbmcpOiBBU1ROb2RlW10ge1xyXG4gICAgaWYgKCFsaW5lLmluY2x1ZGVzKCckJykpIHtcclxuICAgICAgcmV0dXJuIGxpbmUudHJpbSgpID8gW3RoaXMuY3JlYXRlVGV4dE5vZGUobGluZSldIDogW107XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgbm9kZXM6IEFTVE5vZGVbXSA9IFtdO1xyXG4gICAgY29uc3QgcGFydHMgPSB0aGlzLnNwbGl0SW5saW5lRXF1YXRpb25zKGxpbmUpO1xyXG5cclxuICAgIGZvciAoY29uc3QgcGFydCBvZiBwYXJ0cykge1xyXG4gICAgICBpZiAocGFydC5pc0VxdWF0aW9uKSB7XHJcbiAgICAgICAgY29uc3QgdHJ1bmNhdGVkRXhwcmVzc2lvbiA9IHRoaXMudHJ1bmNhdGVDb250ZW50KHBhcnQuY29udGVudCwgdGhpcy5tYXhFcXVhdGlvbkxlbmd0aCk7XHJcbiAgICAgICAgbm9kZXMucHVzaCh0aGlzLmNyZWF0ZUVxdWF0aW9uTm9kZSh0cnVuY2F0ZWRFeHByZXNzaW9uLCBmYWxzZSkpO1xyXG4gICAgICB9IGVsc2UgaWYgKHBhcnQuY29udGVudC50cmltKCkpIHtcclxuICAgICAgICBub2Rlcy5wdXNoKHRoaXMuY3JlYXRlVGV4dE5vZGUocGFydC5jb250ZW50KSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbm9kZXM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNwbGl0SW5saW5lRXF1YXRpb25zKGxpbmU6IHN0cmluZyk6IEFycmF5PHsgY29udGVudDogc3RyaW5nOyBpc0VxdWF0aW9uOiBib29sZWFuIH0+IHtcclxuICAgIGNvbnN0IHBhcnRzOiBBcnJheTx7IGNvbnRlbnQ6IHN0cmluZzsgaXNFcXVhdGlvbjogYm9vbGVhbiB9PiA9IFtdO1xyXG4gICAgbGV0IGN1cnJlbnQgPSAnJztcclxuICAgIGxldCBpbkVxdWF0aW9uID0gZmFsc2U7XHJcbiAgICBsZXQgaSA9IDA7XHJcblxyXG4gICAgd2hpbGUgKGkgPCBsaW5lLmxlbmd0aCkge1xyXG4gICAgICBjb25zdCBjaGFyID0gbGluZVtpXTtcclxuICAgICAgY29uc3QgbmV4dENoYXIgPSBsaW5lW2kgKyAxXTtcclxuXHJcbiAgICAgIGlmIChjaGFyID09PSAnJCcpIHtcclxuICAgICAgICBpZiAobmV4dENoYXIgPT09ICckJykge1xyXG4gICAgICAgICAgLy8gRG91YmxlICQgLSBza2lwIGZvciBub3cgKHNob3VsZCBiZSBoYW5kbGVkIGFzIGJsb2NrKVxyXG4gICAgICAgICAgY3VycmVudCArPSAnJCQnO1xyXG4gICAgICAgICAgaSArPSAyO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyBTaW5nbGUgJCAtIGlubGluZSBlcXVhdGlvbiBkZWxpbWl0ZXJcclxuICAgICAgICAgIGlmIChjdXJyZW50KSB7XHJcbiAgICAgICAgICAgIHBhcnRzLnB1c2goeyBjb250ZW50OiBjdXJyZW50LCBpc0VxdWF0aW9uOiBpbkVxdWF0aW9uIH0pO1xyXG4gICAgICAgICAgICBjdXJyZW50ID0gJyc7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpbkVxdWF0aW9uID0gIWluRXF1YXRpb247XHJcbiAgICAgICAgICBpKys7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGN1cnJlbnQgKz0gY2hhcjtcclxuICAgICAgICBpKys7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoY3VycmVudCkge1xyXG4gICAgICBwYXJ0cy5wdXNoKHsgY29udGVudDogY3VycmVudCwgaXNFcXVhdGlvbjogaW5FcXVhdGlvbiB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcGFydHM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlTGF0ZXhMaXN0KGNvbnRlbnQ6IHN0cmluZywgZW52VHlwZTogc3RyaW5nKTogQVNUTm9kZSB7XHJcbiAgICBjb25zdCBpdGVtczogQVNUTm9kZVtdID0gW107XHJcbiAgICBcclxuICAgIC8vIEV4dHJhY3QgY29udGVudCBiZXR3ZWVuIFxcYmVnaW4gYW5kIFxcZW5kXHJcbiAgICBjb25zdCBjb250ZW50TWF0Y2ggPSBjb250ZW50Lm1hdGNoKC9cXFxcYmVnaW5cXHtcXHcrXFx9KFtcXHNcXFNdKj8pXFxcXGVuZFxce1xcdytcXH0vKTtcclxuICAgIGNvbnN0IGxpc3RDb250ZW50ID0gY29udGVudE1hdGNoID8gY29udGVudE1hdGNoWzFdIDogY29udGVudDtcclxuICAgIFxyXG4gICAgLy8gRmluZCBhbGwgXFxpdGVtIGVudHJpZXNcclxuICAgIGNvbnN0IGl0ZW1NYXRjaGVzID0gbGlzdENvbnRlbnQubWF0Y2goL1xcXFxpdGVtXFxzKihbXlxcblxcXFxdKig/Olxcbig/IVxcXFxpdGVtKVteXFxuXFxcXF0qKSopL2cpO1xyXG5cclxuICAgIGlmIChpdGVtTWF0Y2hlcykge1xyXG4gICAgICBmb3IgKGNvbnN0IG1hdGNoIG9mIGl0ZW1NYXRjaGVzKSB7XHJcbiAgICAgICAgY29uc3QgaXRlbUNvbnRlbnQgPSBtYXRjaC5yZXBsYWNlKC9cXFxcaXRlbVxccyovLCAnJykudHJpbSgpO1xyXG4gICAgICAgIGlmIChpdGVtQ29udGVudCkge1xyXG4gICAgICAgICAgaXRlbXMucHVzaCh0aGlzLmNyZWF0ZUxpc3RJdGVtTm9kZShpdGVtQ29udGVudCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGxpc3RUeXBlID0gZW52VHlwZSA9PT0gJ2VudW1lcmF0ZScgPyAnbnVtYmVyZWQnIDogJ2J1bGxldGVkJztcclxuICAgIHJldHVybiB0aGlzLmNyZWF0ZUxpc3ROb2RlKGl0ZW1zLCBsaXN0VHlwZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlTGF0ZXhUYWJsZShjb250ZW50OiBzdHJpbmcpOiBBU1ROb2RlIHtcclxuICAgIC8vIEV4dHJhY3QgY29udGVudCBiZXR3ZWVuIFxcYmVnaW4gYW5kIFxcZW5kXHJcbiAgICBjb25zdCBjb250ZW50TWF0Y2ggPSBjb250ZW50Lm1hdGNoKC9cXFxcYmVnaW5cXHtcXHcrXFx9KD86XFx7W159XSpcXH0pPyhbXFxzXFxTXSo/KVxcXFxlbmRcXHtcXHcrXFx9Lyk7XHJcbiAgICBjb25zdCB0YWJsZUNvbnRlbnQgPSBjb250ZW50TWF0Y2ggPyBjb250ZW50TWF0Y2hbMV0gOiBjb250ZW50O1xyXG4gICAgXHJcbiAgICAvLyBTcGxpdCBieSBsaW5lcyBhbmQgZmlsdGVyIG91dCBMYVRlWCBjb21tYW5kc1xyXG4gICAgY29uc3QgbGluZXMgPSB0YWJsZUNvbnRlbnQuc3BsaXQoJ1xcbicpXHJcbiAgICAgIC5tYXAobGluZSA9PiBsaW5lLnRyaW0oKSlcclxuICAgICAgLmZpbHRlcihsaW5lID0+IFxyXG4gICAgICAgIGxpbmUgJiYgXHJcbiAgICAgICAgIWxpbmUuc3RhcnRzV2l0aCgnXFxcXGhsaW5lJykgJiYgXHJcbiAgICAgICAgIWxpbmUuc3RhcnRzV2l0aCgnXFxcXGNsaW5lJykgJiZcclxuICAgICAgICAhbGluZS5zdGFydHNXaXRoKCdcXFxcdG9wcnVsZScpICYmXHJcbiAgICAgICAgIWxpbmUuc3RhcnRzV2l0aCgnXFxcXG1pZHJ1bGUnKSAmJlxyXG4gICAgICAgICFsaW5lLnN0YXJ0c1dpdGgoJ1xcXFxib3R0b21ydWxlJylcclxuICAgICAgKTtcclxuXHJcbiAgICBpZiAobGluZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZVRleHROb2RlKGNvbnRlbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFBhcnNlIHRhYmxlIHJvd3MgKHNwbGl0IGJ5ICYsIGVuZCB3aXRoIFxcXFwpXHJcbiAgICBjb25zdCByb3dzID0gbGluZXMubWFwKGxpbmUgPT4ge1xyXG4gICAgICBjb25zdCBjbGVhbmVkID0gbGluZS5yZXBsYWNlKC9cXFxcXFxcXC9nLCAnJykudHJpbSgpO1xyXG4gICAgICByZXR1cm4gY2xlYW5lZC5zcGxpdCgnJicpLm1hcChjZWxsID0+IGNlbGwudHJpbSgpKTtcclxuICAgIH0pLmZpbHRlcihyb3cgPT4gcm93Lmxlbmd0aCA+IDEpO1xyXG5cclxuICAgIGlmIChyb3dzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5jcmVhdGVUZXh0Tm9kZShjb250ZW50KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBVc2UgZmlyc3Qgcm93IGFzIGhlYWRlcnNcclxuICAgIGNvbnN0IGhlYWRlcnMgPSByb3dzWzBdO1xyXG4gICAgY29uc3QgZGF0YVJvd3MgPSByb3dzLnNsaWNlKDEpO1xyXG5cclxuICAgIHJldHVybiB0aGlzLmNyZWF0ZVRhYmxlTm9kZShoZWFkZXJzLCBkYXRhUm93cyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlTGF0ZXhGbG9hdChjb250ZW50OiBzdHJpbmcsIF9lbnZUeXBlOiBzdHJpbmcpOiBBU1ROb2RlIHtcclxuICAgIC8vIEV4dHJhY3QgY29udGVudCBiZXR3ZWVuIFxcYmVnaW4gYW5kIFxcZW5kXHJcbiAgICBjb25zdCBjb250ZW50TWF0Y2ggPSBjb250ZW50Lm1hdGNoKC9cXFxcYmVnaW5cXHtcXHcrXFx9KFtcXHNcXFNdKj8pXFxcXGVuZFxce1xcdytcXH0vKTtcclxuICAgIGNvbnN0IGZsb2F0Q29udGVudCA9IGNvbnRlbnRNYXRjaCA/IGNvbnRlbnRNYXRjaFsxXSA6IGNvbnRlbnQ7XHJcbiAgICBcclxuICAgIC8vIExvb2sgZm9yIFxcY2FwdGlvblxyXG4gICAgY29uc3QgY2FwdGlvbk1hdGNoID0gZmxvYXRDb250ZW50Lm1hdGNoKC9cXFxcY2FwdGlvblxceyhbXn1dKilcXH0vKTtcclxuICAgIGNvbnN0IGNhcHRpb24gPSBjYXB0aW9uTWF0Y2ggPyBjYXB0aW9uTWF0Y2hbMV0gOiAnJztcclxuICAgIFxyXG4gICAgLy8gTG9vayBmb3IgXFxpbmNsdWRlZ3JhcGhpY3Mgb3IgXFxjZW50ZXJpbmcgY29udGVudFxyXG4gICAgY29uc3QgaW5jbHVkZU1hdGNoID0gZmxvYXRDb250ZW50Lm1hdGNoKC9cXFxcaW5jbHVkZWdyYXBoaWNzKD86XFxbW15cXF1dKlxcXSk/XFx7KFtefV0qKVxcfS8pO1xyXG4gICAgXHJcbiAgICBpZiAoaW5jbHVkZU1hdGNoKSB7XHJcbiAgICAgIGNvbnN0IGltYWdlUGF0aCA9IGluY2x1ZGVNYXRjaFsxXTtcclxuICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlTWVkaWFOb2RlKCdpbWFnZScsIGltYWdlUGF0aCwgY2FwdGlvbik7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIElmIG5vIHNwZWNpZmljIGNvbnRlbnQgZm91bmQsIHRyZWF0IGFzIHRleHQgYmxvY2tcclxuICAgIGNvbnN0IGNsZWFuQ29udGVudCA9IGZsb2F0Q29udGVudFxyXG4gICAgICAucmVwbGFjZSgvXFxcXGNhcHRpb25cXHtbXn1dKlxcfS9nLCAnJylcclxuICAgICAgLnJlcGxhY2UoL1xcXFxjZW50ZXJpbmcvZywgJycpXHJcbiAgICAgIC5yZXBsYWNlKC9cXFxcbGFiZWxcXHtbXn1dKlxcfS9nLCAnJylcclxuICAgICAgLnRyaW0oKTtcclxuICAgIFxyXG4gICAgaWYgKGNsZWFuQ29udGVudCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5jcmVhdGVUZXh0Tm9kZShjbGVhbkNvbnRlbnQgKyAoY2FwdGlvbiA/IGBcXG5cXG4ke2NhcHRpb259YCA6ICcnKSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHJldHVybiB0aGlzLmNyZWF0ZVRleHROb2RlKGNhcHRpb24gfHwgY29udGVudCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBWYWxpZGF0ZSBMYVRlWCBzeW50YXggKGJhc2ljIHZhbGlkYXRpb24pXHJcbiAgICovXHJcbiAgc3RhdGljIHZhbGlkYXRlTGF0ZXgoY29udGVudDogc3RyaW5nKTogeyBpc1ZhbGlkOiBib29sZWFuOyBlcnJvcnM6IHN0cmluZ1tdIH0ge1xyXG4gICAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIC8vIENoZWNrIGZvciBiYWxhbmNlZCBicmFjZXNcclxuICAgIGxldCBicmFjZUNvdW50ID0gMDtcclxuICAgIGZvciAoY29uc3QgY2hhciBvZiBjb250ZW50KSB7XHJcbiAgICAgIGlmIChjaGFyID09PSAneycpIGJyYWNlQ291bnQrKztcclxuICAgICAgaWYgKGNoYXIgPT09ICd9JykgYnJhY2VDb3VudC0tO1xyXG4gICAgICBpZiAoYnJhY2VDb3VudCA8IDApIHtcclxuICAgICAgICBlcnJvcnMucHVzaCgnVW5tYXRjaGVkIGNsb3NpbmcgYnJhY2UnKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKGJyYWNlQ291bnQgPiAwKSB7XHJcbiAgICAgIGVycm9ycy5wdXNoKCdVbm1hdGNoZWQgb3BlbmluZyBicmFjZScpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENoZWNrIGZvciBiYWxhbmNlZCBlbnZpcm9ubWVudHNcclxuICAgIGNvbnN0IGJlZ2luTWF0Y2hlcyA9IGNvbnRlbnQubWF0Y2goL1xcXFxiZWdpblxceyhcXHcrKVxcfS9nKSB8fCBbXTtcclxuICAgIGNvbnN0IGVuZE1hdGNoZXMgPSBjb250ZW50Lm1hdGNoKC9cXFxcZW5kXFx7KFxcdyspXFx9L2cpIHx8IFtdO1xyXG4gICAgXHJcbiAgICBpZiAoYmVnaW5NYXRjaGVzLmxlbmd0aCAhPT0gZW5kTWF0Y2hlcy5sZW5ndGgpIHtcclxuICAgICAgZXJyb3JzLnB1c2goJ1VubWF0Y2hlZCBMYVRlWCBlbnZpcm9ubWVudHMnKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBDaGVjayBmb3IgYmFsYW5jZWQgZXF1YXRpb24gZGVsaW1pdGVyc1xyXG4gICAgY29uc3Qgc2luZ2xlRG9sbGFyQ291bnQgPSAoY29udGVudC5tYXRjaCgvKD88IVxcJClcXCQoPyFcXCQpL2cpIHx8IFtdKS5sZW5ndGg7XHJcbiAgICBpZiAoc2luZ2xlRG9sbGFyQ291bnQgJSAyICE9PSAwKSB7XHJcbiAgICAgIGVycm9ycy5wdXNoKCdVbm1hdGNoZWQgZXF1YXRpb24gZGVsaW1pdGVycyAoJCknKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBpc1ZhbGlkOiBlcnJvcnMubGVuZ3RoID09PSAwLFxyXG4gICAgICBlcnJvcnNcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBFeHRyYWN0IGFsbCBlcXVhdGlvbnMgZnJvbSBMYVRlWCBjb250ZW50XHJcbiAgICovXHJcbiAgc3RhdGljIGV4dHJhY3RFcXVhdGlvbnMoY29udGVudDogc3RyaW5nKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgZXF1YXRpb25zOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgXHJcbiAgICAvLyBCbG9jayBlcXVhdGlvbnMgJCQuLi4kJFxyXG4gICAgY29uc3QgYmxvY2tNYXRjaGVzID0gY29udGVudC5tYXRjaCgvXFwkXFwkKFtcXHNcXFNdKj8pXFwkXFwkL2cpO1xyXG4gICAgaWYgKGJsb2NrTWF0Y2hlcykge1xyXG4gICAgICBlcXVhdGlvbnMucHVzaCguLi5ibG9ja01hdGNoZXMubWFwKG1hdGNoID0+IG1hdGNoLnNsaWNlKDIsIC0yKS50cmltKCkpKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gSW5saW5lIGVxdWF0aW9ucyAkLi4uJFxyXG4gICAgY29uc3QgaW5saW5lTWF0Y2hlcyA9IGNvbnRlbnQubWF0Y2goLyg/PCFcXCQpXFwkKFteJF0rKVxcJCg/IVxcJCkvZyk7XHJcbiAgICBpZiAoaW5saW5lTWF0Y2hlcykge1xyXG4gICAgICBlcXVhdGlvbnMucHVzaCguLi5pbmxpbmVNYXRjaGVzLm1hcChtYXRjaCA9PiBtYXRjaC5zbGljZSgxLCAtMSkudHJpbSgpKSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIEVudmlyb25tZW50IGVxdWF0aW9uc1xyXG4gICAgY29uc3QgZW52TWF0Y2hlcyA9IGNvbnRlbnQubWF0Y2goL1xcXFxiZWdpblxceyhlcXVhdGlvbnxhbGlnbnxnYXRoZXJ8bXVsdGxpbmUpXFx9KFtcXHNcXFNdKj8pXFxcXGVuZFxce1xcMVxcfS9nKTtcclxuICAgIGlmIChlbnZNYXRjaGVzKSB7XHJcbiAgICAgIGVxdWF0aW9ucy5wdXNoKC4uLmVudk1hdGNoZXMpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICByZXR1cm4gZXF1YXRpb25zO1xyXG4gIH1cclxufSJdLCJ2ZXJzaW9uIjozfQ==