9d4e4e0444198c04a0b4813363637fd0
"use strict";
/**
 * ContentSanitizer - Sécurité pour le Cahier des Charges v2.1
 * Sanitise le contenu malveillant (XSS, injection, etc.)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ContentSanitizer = void 0;
class ContentSanitizer {
    /**
     * Sanitise le contenu texte
     */
    static sanitizeText(text) {
        if (!text || typeof text !== 'string') {
            return '';
        }
        let sanitized = text;
        // Supprimer les balises dangereuses
        this.DANGEROUS_TAGS.forEach(tag => {
            const regex = new RegExp(tag, 'gi');
            sanitized = sanitized.replace(regex, '');
        });
        // Supprimer les attributs dangereux
        this.DANGEROUS_ATTRIBUTES.forEach(attr => {
            const regex = new RegExp(`${attr}\\s*=\\s*["'][^"']*["']`, 'gi');
            sanitized = sanitized.replace(regex, '');
        });
        // Supprimer les caractères de contrôle
        sanitized = sanitized.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, '');
        return sanitized;
    }
    /**
     * Sanitise une URL
     */
    static sanitizeUrl(url) {
        if (!url || typeof url !== 'string') {
            return '';
        }
        const lowerUrl = url.toLowerCase();
        // Bloquer les protocoles dangereux
        for (const protocol of this.DANGEROUS_PROTOCOLS) {
            if (lowerUrl.startsWith(protocol)) {
                return ''; // URL bloquée
            }
        }
        // Valider que c'est une URL HTTP/HTTPS valide
        try {
            const urlObj = new URL(url);
            if (urlObj.protocol !== 'http:' && urlObj.protocol !== 'https:') {
                return '';
            }
            return url;
        }
        catch {
            return ''; // URL invalide
        }
    }
    /**
     * Sanitise le contenu d'une cellule de table (protection CSV injection)
     */
    static sanitizeTableCell(cell) {
        if (!cell || typeof cell !== 'string') {
            return '';
        }
        let sanitized = this.sanitizeText(cell);
        // Supprimer les préfixes de formule dangereux
        if (this.FORMULA_PREFIXES.some(prefix => sanitized.startsWith(prefix))) {
            sanitized = sanitized.substring(1); // Supprimer le premier caractère
        }
        // Supprimer les commandes dangereuses
        const dangerousCommands = ['cmd', 'calc', 'HYPERLINK', 'SUM', 'EXEC'];
        dangerousCommands.forEach(cmd => {
            const regex = new RegExp(cmd, 'gi');
            sanitized = sanitized.replace(regex, '');
        });
        return sanitized;
    }
    /**
     * Sanitise le contenu complet (utilisé par les parsers)
     */
    static sanitizeContent(content) {
        if (!content || typeof content !== 'string') {
            return '';
        }
        let sanitized = content;
        // Sanitisation générale du texte
        sanitized = this.sanitizeText(sanitized);
        // Normalisation Unicode pour éviter les bypasses
        sanitized = sanitized.normalize('NFC');
        return sanitized;
    }
    /**
     * Vérifie si une URL est sûre
     */
    static isUrlSafe(url) {
        return this.sanitizeUrl(url) === url;
    }
    /**
     * Vérifie si le contenu contient des éléments dangereux
     */
    static containsDangerousContent(content) {
        if (!content || typeof content !== 'string') {
            return false;
        }
        const lowerContent = content.toLowerCase();
        // Vérifier les balises dangereuses
        if (this.DANGEROUS_TAGS.some(tag => lowerContent.includes(tag))) {
            return true;
        }
        // Vérifier les attributs dangereux
        if (this.DANGEROUS_ATTRIBUTES.some(attr => lowerContent.includes(attr))) {
            return true;
        }
        // Vérifier les protocoles dangereux
        if (this.DANGEROUS_PROTOCOLS.some(protocol => lowerContent.includes(protocol))) {
            return true;
        }
        return false;
    }
}
exports.ContentSanitizer = ContentSanitizer;
ContentSanitizer.DANGEROUS_PROTOCOLS = [
    'javascript:',
    'vbscript:',
    'data:text/html',
    'data:application/javascript'
];
ContentSanitizer.DANGEROUS_TAGS = [
    '<script',
    '</script>',
    '<iframe',
    '</iframe>',
    '<object',
    '</object>',
    '<embed',
    '</embed>'
];
ContentSanitizer.DANGEROUS_ATTRIBUTES = [
    'onclick',
    'onload',
    'onerror',
    'onmouseover',
    'onfocus',
    'onblur',
    'onchange',
    'onsubmit'
];
ContentSanitizer.FORMULA_PREFIXES = [
    '=',
    '+',
    '-',
    '@'
];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxyYXlhblxcRGVza3RvcFxcRGV2XFxOb3Rpb25DbGlwcGVyXFxwYWNrYWdlc1xcbm90aW9uLXBhcnNlclxcc3JjXFxzZWN1cml0eVxcQ29udGVudFNhbml0aXplci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUFFSCxNQUFhLGdCQUFnQjtJQXFDM0I7O09BRUc7SUFDSCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQVk7UUFDOUIsSUFBSSxDQUFDLElBQUksSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUN0QyxPQUFPLEVBQUUsQ0FBQztRQUNaLENBQUM7UUFFRCxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFFckIsb0NBQW9DO1FBQ3BDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2hDLE1BQU0sS0FBSyxHQUFHLElBQUksTUFBTSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNwQyxTQUFTLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDM0MsQ0FBQyxDQUFDLENBQUM7UUFFSCxvQ0FBb0M7UUFDcEMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN2QyxNQUFNLEtBQUssR0FBRyxJQUFJLE1BQU0sQ0FBQyxHQUFHLElBQUkseUJBQXlCLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDakUsU0FBUyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO1FBRUgsdUNBQXVDO1FBQ3ZDLFNBQVMsR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLCtCQUErQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRW5FLE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBVztRQUM1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O0lBQ0gsR0FBRztJQUNILEdBQUc7Q0FDSixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xccmF5YW5cXERlc2t0b3BcXERldlxcTm90aW9uQ2xpcHBlclxccGFja2FnZXNcXG5vdGlvbi1wYXJzZXJcXHNyY1xcc2VjdXJpdHlcXENvbnRlbnRTYW5pdGl6ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvbnRlbnRTYW5pdGl6ZXIgLSBTw6ljdXJpdMOpIHBvdXIgbGUgQ2FoaWVyIGRlcyBDaGFyZ2VzIHYyLjFcclxuICogU2FuaXRpc2UgbGUgY29udGVudSBtYWx2ZWlsbGFudCAoWFNTLCBpbmplY3Rpb24sIGV0Yy4pXHJcbiAqL1xyXG5cclxuZXhwb3J0IGNsYXNzIENvbnRlbnRTYW5pdGl6ZXIge1xyXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IERBTkdFUk9VU19QUk9UT0NPTFMgPSBbXHJcbiAgICAnamF2YXNjcmlwdDonLFxyXG4gICAgJ3Zic2NyaXB0OicsXHJcbiAgICAnZGF0YTp0ZXh0L2h0bWwnLFxyXG4gICAgJ2RhdGE6YXBwbGljYXRpb24vamF2YXNjcmlwdCdcclxuICBdO1xyXG5cclxuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBEQU5HRVJPVVNfVEFHUyA9IFtcclxuICAgICc8c2NyaXB0JyxcclxuICAgICc8L3NjcmlwdD4nLFxyXG4gICAgJzxpZnJhbWUnLFxyXG4gICAgJzwvaWZyYW1lPicsXHJcbiAgICAnPG9iamVjdCcsXHJcbiAgICAnPC9vYmplY3Q+JyxcclxuICAgICc8ZW1iZWQnLFxyXG4gICAgJzwvZW1iZWQ+J1xyXG4gIF07XHJcblxyXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IERBTkdFUk9VU19BVFRSSUJVVEVTID0gW1xyXG4gICAgJ29uY2xpY2snLFxyXG4gICAgJ29ubG9hZCcsXHJcbiAgICAnb25lcnJvcicsXHJcbiAgICAnb25tb3VzZW92ZXInLFxyXG4gICAgJ29uZm9jdXMnLFxyXG4gICAgJ29uYmx1cicsXHJcbiAgICAnb25jaGFuZ2UnLFxyXG4gICAgJ29uc3VibWl0J1xyXG4gIF07XHJcblxyXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IEZPUk1VTEFfUFJFRklYRVMgPSBbXHJcbiAgICAnPScsXHJcbiAgICAnKycsXHJcbiAgICAnLScsXHJcbiAgICAnQCdcclxuICBdO1xyXG5cclxuICAvKipcclxuICAgKiBTYW5pdGlzZSBsZSBjb250ZW51IHRleHRlXHJcbiAgICovXHJcbiAgc3RhdGljIHNhbml0aXplVGV4dCh0ZXh0OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKCF0ZXh0IHx8IHR5cGVvZiB0ZXh0ICE9PSAnc3RyaW5nJykge1xyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHNhbml0aXplZCA9IHRleHQ7XHJcblxyXG4gICAgLy8gU3VwcHJpbWVyIGxlcyBiYWxpc2VzIGRhbmdlcmV1c2VzXHJcbiAgICB0aGlzLkRBTkdFUk9VU19UQUdTLmZvckVhY2godGFnID0+IHtcclxuICAgICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHRhZywgJ2dpJyk7XHJcbiAgICAgIHNhbml0aXplZCA9IHNhbml0aXplZC5yZXBsYWNlKHJlZ2V4LCAnJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBTdXBwcmltZXIgbGVzIGF0dHJpYnV0cyBkYW5nZXJldXhcclxuICAgIHRoaXMuREFOR0VST1VTX0FUVFJJQlVURVMuZm9yRWFjaChhdHRyID0+IHtcclxuICAgICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGAke2F0dHJ9XFxcXHMqPVxcXFxzKltcIiddW15cIiddKltcIiddYCwgJ2dpJyk7XHJcbiAgICAgIHNhbml0aXplZCA9IHNhbml0aXplZC5yZXBsYWNlKHJlZ2V4LCAnJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBTdXBwcmltZXIgbGVzIGNhcmFjdMOocmVzIGRlIGNvbnRyw7RsZVxyXG4gICAgc2FuaXRpemVkID0gc2FuaXRpemVkLnJlcGxhY2UoL1tcXHgwMC1cXHgwOFxceDBCXFx4MENcXHgwRS1cXHgxRl0vZywgJycpO1xyXG5cclxuICAgIHJldHVybiBzYW5pdGl6ZWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTYW5pdGlzZSB1bmUgVVJMXHJcbiAgICovXHJcbiAgc3RhdGljIHNhbml0aXplVXJsKHVybDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGlmICghdXJsIHx8IHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBsb3dlclVybCA9IHVybC50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgIC8vIEJsb3F1ZXIgbGVzIHByb3RvY29sZXMgZGFuZ2VyZXV4XHJcbiAgICBmb3IgKGNvbnN0IHByb3RvY29sIG9mIHRoaXMuREFOR0VST1VTX1BST1RPQ09MUykge1xyXG4gICAgICBpZiAobG93ZXJVcmwuc3RhcnRzV2l0aChwcm90b2NvbCkpIHtcclxuICAgICAgICByZXR1cm4gJyc7IC8vIFVSTCBibG9xdcOpZVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVmFsaWRlciBxdWUgYydlc3QgdW5lIFVSTCBIVFRQL0hUVFBTIHZhbGlkZVxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgdXJsT2JqID0gbmV3IFVSTCh1cmwpO1xyXG4gICAgICBpZiAodXJsT2JqLnByb3RvY29sICE9PSAnaHR0cDonICYmIHVybE9iai5wcm90b2NvbCAhPT0gJ2h0dHBzOicpIHtcclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHVybDtcclxuICAgIH0gY2F0Y2gge1xyXG4gICAgICByZXR1cm4gJyc7IC8vIFVSTCBpbnZhbGlkZVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2FuaXRpc2UgbGUgY29udGVudSBkJ3VuZSBjZWxsdWxlIGRlIHRhYmxlIChwcm90ZWN0aW9uIENTViBpbmplY3Rpb24pXHJcbiAgICovXHJcbiAgc3RhdGljIHNhbml0aXplVGFibGVDZWxsKGNlbGw6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBpZiAoIWNlbGwgfHwgdHlwZW9mIGNlbGwgIT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBsZXQgc2FuaXRpemVkID0gdGhpcy5zYW5pdGl6ZVRleHQoY2VsbCk7XHJcblxyXG4gICAgLy8gU3VwcHJpbWVyIGxlcyBwcsOpZml4ZXMgZGUgZm9ybXVsZSBkYW5nZXJldXhcclxuICAgIGlmICh0aGlzLkZPUk1VTEFfUFJFRklYRVMuc29tZShwcmVmaXggPT4gc2FuaXRpemVkLnN0YXJ0c1dpdGgocHJlZml4KSkpIHtcclxuICAgICAgc2FuaXRpemVkID0gc2FuaXRpemVkLnN1YnN0cmluZygxKTsgLy8gU3VwcHJpbWVyIGxlIHByZW1pZXIgY2FyYWN0w6hyZVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFN1cHByaW1lciBsZXMgY29tbWFuZGVzIGRhbmdlcmV1c2VzXHJcbiAgICBjb25zdCBkYW5nZXJvdXNDb21tYW5kcyA9IFsnY21kJywgJ2NhbGMnLCAnSFlQRVJMSU5LJywgJ1NVTScsICdFWEVDJ107XHJcbiAgICBkYW5nZXJvdXNDb21tYW5kcy5mb3JFYWNoKGNtZCA9PiB7XHJcbiAgICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChjbWQsICdnaScpO1xyXG4gICAgICBzYW5pdGl6ZWQgPSBzYW5pdGl6ZWQucmVwbGFjZShyZWdleCwgJycpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHNhbml0aXplZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNhbml0aXNlIGxlIGNvbnRlbnUgY29tcGxldCAodXRpbGlzw6kgcGFyIGxlcyBwYXJzZXJzKVxyXG4gICAqL1xyXG4gIHN0YXRpYyBzYW5pdGl6ZUNvbnRlbnQoY29udGVudDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGlmICghY29udGVudCB8fCB0eXBlb2YgY29udGVudCAhPT0gJ3N0cmluZycpIHtcclxuICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBzYW5pdGl6ZWQgPSBjb250ZW50O1xyXG5cclxuICAgIC8vIFNhbml0aXNhdGlvbiBnw6luw6lyYWxlIGR1IHRleHRlXHJcbiAgICBzYW5pdGl6ZWQgPSB0aGlzLnNhbml0aXplVGV4dChzYW5pdGl6ZWQpO1xyXG5cclxuICAgIC8vIE5vcm1hbGlzYXRpb24gVW5pY29kZSBwb3VyIMOpdml0ZXIgbGVzIGJ5cGFzc2VzXHJcbiAgICBzYW5pdGl6ZWQgPSBzYW5pdGl6ZWQubm9ybWFsaXplKCdORkMnKTtcclxuXHJcbiAgICByZXR1cm4gc2FuaXRpemVkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVsOpcmlmaWUgc2kgdW5lIFVSTCBlc3Qgc8O7cmVcclxuICAgKi9cclxuICBzdGF0aWMgaXNVcmxTYWZlKHVybDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5zYW5pdGl6ZVVybCh1cmwpID09PSB1cmw7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBWw6lyaWZpZSBzaSBsZSBjb250ZW51IGNvbnRpZW50IGRlcyDDqWzDqW1lbnRzIGRhbmdlcmV1eFxyXG4gICAqL1xyXG4gIHN0YXRpYyBjb250YWluc0Rhbmdlcm91c0NvbnRlbnQoY29udGVudDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICBpZiAoIWNvbnRlbnQgfHwgdHlwZW9mIGNvbnRlbnQgIT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBsb3dlckNvbnRlbnQgPSBjb250ZW50LnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgLy8gVsOpcmlmaWVyIGxlcyBiYWxpc2VzIGRhbmdlcmV1c2VzXHJcbiAgICBpZiAodGhpcy5EQU5HRVJPVVNfVEFHUy5zb21lKHRhZyA9PiBsb3dlckNvbnRlbnQuaW5jbHVkZXModGFnKSkpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVsOpcmlmaWVyIGxlcyBhdHRyaWJ1dHMgZGFuZ2VyZXV4XHJcbiAgICBpZiAodGhpcy5EQU5HRVJPVVNfQVRUUklCVVRFUy5zb21lKGF0dHIgPT4gbG93ZXJDb250ZW50LmluY2x1ZGVzKGF0dHIpKSkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBWw6lyaWZpZXIgbGVzIHByb3RvY29sZXMgZGFuZ2VyZXV4XHJcbiAgICBpZiAodGhpcy5EQU5HRVJPVVNfUFJPVE9DT0xTLnNvbWUocHJvdG9jb2wgPT4gbG93ZXJDb250ZW50LmluY2x1ZGVzKHByb3RvY29sKSkpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxufSJdLCJ2ZXJzaW9uIjozfQ==